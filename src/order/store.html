<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <title>ë§¤ì¥ ì£¼ë¬¸</title>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <link rel="stylesheet" href="/src/order/assets/css/order-common.css"/>
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
<link rel="icon" href="/favicon.ico" type="image/x-icon">
  <style>
/* ë§¤ì¥ ì£¼ë¬¸ í˜ì´ì§€ë§Œì˜ íŠ¹ìˆ˜ ìŠ¤íƒ€ì¼ (í•„ìš” ì‹œ ì¶”ê°€) */
    .large-total { font-size: 1.2rem; color: var(--primary); font-weight: bold; }
    #confirm-items { 
        white-space: pre-wrap; font-size: 13px; background: #161b22; 
        padding: 10px; border-radius: 8px; margin: 10px 0; 
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body data-store-id="">
<div class="container">
  
  
<div class="hstack" style="justify-content: space-between; align-items: center; margin-bottom: 20px;">
  <h1 style="margin:0;">QR Order</h1>
  <button id="btn-show-history" class="btn small" style="background:#1c2632; border-color:#263241; height: 36px; padding: 0 12px; font-size: 12px;">
    ğŸ“œ ì£¼ë¬¸ ë‚´ì—­
  </button>
</div>
  
  <div class="card vstack">
    <div class="hstack" style="gap:12px;flex-wrap:wrap">
      <div class="vstack" style="min-width:220px;flex:1">
        <label class="small">í…Œì´ë¸”</label>
        <input id="tableNo" class="input" placeholder="ì˜ˆ: 12">
      </div>
      <div class="vstack" style="min-width:220px;flex:1">
        <label class="small">ì˜¤ëŠ˜ì˜ ê²°ì œ ì½”ë“œ</label>
        <input id="paycode" class="input" placeholder="ê´€ë¦¬ìì—ê²Œ ë°›ì€ 4ìë¦¬">
      </div>
    </div>
  </div>

  <div class="card vstack">
    <h3>ì§ì› í˜¸ì¶œ</h3>
    <div class="hstack" style="gap:8px;flex-wrap:wrap">
      <select id="call-reason" class="input" style="max-width:240px"></select>
      <button id="call-btn" class="btn">ì§ì› í˜¸ì¶œ</button>
    </div>
    <div id="call-msg" class="small" style="color:var(--primary); margin-top:8px"></div>
  </div>

  <div class="card vstack">
    <h3>ë©”ë‰´</h3>
    <div id="menu-grid"></div>
  </div>

  <div class="card vstack">
    <h3>ì¥ë°”êµ¬ë‹ˆ</h3>
    <div id="cart-box" class="vstack" style="gap:10px; margin: 10px 0;"></div>
  </div>

  <div class="card hstack" style="justify-content:space-between;align-items:center; margin-bottom:100px;">
    <div>í•©ê³„: <b id="total" style="color:var(--primary); font-size:1.2rem;">0</b>ì›</div>
    <button id="pay-btn" class="btn primary large">ì£¼ë¬¸í•˜ê¸°</button>
  </div>

  

<div id="history-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:5000; align-items:center; justify-content:center; padding:20px;">
    <div style="background:#0d1117; color:#fff; padding:20px; border-radius:16px; width:100%; max-width:420px; max-height:80vh; overflow-y:auto; border:1px solid #263241;">
        <h3 style="margin-bottom:15px; border-bottom:1px solid #263241; padding-bottom:10px;">ë‚´ ì£¼ë¬¸ ë‚´ì—­</h3>
        <div id="history-list" class="vstack" style="gap:12px;">
            </div>
        <button id="history-close" class="btn primary" style="width:100%; margin-top:20px;">ë‹«ê¸°</button>
    </div>
</div>

  <div class="small" style="color:#9ca3af;margin-top:6px; text-align:center;">
    ì£¼ë¬¸ ì ‘ìˆ˜ í›„ ì¹´ìš´í„°ì—ì„œ ê²°ì œë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.
  </div>
</div>

<div id="option-modal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
  <div class="content" style="background:#fff; padding:20px; border-radius:12px; width:90%; max-width:400px; color:#333;">
    <h3 id="opt-menu-name">ì˜µì…˜ ì„ íƒ</h3>
    <div id="opt-container" class="vstack" style="margin:15px 0"></div>
    <div class="hstack" style="gap:8px">
      <button id="opt-close" class="btn" style="flex:1">ì·¨ì†Œ</button>
      <button id="opt-add-cart" class="btn primary" style="flex:1">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
    </div>
  </div>
</div>

<div id="order-confirm-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:#0d1117; color:#fff; padding:20px; border-radius:16px; width:90%; max-width:420px;">
    <h3>ì£¼ë¬¸ í™•ì¸</h3>
    <pre id="confirm-items" style="white-space:pre-wrap;font-size:13px; background:#161b22; padding:10px; border-radius:8px; margin:10px 0;"></pre>
    <div style="margin-top:10px">í•©ê³„: <b id="confirm-total"></b>ì›</div>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button id="confirm-cancel" class="btn" style="flex:1">ì·¨ì†Œ</button>
      <button id="confirm-ok" class="btn primary" style="flex:1">í™•ì¸</button>
    </div>
  </div>
</div>

<div id="order-success-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:#0d1117; color:#fff; padding:24px; border-radius:16px; width:90%; max-width:360px; text-align:center;">
    <h3 style="margin-bottom:12px">ì£¼ë¬¸ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤</h3>
    <p style="font-size:14px;color:#9ca3af;line-height:1.5">ì¹´ìš´í„°ì—ì„œ ê²°ì œë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.</p>
    <button id="order-success-close" class="btn primary" style="margin-top:20px;width:100%">í™•ì¸</button>
  </div>
</div>

<script type="module">
  import { renderMenu, makeCart } from '/src/order/assets/js/modules/menu-cart.js';
  import { loadStoreInfo, currentStoreId } from '/src/order/assets/js/modules/cust-store.js';
  import { ensureStoreInitialized } from '/src/shared/store.js';
  import { supabaseMgr } from '/src/shared/supabase-manager.js';

  /* [ì¶”ê°€] ë³´ì•ˆì„ ìœ„í•œ íƒˆì¶œ í•¨ìˆ˜ */
  function esc(str) {
    if (!str) return "";
    return String(str).replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[m]));
  }
 
  /**
 * í‘œì¤€ í† ìŠ¤íŠ¸ ì•Œë¦¼ í•¨ìˆ˜
 * @param {string} msg - í‘œì‹œí•  ë©”ì‹œì§€
 * @param {string} variant - 'info', 'success', 'error' (ìƒ‰ìƒ êµ¬ë¶„ìš©)
 */
export function showToast(msg, variant = 'info') {
  const t = document.createElement('div');
  
  // ê¸°ë³¸ í´ë˜ìŠ¤ëŠ” toast, ìƒíƒœì— ë”°ë¼ í´ë˜ìŠ¤ ì¶”ê°€ (ì˜ˆ: toast-success)
  t.className = `toast toast-${variant}`; 
  t.textContent = msg;
  
  document.body.appendChild(t);

  // ë¸Œë¼ìš°ì €ê°€ ìš”ì†Œë¥¼ ì¸ì‹í•œ ì§í›„ì— 'show' í´ë˜ìŠ¤ ì¶”ê°€ (ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘)
  requestAnimationFrame(() => t.classList.add('show'));

  // 3ì´ˆ í›„ ì‚¬ë¼ì§
  setTimeout(() => {
    t.classList.remove('show');
    // ì• ë‹ˆë©”ì´ì…˜(0.2ì´ˆ)ì´ ëë‚œ í›„ ìš”ì†Œ ì‚­ì œ
    setTimeout(() => t.remove(), 200);
  }, 3000);
}
  // 1. ì§ì› í˜¸ì¶œ ì¿¨íƒ€ì„ ë¡œì§ (ì‚¬ì¥ë‹˜ ì›ë³¸ ìœ ì§€)
  const CALL_COOLDOWN_SEC = 10;
  const CALL_COOLDOWN_KEY = 'qrnr.call.cooldown';
  function getCallRemainSec() {
    const last = Number(localStorage.getItem(CALL_COOLDOWN_KEY) || 0);
    const diff = Math.floor((Date.now() - last) / 1000);
    return Math.max(0, CALL_COOLDOWN_SEC - diff);
  }
  function updateCallButtonState() {
    const btn = document.getElementById('call-btn');
    const msgEl = document.getElementById('call-msg');
    if (!btn) return;
    const remain = getCallRemainSec();
    if (remain > 0) {
      btn.disabled = true;
      btn.textContent = `ì§ì› í˜¸ì¶œ (${remain}s)`;
    } else {
      btn.disabled = false;
      btn.textContent = 'ì§ì› í˜¸ì¶œ';
    }
  }

  // 2. ì´ˆê¸°í™”
  const storeId = ensureStoreInitialized();
  window.qrnrStoreId = storeId;
  document.body.dataset.storeId = storeId;
  setInterval(updateCallButtonState, 1000);
  updateCallButtonState();

  // í…Œì´ë¸” ë²ˆí˜¸ ìë™ì…ë ¥
  const tableParam = new URLSearchParams(location.search).get('table') || '';
  if (tableParam) document.getElementById('tableNo').value = tableParam;

  // 3. ì¥ë°”êµ¬ë‹ˆ & ë©”ë‰´ ë Œë”ë§ (ì‚¬ì¥ë‹˜ JS í•¨ìˆ˜ í˜¸ì¶œ)
  const cart = makeCart('cart-box', 'total'); 
  cart.render();
  renderMenu('menu-grid', cart);

  // 4. ì§ì› í˜¸ì¶œ (ì‚¬ì¥ë‹˜ ì›ë³¸ ìœ ì§€)
  // ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸í•˜ì—¬ ì¤‘ë³µ ìƒì„±ì„ ë°©ì§€í•©ë‹ˆë‹¤.
  let globalSupabase = null;
  let globalChannel = null;
  
 
  
  document.getElementById('call-btn').onclick = async () => {
    const remain = getCallRemainSec();
    if (remain > 0) return showToast(`ì§ì› í˜¸ì¶œì€ ${remain}ì´ˆ í›„ì— ë‹¤ì‹œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`, 'info');
    
    const tableVal = document.getElementById('tableNo').value.trim();
    const note = document.getElementById('call-reason').value.trim();
    if (!tableVal) return showToast('í…Œì´ë¸” ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'info');

    try {
    // 1. DB ì €ì¥ (ê¸°ì¡´ ìœ ì§€)
    const r = await fetch('/api/call', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ storeId: window.qrnrStoreId, table: tableVal, note })
    });

    if (r.ok) {
                // 2. ë§¤ë‹ˆì €ë¥¼ í†µí•´ ì•ˆì „í•˜ê²Œ ì±„ë„ íšë“ ë° ì‹ í˜¸ ì „ì†¡
                const channel = await supabaseMgr.getChannel(window.qrnrStoreId);
                if (channel) {
                    await channel.send({
                        type: 'broadcast',
                        event: 'NEW_CALL',
                        payload: {
                            table_no: tableVal,
                            note: note,
                            at: new Date().toISOString()
                        }
                    });
                }

                localStorage.setItem(CALL_COOLDOWN_KEY, Date.now());
                const msgEl = document.getElementById('call-msg');
                if (msgEl) {
                    msgEl.textContent = 'ì§ì› í˜¸ì¶œì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    if (window.callMsgTimer) clearTimeout(window.callMsgTimer);
                    window.callMsgTimer = setTimeout(() => { msgEl.textContent = ''; }, 3000);
                }
                updateCallButtonState();
            }
        } catch (e) { console.error("í˜¸ì¶œ ì‹¤íŒ¨:", e); }
    };
  // í˜¸ì¶œ ì˜µì…˜ ë¡œë“œ (ì‚¬ì¥ë‹˜ ë¡œì§)
  (function loadOptions() {
    const select = document.getElementById('call-reason');
    const list = ['ë¬¼/ìˆ˜ì € ìš”ì²­', 'í…Œì´ë¸” ì •ë¦¬', 'ì£¼ë¬¸ ë¬¸ì˜', 'ì§ì› í˜¸ì¶œ'];
    select.innerHTML = list.map(opt => `<option value="${opt}">${opt}</option>`).join('');
  })();

  // 5. ì£¼ë¬¸í•˜ê¸° (ì‚¬ì¥ë‹˜ ì›ë³¸ ìœ ì§€ + ëª¨ë‹¬ ì—°ë™)
 document.getElementById('pay-btn').onclick = async (e) => {
    e.preventDefault();
    
    const table = document.getElementById('tableNo').value.trim();
    const inputCode = document.getElementById('paycode').value.trim();
    
    // 1. ê¸°ë³¸ ìœ íš¨ì„± ê²€ì‚¬ (ì„œë²„ í†µì‹  ì „ ë¹ ë¥¸ í™•ì¸)
    if (!table) return showToast('í…Œì´ë¸” ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'info');
    if (!inputCode) return showToast('ê²°ì œ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'info');
    if (!cart.items.length) return showToast('ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤', 'info');

    try {
        // 2. ì„œë²„ì—ì„œ ê²°ì œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        const res = await fetch(`/api/payment-code?storeId=${storeId}`);
        if (!res.ok) throw new Error("ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì˜¤ë¥˜");
        
        const pc = await res.json();
        
        // 3. ê²°ì œ ì½”ë“œ ëŒ€ì¡°
        if (inputCode !== pc?.code) {
            return showToast('ê²°ì œ ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤', 'info');
        }

        // 4. í™•ì¸ ëª¨ë‹¬ ë°ì´í„° ì„¸íŒ… (confirm-items í…ìŠ¤íŠ¸ ìƒì„±)
        document.getElementById('confirm-items').textContent = cart.items.map(i => {
            let line = `${i.name} x${i.qty}`;
            if (i.optionText && i.optionText.length > 0) {
                const groups = {};
                i.optionText.forEach(t => {
                    const [g, v] = t.split(':');
                    if (!groups[g]) groups[g] = [];
                    groups[g].push(v);
                });
                const optLine = Object.entries(groups)
                    .map(([g, v]) => `   â”” ${g}: ${v.join(',')}`)
                    .join('\n');
                line += `\n${optLine}`;
            }
            return line;
        }).join('\n');

        document.getElementById('confirm-total').textContent = cart.total().toLocaleString();
        document.getElementById('order-confirm-modal').style.display = 'flex';

    } catch (err) {
        // 5. ë„¤íŠ¸ì›Œí¬ ì¥ì• ë‚˜ ì„œë²„ ì—ëŸ¬ ì²˜ë¦¬
        console.error("Payment code fetch error:", err);
        showToast("ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", "error");
    }
  };

  document.getElementById('confirm-ok').onclick = async () => {
    const btn = document.getElementById('confirm-ok');
    
    // 1. ì¤‘ë³µ í´ë¦­ ë°©ì§€ (ë²„íŠ¼ ë¹„í™œì„±í™”)
    if (btn.disabled) return;
    btn.disabled = true;
    btn.textContent = "ì²˜ë¦¬ ì¤‘...";

    try {
        const table = document.getElementById('tableNo').value;
        const amount = cart.total();
        const cartItems = cart.items;
        const storeId = window.qrnrStoreId;

        const payload = {
            storeId,
            type: 'store',
            table,
            amount,
            cart: cartItems
        };

        // 2. ì„œë²„ì— ì£¼ë¬¸ ë°ì´í„° ì „ì†¡
        const r = await fetch('/api/orders', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!r.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");

        const resData = await r.json();

        if (resData.ok) {
            // 3. ì£¼ë¬¸ ì„±ê³µ ì‹œ ë¡œì»¬ ìºì‹œì— ì €ì¥
            const orderCache = {
                id: resData.orderId,
                ts: Date.now(),
                status: 'ì£¼ë¬¸ì ‘ìˆ˜',
                table: table,
                cart: cart.items,
                amount: amount
            };
            
            let orderHistory = JSON.parse(localStorage.getItem(`orders_${storeId}`) || "[]");
            orderHistory.push(orderCache);
            localStorage.setItem(`orders_${storeId}`, JSON.stringify(orderHistory));
            localStorage.setItem(`last_order_${storeId}`, JSON.stringify(orderCache));

            // ëª¨ë‹¬ ì „í™˜
            document.getElementById('order-confirm-modal').style.display = 'none';
            document.getElementById('order-success-modal').style.display = 'flex';
        } else {
            // ì„œë²„ì—ì„œ ì‹¤íŒ¨ ì‘ë‹µì„ ë³´ë‚¸ ê²½ìš° (ì˜ˆ: ì¬ê³  ë¶€ì¡± ë“±)
            showToast(resData.msg || "ì£¼ë¬¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
            btn.disabled = false;
            btn.textContent = "í™•ì¸";
        }

    } catch (err) {
        // 4. ë„¤íŠ¸ì›Œí¬ ì—°ê²° ëŠê¹€ ë“± ì˜ˆì™¸ ìƒí™© ì²˜ë¦¬
        console.error("Order submit error:", err);
        showToast("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", "error");
        btn.disabled = false;
        btn.textContent = "í™•ì¸";
    }
  };

  document.getElementById('confirm-cancel').onclick = () => document.getElementById('order-confirm-modal').style.display = 'none';
  document.getElementById('order-success-close').onclick = () => location.reload();
// ğŸ”„ [ì‹¤ì‹œê°„ ë™ê¸°í™” ìµœì¢…ë³¸]
async function initRealtimeSync() {
        try {
            const sid = window.qrnrStoreId || new URLSearchParams(location.search).get('store');
            if (!sid) return;

            const channel = await supabaseMgr.getChannel(sid);
            if (!channel) return;

            console.log(`ğŸ“¡ [ì‹¤ì‹œê°„] ì±„ë„ ì—°ê²° ì™„ë£Œ: qrnr_realtime_${sid}`);

            
            

            channel.on('broadcast', { event: 'RELOAD_SIGNAL' }, async (payload) => {
                const updateType = payload.payload.type;
                showToast("ğŸ“‹ ë§¤ì¥ ì •ë³´ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.", "info");

                if (updateType === 'menu_update' || !updateType) {
                    await renderMenu('menu-grid', cart);
                }
                if (updateType === 'call_options_update' || !updateType) {
                    const res = await fetch(`/api/store-settings?storeId=${sid}`);
                    const data = await res.json();
                    const list = data.settings?.call_options || ['ë¬¼/ìˆ˜ì € ìš”ì²­', 'í…Œì´ë¸” ì •ë¦¬', 'ì£¼ë¬¸ ë¬¸ì˜', 'ì§ì› í˜¸ì¶œ'];
                    document.getElementById('call-reason').innerHTML = list.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                }
                if (typeof loadStoreInfo === 'function') await loadStoreInfo();
            });
        } catch (e) { console.error("ì‹¤ì‹œê°„ ë™ê¸°í™” ì—ëŸ¬:", e); }
    }
    initRealtimeSync();

  // ğŸš€ ìµœê·¼ ì£¼ë¬¸ í™•ì¸ ë° ì‹¤ì‹œê°„ ë™ê¸°í™” í•¨ìˆ˜
/*function checkRecentOrder() {
    const storeId = window.qrnrStoreId;
    const cached = localStorage.getItem(`last_order_${storeId}`);
    
    if (!cached) return;

    const order = JSON.parse(cached);
    
    // ğŸ’¡ íŒ: ì£¼ë¬¸í•œ ì§€ 6ì‹œê°„ì´ ì§€ë‚¬ìœ¼ë©´ ë§Œë£Œëœ ê²ƒìœ¼ë¡œ ê°„ì£¼
    if (Date.now() - order.ts > 1000 * 60 * 60 * 6) {
        localStorage.removeItem(`last_order_${storeId}`);
        return;
    }

    //renderRecentOrderBar(order);
    subscribeOrderStatus(order.id, storeId); // ì‹¤ì‹œê°„ ìƒíƒœ ê°ì‹œ ì‹œì‘
}*/


document.getElementById('btn-show-history').onclick = () => {
    const storeId = window.qrnrStoreId || new URLSearchParams(location.search).get('store');
    // ë°ì´í„° íŒŒì‹± ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•œ ë¹ˆ ë°°ì—´ ê¸°ë³¸ê°’ ì„¤ì •
    const history = JSON.parse(localStorage.getItem(`orders_${storeId}`) || "[]");
    const listEl = document.getElementById('history-list');
    
    if (!listEl) return;

    if (history.length === 0) {
        listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#9ca3af;">ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    } else {
        listEl.innerHTML = history.slice().reverse().map(o => {
            const rawData = o.cart || o.items || [];
            let menuArray = [];

            if (Array.isArray(rawData)) {
                menuArray = rawData;
            } else if (typeof rawData === 'string') {
                menuArray = rawData.split(',').map(name => ({ name: name.trim(), qty: 1 }));
            }

            const itemDetails = menuArray.map(i => {
                // [ë³´ì•ˆ] ë©”ë‰´ëª…ì— esc ì ìš©
                const name = i.name || (typeof i === 'string' ? i : 'ì•Œ ìˆ˜ ì—†ëŠ” ë©”ë‰´');
                const qty = i.qty || 1;
                
                let opts = i.optionText || i.selectedOptions || i.options || [];
                let optHtml = "";

                if (opts && opts.length > 0) {
                    const optArr = Array.isArray(opts) ? opts : String(opts).split(',');
                    const cleanOpts = optArr.map(t => {
                        const str = typeof t === 'string' ? t : (t.label || t.value || "");
                        // [ë³´ì•ˆ] ì˜µì…˜ ê°’ ì¶”ì¶œ ì‹œ esc ì ìš©
                        return str.includes(':') ? esc(str.split(':')[1]) : esc(str);
                    }).filter(Boolean).join(', ');

                    if (cleanOpts) {
                        optHtml = `<div style="font-size:11px; color:#9ca3af; margin-left:14px; margin-top:2px; line-height:1.2;">â”” ì˜µì…˜: ${cleanOpts}</div>`;
                    }
                }

                return `
                    <div style="margin-bottom:10px; border-left: 2px solid #2ea04333; padding-left: 8px;">
                        <div style="font-weight:600; color:#e6edf3;">â€¢ ${esc(name)} <span style="font-size:11px; color:#9ca3af;">x${qty}</span></div>
                        ${optHtml}
                    </div>
                `;
            }).join('');

            // [ë³´ì•ˆ] ìƒíƒœê°’(status)ì— esc ì ìš©
            const status = o.status || 'ì£¼ë¬¸ì ‘ìˆ˜';
            const isCanceled = (status === 'ì£¼ë¬¸ì·¨ì†Œ' || status === 'ê²°ì œì·¨ì†Œ');

            return `
                <div style="background:#161b22; padding:16px; border-radius:14px; border:1px solid #263241; margin-bottom:15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div class="hstack" style="justify-content:space-between; margin-bottom:12px; border-bottom:1px solid #263241; padding-bottom:8px;">
                        <span class="small" style="color:#9ca3af;">${new Date(o.ts).toLocaleString()}</span>
                        <b style="color:${isCanceled ? '#ef4444' : '#2ea043'}; font-size:12px;">${esc(status)}</b>
                    </div>
                    <div class="vstack" style="gap:4px;">
                        ${itemDetails}
                    </div>
                    <div style="text-align:right; margin-top:12px; border-top:1px solid #263241; padding-top:10px;">
                        <span style="font-size:12px; color:#9ca3af;">ì´ ê²°ì œì•¡</span>
                        <div style="color:#2ea043; font-size:18px; font-weight:bold;">${Number(o.amount || 0).toLocaleString()}ì›</div>
                    </div>
                </div>
            `;
        }).join('');
    }
    document.getElementById('history-modal').style.display = 'flex';
};

// ëª¨ë‹¬ ë‹«ê¸°
document.getElementById('history-close').onclick = () => {
    document.getElementById('history-modal').style.display = 'none';
};

</script>
</body>
</html>
