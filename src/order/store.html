
<!doctype html><html lang="ko"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="stylesheet" href="/src/admin/assets/css/style.css"/><title>ë§¤ì¥ ì£¼ë¬¸</title></head><body>
<div class="container">
  <h1>QR Order - ì£¼ë¬¸</h1>
  <div class="card vstack">
    <div class="hstack" style="gap:12px;flex-wrap:wrap">
      <div class="vstack" style="min-width:220px;flex:1"><label class="small">í…Œì´ë¸”</label><input id="tableNo" class="input" placeholder="ì˜ˆ: 12"></div>
      <div class="vstack" style="min-width:220px;flex:1"><label class="small">ì˜¤ëŠ˜ì˜ ê²°ì œ ì½”ë“œ</label><input id="paycode" class="input" placeholder="ê´€ë¦¬ìì—ê²Œ ë°›ì€ 4ìë¦¬"></div>
    </div>
  </div>
  <div class="card vstack"><h3>ì§ì› í˜¸ì¶œ</h3>
    <div class="hstack" style="gap:8px;flex-wrap:wrap"><select id="call-reason" class="input" style="max-width:240px"><option>ì„ íƒ ì—†ìŒ</option><option>ë¬¼/ìˆ˜ì € ìš”ì²­</option><option>í…Œì´ë¸” ì •ë¦¬</option><option>ì£¼ë¬¸ ë¬¸ì˜</option></select><button id="call-btn" class="btn">ì§ì› í˜¸ì¶œ</button></div>
    <div id="call-msg" class="small"></div>
  </div>
  <div class="card vstack"><h3>ë©”ë‰´</h3><div id="menu-grid" class="hstack" style="gap:12px;flex-wrap:wrap"></div></div>
  <div class="card vstack"><h3>ì¥ë°”êµ¬ë‹ˆ</h3><div id="cart-box" class="vstack"></div></div>
  <div class="card hstack" style="justify-content:space-between"><div>í•©ê³„: <b id="total">0</b>ì›</div><button id="pay-btn" class="btn primary">ê²°ì œí•˜ê¸°</button></div>
</div>

 <script type="module">
  import { renderMenu, makeCart } from '/src/order/assets/js/modules/menu-cart.js';
  import { get, patch } from '/src/order/assets/js/modules/cust-store.js';
  import { setPendingOrder, startPayment } from '/src/shared/toss-client.js';

  // â”€â”€ í…Œì´ë¸” ë²ˆí˜¸ ì´ˆê¸° ì„¸íŒ… (QR ?table= íŒŒë¼ë¯¸í„°)
  const url = new URL(location.href);
   const storeId = url.searchParams.get('store') || 'store1';
  const tableParam = url.searchParams.get('table');
  const tableInput = document.getElementById('tableNo');
  if (tableParam && tableInput) {
    tableInput.value = tableParam;
  }

  // â”€â”€ ì¥ë°”êµ¬ë‹ˆ & ë©”ë‰´ ì´ˆê¸°í™” (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
  //    cart-box, total ìš”ì†Œë¥¼ ì‚¬ìš©í•˜ëŠ” ê¸°ì¡´ êµ¬ì¡° ê·¸ëŒ€ë¡œ í™œìš©
  const cart = makeCart('cart-box', 'total');   // cart.items, cart.render() ë“± ì œê³µ
  cart.render();
  renderMenu('menu-grid', cart);

  // â”€â”€ í˜¸ì¶œ ë²„íŠ¼ (ê¸°ì¡´ ê¸°ëŠ¥ ê·¸ëŒ€ë¡œ ìœ ì§€)
   const adminChannel = new BroadcastChannel('qrnr-admin');
const callBtn = document.getElementById('call-btn');

if (callBtn) {
  callBtn.onclick = async () => {
    const reasonEl = document.getElementById('call-reason');
    const msgEl = document.getElementById('call-msg');
    const tableVal = (document.getElementById('tableNo')?.value || '').trim();

    if (!tableVal) {
      alert('í…Œì´ë¸” ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }

    const note = (reasonEl?.value || '').trim();

    /*try {
      const res = await fetch('/api/orders', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({
          type: 'store',          // ë§¤ì¥ í˜¸ì¶œì´ë‹ˆê¹Œ storeë¡œ í†µì¼
          orderName: 'ì§ì› í˜¸ì¶œ',  // êµ¬ë¶„ìš©
          table: tableVal,
          amount: 0,
          cart: [],
          status: 'ëŒ€ê¸°',
          meta: {
            kind: 'CALL',
            note
          }
        })
      });

      const data = await res.json();
      if (!data.ok) throw new Error('save failed');

      if (msgEl) {
        msgEl.textContent = 'í˜¸ì¶œ ì „ì†¡ë¨ (ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ í™•ì¸ ê°€ëŠ¥)';
      }
    } catch (err) {
      console.error('call send failed', err);
      alert('í˜¸ì¶œ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    }*/
// âœ… 1) ê´€ë¦¬ì ì•Œë¦¼ íƒ­ì— ìŒ“ì„ ë°ì´í„° (ë¡œì»¬ìš©)
    //    admin.notify ë°°ì—´ì— push (ë§¤ì¥ì£¼ë¬¸ê³¼ ë¶„ë¦¬)
try {
  patch(['admin', 'notifyLogs'], (list) => {
    const arr = Array.isArray(list) ? [...list] : [];
    arr.unshift({
      id: 'CALL-' + Date.now(),
      type: 'CALL',
      ts: Date.now(),
      storeId,            // ğŸ”´ ì¶”ê°€: ì–´ëŠ ë§¤ì¥ í˜¸ì¶œì¸ì§€
      table: tableVal,
      message: note,
      status: 'ëŒ€ê¸°'
    });
    return arr;
  });
} catch (e) {
  console.error('local notify patch failed', e);
}

// BroadcastChannel ë©”ì‹œì§€ë„ ë§¤ì¥ ì •ë³´ í¬í•¨
adminChannel.postMessage({
  type: 'CALL',
  storeId,            // ğŸ”´ ì¶”ê°€
  table: tableVal,
  note,
  ts: Date.now()
});

     if (msgEl) {
        msgEl.textContent = 'í˜¸ì¶œ ì „ì†¡ë¨ (ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ í™•ì¸ ê°€ëŠ¥)';
      }
  };
}


  // â”€â”€ ìœ í‹¸ í•¨ìˆ˜ë“¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function totalAmountFromCart() {
    if (cart?.items?.length) {
      return cart.items.reduce(
        (sum, i) => sum + Number(i.price || 0) * Number(i.qty || 1),
        0
      );
    }
    const el =
      document.querySelector('[data-total]') || document.getElementById('total');
    const v = el
      ? el.getAttribute('data-total') || el.textContent || '0'
      : '0';
    return Number(String(v).replace(/[^0-9.-]/g, '')) || 0;
  }

  function buildCart() {
    if (cart?.items?.length) {
      // menu-cart.jsì—ì„œ ê´€ë¦¬í•˜ëŠ” cart ê°ì²´ ì‚¬ìš©
      return cart.items.map((i) => ({
        name: i.name,
        qty: i.qty,
        price: i.price,
      }));
    }

    // í˜¹ì‹œ cart ê°ì²´ê°€ ì—†ë‹¤ë©´ data-cart-item ê¸°ë°˜ fallback
    const items = [];
    document.querySelectorAll('[data-cart-item]').forEach((row) => {
      const name =
        row.getAttribute('data-name') ||
        row.querySelector('.name')?.textContent ||
        'ë©”ë‰´';
      const qty = Number(
        row.getAttribute('data-qty') ||
          row.querySelector('.qty')?.textContent ||
          1
      );
      const price = Number(
        row.getAttribute('data-price') ||
          row.querySelector('.price')?.textContent ||
          0
      );
      items.push({ name, qty, price });
    });
    return items;
  }

  function currentTable() {
    const v = document.getElementById('tableNo')?.value || tableParam || '';
    return v.toString().trim() || null;
  }

  function getPayCode() {
    // admin ì„¤ì •ì—ì„œ paymentCode.code ì½ê¸°, ì—†ìœ¼ë©´ 7111 fallback
    try {
      const conf = get(['admin', 'paymentCode']) || {};
      return conf.code || '7111';
    } catch {
      return '7111';
    }
  }

  // â”€â”€ ê²°ì œ ë²„íŠ¼ ë°”ì¸ë”© (setPendingOrder + startPayment ì‚¬ìš©) â”€â”€

  function bindPay() {
    const btn =
      document.getElementById('pay-btn') || // ê¸°ì¡´ ì½”ë“œì˜ ì‹¤ì œ ë²„íŠ¼ ID
      document.getElementById('payBtn') ||
      document.querySelector('[data-action="pay"]') ||
      document.querySelector('.btn-pay, button.pay');

    if (!btn) {
      console.warn('pay button not found');
      return;
    }

    btn.addEventListener('click', async (e) => {
      e.preventDefault();

      const table = currentTable();
      const codeInput = document.getElementById('paycode');
      const inputCode = (codeInput?.value || '').trim();
      const expectedCode = getPayCode();

      const items = buildCart();
      const amount = totalAmountFromCart();

      if (!table) {
        alert('í…Œì´ë¸” ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }
      if (inputCode !== expectedCode) {
        alert('ê²°ì œ ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤');
        return;
      }
      if (!items.length || !amount) {
        alert('ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤');
        return;
      }

      const orderId = 'S' + Date.now();
      const orderName =
        items.map((i) => `${i.name}x${i.qty}`).join(', ').slice(0, 48) ||
        'ë§¤ì¥ì£¼ë¬¸';

      const sourceUrl = location.pathname + location.search; // ì˜ˆ: /order/store?store=narae&table=5
      
      // âœ… toss-success.html ì—ì„œ getPendingOrder()ë¡œ ì½ì–´ì„œ /api/orders ë¡œ ì €ì¥í•  ë°ì´í„°
      const payload = {
        type: 'store',          // /api/orders?type=store ì™€ ë§ì¶¤
        table,
        amount,
        orderId,
        orderName,
        cart: items,
        status: 'ëŒ€ê¸°',
        storeId,
        returnTo: sourceUrl     // âœ… ê²°ì œ í›„ ë³µê·€ ê²½ë¡œ
      };

      setPendingOrder(payload);

      try {
        await startPayment({ orderId, amount, orderName });
      } catch (err) {
        console.error('payment start error', err);
        alert('ê²°ì œë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
    });
  }

  bindPay();
</script>


    </body></html>
