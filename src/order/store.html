<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <title>ë§¤ì¥ ì£¼ë¬¸</title>
</head>

<body data-store-id="">
<div class="container">
  <h1>QR Order - ì£¼ë¬¸</h1>

  <!-- í…Œì´ë¸” / ê²°ì œ ì½”ë“œ -->
  <div class="card vstack">
    <div class="hstack" style="gap:12px;flex-wrap:wrap">
      <div class="vstack" style="min-width:220px;flex:1">
        <label class="small">í…Œì´ë¸”</label>
        <input id="tableNo" class="input" placeholder="ì˜ˆ: 12">
      </div>
      <div class="vstack" style="min-width:220px;flex:1">
        <label class="small">ì˜¤ëŠ˜ì˜ ê²°ì œ ì½”ë“œ</label>
        <input id="paycode" class="input" placeholder="ê´€ë¦¬ìì—ê²Œ ë°›ì€ 4ìë¦¬">
      </div>
    </div>
  </div>

  <!-- ì§ì› í˜¸ì¶œ -->
  <div class="card vstack">
    <h3>ì§ì› í˜¸ì¶œ</h3>
    <div class="hstack" style="gap:8px;flex-wrap:wrap">
      <select id="call-reason" class="input" style="max-width:240px">
        <option>ì„ íƒ ì—†ìŒ</option>
        <option>ë¬¼/ìˆ˜ì € ìš”ì²­</option>
        <option>í…Œì´ë¸” ì •ë¦¬</option>
        <option>ì£¼ë¬¸ ë¬¸ì˜</option>
      </select>
      <button id="call-btn" class="btn">ì§ì› í˜¸ì¶œ</button>
    </div>
    <div id="call-msg" class="small"></div>
  </div>

  <!-- ë©”ë‰´ -->
  <div class="card vstack">
    <h3>ë©”ë‰´</h3>
    <div id="menu-grid" class="hstack" style="gap:12px;flex-wrap:wrap"></div>
  </div>

  <!-- ì¥ë°”êµ¬ë‹ˆ -->
  <div class="card vstack">
    <h3>ì¥ë°”êµ¬ë‹ˆ</h3>
    <div id="cart-box" class="vstack"></div>
  </div>

  <!-- í•©ê³„ / ì£¼ë¬¸ -->
  <div class="card hstack" style="justify-content:space-between;align-items:center">
    <div>í•©ê³„: <b id="total">0</b>ì›</div>
    <button id="pay-btn" class="btn primary">ì£¼ë¬¸í•˜ê¸°</button>
  </div>

  <div class="small" style="color:#9ca3af;margin-top:6px">
    ì£¼ë¬¸ ì ‘ìˆ˜ í›„ ì¹´ìš´í„°ì—ì„œ ê²°ì œë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.
  </div>
</div>

<!-- ì£¼ë¬¸ ì™„ë£Œ ëª¨ë‹¬ -->
<div id="order-success-modal"
     style="
       display:none;
       position:fixed;
       inset:0;
       background:rgba(0,0,0,.45);
       z-index:1000;
       align-items:center;
       justify-content:center;
     ">
  <div style="
    background:#0d1117;
    color:#fff;
    padding:24px;
    border-radius:16px;
    width:90%;
    max-width:360px;
    text-align:center;
  ">
    <h3 style="margin-bottom:12px">ì£¼ë¬¸ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤</h3>
    <p style="font-size:14px;color:#9ca3af;line-height:1.5">
      ì¹´ìš´í„°ì—ì„œ ê²°ì œë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.
    </p>

    <button id="order-success-close"
            class="btn primary"
            style="margin-top:20px;width:100%">
      í™•ì¸
    </button>
  </div>
</div>

<!-- ì£¼ë¬¸ í™•ì¸ ëª¨ë‹¬ (ë§¤ì¥ ì£¼ë¬¸ìš©) -->
<div id="order-confirm-modal"
     style="
       display:none;
       position:fixed;
       inset:0;
       background:rgba(0,0,0,.45);
       z-index:1000;
       align-items:center;
       justify-content:center;
     ">
  <div style="
    background:#0d1117;
    color:#fff;
    padding:20px;
    border-radius:16px;
    width:90%;
    max-width:420px;
  ">
    <h3>ì£¼ë¬¸ í™•ì¸</h3>

    <pre id="confirm-items"
         style="white-space:pre-wrap;font-size:13px"></pre>

    <div style="margin-top:10px">
      í•©ê³„: <b id="confirm-total"></b>ì›
    </div>

    <div style="display:flex;gap:8px;margin-top:16px">
      <button id="confirm-cancel" class="btn" style="flex:1">ì·¨ì†Œ</button>
      <button id="confirm-ok" class="btn primary" style="flex:1">í™•ì¸</button>
    </div>
  </div>
</div>


<script type="module">
  import { renderMenu, makeCart } from '/src/order/assets/js/modules/menu-cart.js';
  import { get, patch } from '/src/order/assets/js/modules/cust-store.js';
  import { ensureStoreInitialized } from '/src/shared/store.js';
  import { getPaymentCode } from '/src/admin/assets/js/modules/store.js';


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // storeId ì´ˆê¸°í™”
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const storeId = ensureStoreInitialized();
  window.qrnrStoreId = storeId;
  document.body.dataset.storeId = storeId;

  const url = new URL(location.href);
  const tableParam = url.searchParams.get('table') || '';
  const tableInput = document.getElementById('tableNo');
  if (tableParam && tableInput) tableInput.value = tableParam;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì¥ë°”êµ¬ë‹ˆ & ë©”ë‰´
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const cart = makeCart('cart-box', 'total');
  cart.render();
  renderMenu('menu-grid', cart);

  function clearCart() {
    cart.items.length = 0;
    cart.render();
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì§ì› í˜¸ì¶œ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  const callBtn = document.getElementById('call-btn');

if (callBtn) {
  callBtn.onclick = async () => {
    const tableVal = (document.getElementById('tableNo')?.value || '').trim();
    const note = (document.getElementById('call-reason')?.value || '').trim();

    if (!tableVal) {
      alert('í…Œì´ë¸” ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }

    try {
      const r = await fetch('/api/call', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ storeId, table: tableVal, note })
      });

      const j = await r.json();
      if (!j.ok) throw new Error();

      // âœ… ê´€ë¦¬ì ì•Œë¦¼ (ì—¬ê¸°ê°€ í•µì‹¬)
      const channel = new BroadcastChannel('qrnr-admin');
      channel.postMessage({
        type: 'CALL',
        storeId,
        table: tableVal,
        note,
        ts: Date.now()
      });

      document.getElementById('call-msg').textContent =
        'ì§ì› í˜¸ì¶œì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.';
    } catch (e) {
      alert('ì§ì› í˜¸ì¶œ ì‹¤íŒ¨');
      console.error(e);
    }
  };
}



  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ìœ í‹¸
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function currentTable() {
    return (document.getElementById('tableNo')?.value || '').trim();
  }

  function getPayCode() {
  try {
    const storeId = window.qrnrStoreId;
    const pc = getPaymentCode(storeId);
    return pc?.code || '';
  } catch {
    return '';
  }
}




  function totalAmountFromCart() {
    return cart.items.reduce(
      (sum, i) => sum + Number(i.price || 0) * Number(i.qty || 1),
      0
    );
  }

  



  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì£¼ë¬¸ ì™„ë£Œ ëª¨ë‹¬
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openOrderConfirmModal(items, amount) {
  document.getElementById('confirm-items').textContent =
    items.map(i => {
      let line = `${i.name} x${i.qty}`;
      if (Array.isArray(i.options) && i.options.length) {
  const optText = i.options
    .map(o => {
      const group = o.group || o.name || 'ì˜µì…˜';
      const label = o.label || o.value || '';
      return label ? `${group}:${label}` : group;
    });

  line += '\n' + optText.map(t => ` â”” ${t}`).join('\n');
}

      return line;
    }).join('\n\n');

  document.getElementById('confirm-total').textContent =
    amount.toLocaleString();

  document.getElementById('order-confirm-modal').style.display = 'flex';
}

function closeOrderConfirmModal() {
  document.getElementById('order-confirm-modal').style.display = 'none';
}

  function openOrderSuccessModal() {
    document.getElementById('order-success-modal').style.display = 'flex';
  }

  function closeOrderSuccessModal() {
    document.getElementById('order-success-modal').style.display = 'none';
  }

  document.getElementById('order-success-close').onclick = () => {
    closeOrderSuccessModal();
    clearCart();
  };

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì£¼ë¬¸í•˜ê¸° (POS ê²°ì œ ë°©ì‹)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('pay-btn').onclick = (e) => {
  e.preventDefault();

  const table = currentTable();
  const inputCode = document.getElementById('paycode').value.trim();
  const expectedCode = getPayCode();
  const items = cart.items;
  const amount = cart.total();


  if (!table) return alert('í…Œì´ë¸” ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
  if (inputCode !== expectedCode) return alert('ê²°ì œ ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤');
  if (!items.length) return alert('ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤');

  // ğŸ”¥ ì—¬ê¸°ì„œ ì£¼ë¬¸ ì•ˆ ë³´ëƒ„
  openOrderConfirmModal(items, amount);
};
document.getElementById('confirm-ok').onclick = async () => {
  closeOrderConfirmModal();

  const items = cart.items;
  const amount = cart.total();

  const table = currentTable();

  const orderId = 'S' + Date.now();
  const orderName =
    items.map(i => `${i.name}x${i.qty}`).join(', ').slice(0, 48) || 'ë§¤ì¥ì£¼ë¬¸';

  const payload = {
  orderId,
  storeId,
  orderType: 'store',
  status: 'WAIT_PAY',
  table,
  amount: cart.total(),

  items: cart.items.map(i => ({
    id: i.id,
    name: i.name,
    qty: i.qty,
    unitPrice: i.price,
    options: Array.isArray(i.options) ? i.options : []
  })),

  createdAt: Date.now()
};


  const r = await fetch('/api/orders', {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify(payload)
  });

  const j = await r.json();
  if (!j.ok) return alert('ì£¼ë¬¸ ì €ì¥ ì‹¤íŒ¨');

  // ğŸ”” ê´€ë¦¬ì ì•Œë¦¼ (ë§¤ì¥ ì£¼ë¬¸)
  try {
    const channel = new BroadcastChannel('qrnr-admin');
    channel.postMessage({
      type: 'NEW_ORDER',
      orderType: 'store',        // â­ ë§¤ì¥ ì£¼ë¬¸
      storeId,
      table: table || null,
      amount: amount || 0,
      ts: Date.now()
    });
  } catch (e) {
    console.error('[store] admin notify error', e);
  }

  
  openOrderSuccessModal();
};

document.getElementById('confirm-cancel').onclick = closeOrderConfirmModal;


</script>
</body>
</html>
