<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <title>ë§¤ì¥ ì£¼ë¬¸</title>
  <style>
    /* ìµœì†Œ ìˆ˜ì •: ë©”ë‰´ ê·¸ë¦¬ë“œ ì¤‘ì•™ ì •ë ¬ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
    #menu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      justify-items: center;
      text-align: center;
    }
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.show { display: flex; }
    .modal .content {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      color: #333;
    }
  </style>
</head>

<body data-store-id="">
<div class="container">
  <h1>QR Order - ì£¼ë¬¸</h1>

  <div class="card vstack">
    <div class="hstack" style="gap:12px;flex-wrap:wrap">
      <div class="vstack" style="min-width:220px;flex:1">
        <label class="small">í…Œì´ë¸”</label>
        <input id="tableNo" class="input" placeholder="ì˜ˆ: 12">
      </div>
      <div class="vstack" style="min-width:220px;flex:1">
        <label class="small">ì˜¤ëŠ˜ì˜ ê²°ì œ ì½”ë“œ</label>
        <input id="paycode" class="input" placeholder="ê´€ë¦¬ìì—ê²Œ ë°›ì€ 4ìë¦¬">
      </div>
    </div>
  </div>

  <div class="card vstack">
    <h3>ì§ì› í˜¸ì¶œ</h3>
    <div class="hstack" style="gap:8px;flex-wrap:wrap">
      <select id="call-reason" class="input" style="max-width:240px"></select>
      <button id="call-btn" class="btn">ì§ì› í˜¸ì¶œ</button>
    </div>
    <div id="call-msg" class="small" style="color:var(--primary);margin-top:8px"></div>
  </div>

  <div class="card vstack">
    <h3>ë©”ë‰´</h3>
    <div id="menu-grid"></div>
  </div>

  <div class="card vstack" style="margin-bottom:100px">
    <div class="hstack" style="justify-content:space-between; align-items:center">
      <h3>ì¥ë°”êµ¬ë‹ˆ</h3>
      <button id="cart-clear-btn" class="btn small">ë¹„ìš°ê¸°</button>
    </div>
    
    <div id="cart-box" class="vstack" style="margin: 10px 0; gap: 10px;"></div>

    <div class="hstack" style="justify-content:space-between; padding-top:10px; border-top:1px solid #333">
      <span style="font-weight:bold">ì´ í•©ê³„</span>
      <div><b id="total" style="font-size:1.2rem; color:var(--primary)">0</b>ì›</div>
    </div>
    <button id="pay-btn" class="btn primary large" style="width:100%; margin-top:15px">ì£¼ë¬¸í•˜ê¸°</button>
  </div>
</div>

<div id="option-modal" class="modal">
  <div class="content">
    <h3 id="opt-menu-name">ì˜µì…˜ ì„ íƒ</h3>
    <div id="opt-container" class="vstack" style="margin:15px 0"></div>
    <div class="hstack" style="gap:8px">
      <button id="opt-close" class="btn" style="flex:1">ì·¨ì†Œ</button>
      <button id="opt-add-cart" class="btn primary" style="flex:1">ë‹´ê¸°</button>
    </div>
  </div>
</div>

<div id="order-confirm-modal" class="modal">
  <div class="content">
    <h3>ì£¼ë¬¸ í™•ì¸</h3>
    <pre id="confirm-items" style="white-space:pre-wrap; font-size:13px; background:#f4f4f4; padding:10px; border-radius:8px; margin:10px 0; color:#333; font-family:inherit;"></pre>
    <div style="text-align:right">í•©ê³„: <b id="confirm-total"></b>ì›</div>
    <div class="hstack" style="gap:8px; margin-top:16px">
      <button id="confirm-cancel" class="btn" style="flex:1">ì·¨ì†Œ</button>
      <button id="confirm-ok" class="btn primary" style="flex:1">í™•ì¸</button>
    </div>
  </div>
</div>

<div id="order-success-modal" class="modal">
  <div class="content" style="text-align:center">
    <h3>ì£¼ë¬¸ ì™„ë£Œ!</h3>
    <p style="margin:10px 0; color:#666;">ì¹´ìš´í„°ì—ì„œ ê²°ì œë¥¼ ì§„í–‰í•´ ì£¼ì„¸ìš”.</p>
    <button id="order-success-close" class="btn primary" style="width:100%; margin-top:15px">í™•ì¸</button>
  </div>
</div>

<script type="module">
  import { renderMenu, makeCart } from '/src/order/assets/js/modules/menu-cart.js';
  import { get, patch } from '/src/order/assets/js/modules/cust-store.js';
  import { ensureStoreInitialized } from '/src/shared/store.js';
  import { getPaymentCode } from '/src/admin/assets/js/modules/store.js';

  const storeId = ensureStoreInitialized();
  document.body.dataset.storeId = storeId;

  // 1. í…Œì´ë¸” ë²ˆí˜¸ ìë™ ì„¸íŒ…
  const currentTable = () => new URLSearchParams(window.location.search).get('table') || '';
  const tableInput = document.getElementById('tableNo');
  if (currentTable()) {
    tableInput.value = currentTable();
    tableInput.readOnly = true;
  }

  // 2. ì§ì› í˜¸ì¶œ ë¡œì§
  const callBtn = document.getElementById('call-btn');
  const callReason = document.getElementById('call-reason');
  const callMsg = document.getElementById('call-msg');

  const reasons = ['ë¬¼ ì£¼ì„¸ìš”', 'ì “ê°€ë½ ì£¼ì„¸ìš”', 'ì§ì› í˜¸ì¶œ', 'ë¬¼í‹°ìŠˆ ì£¼ì„¸ìš”', 'ì£¼ë¬¸ í™•ì¸ ë¶€íƒë“œë ¤ìš”'];
  reasons.forEach(r => {
    const opt = document.createElement('option');
    opt.textContent = r;
    callReason.appendChild(opt);
  });

  callBtn.onclick = async () => {
    const table = tableInput.value.trim();
    if (!table) return alert('í…Œì´ë¸” ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤');
    
    callBtn.disabled = true;
    const res = await fetch('/api/call', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ storeId, table, note: callReason.value })
    });
    
    if (res.ok) {
      callMsg.textContent = 'ğŸ”” í˜¸ì¶œë˜ì—ˆìŠµë‹ˆë‹¤.';
      setTimeout(() => {
        callMsg.textContent = '';
        callBtn.disabled = false;
      }, 5000);
    }
  };

  // 3. ë©”ë‰´ ë° ì¥ë°”êµ¬ë‹ˆ ì´ˆê¸°í™”
  const cart = makeCart(document.getElementById('cart-box'), document.getElementById('total'));
  
  const loadData = async () => {
    const [menuData, settingsData] = await Promise.all([
      get(`/api/menus?storeId=${storeId}`),
      get(`/api/store-settings?storeId=${storeId}`)
    ]);

    if (menuData.ok) {
      renderMenu(document.getElementById('menu-grid'), menuData.menus, (menu) => {
        // ì˜µì…˜ì´ ìˆëŠ” ê²½ìš° ëª¨ë‹¬ ë„ìš°ëŠ” ë¡œì§ì€ menu-cart.js ë‚´ë¶€ êµ¬í˜„ì— ë”°ë¦„
        cart.add(menu);
      });
    }
  };

  loadData();

  // 4. ì£¼ë¬¸í•˜ê¸° ë¡œì§ (ëª¨ë‹¬ ì—°ë™)
  const payBtn = document.getElementById('pay-btn');
  const orderConfirmModal = document.getElementById('order-confirm-modal');
  const orderSuccessModal = document.getElementById('order-success-modal');

  payBtn.onclick = async () => {
    const table = tableInput.value.trim();
    const inputCode = document.getElementById('paycode').value.trim();
    const expected = await getPaymentCode(storeId);

    if (!table) return alert('í…Œì´ë¸” ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
    if (inputCode !== expected.code) return alert('ê²°ì œ ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤');
    if (cart.items.length === 0) return alert('ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤');

    // í™•ì¸ ëª¨ë‹¬ ë„ìš°ê¸°
    document.getElementById('confirm-items').textContent = cart.items.map(i => `${i.name} x ${i.qty}`).join('\n');
    document.getElementById('confirm-total').textContent = document.getElementById('total').textContent;
    orderConfirmModal.classList.add('show');
  };

  document.getElementById('confirm-cancel').onclick = () => orderConfirmModal.classList.remove('show');
  
  document.getElementById('confirm-ok').onclick = async () => {
    orderConfirmModal.classList.remove('show');
    
    const payload = {
      storeId,
      type: 'store', // api/index.jsì˜ ì¡°ê±´ì— ë§ì¶¤
      table: tableInput.value,
      amount: parseInt(document.getElementById('total').textContent.replace(/,/g, '')),
      cart: cart.items
    };

    const r = await fetch('/api/orders', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (r.ok) {
      orderSuccessModal.classList.add('show');
      cart.clear();
    } else {
      alert('ì£¼ë¬¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  };

  document.getElementById('order-success-close').onclick = () => location.reload();
  document.getElementById('cart-clear-btn').onclick = () => { if(confirm('ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) cart.clear(); };

</script>
</body>
</html>
