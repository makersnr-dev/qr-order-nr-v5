<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <title>매장 주문</title>
</head>

<body data-store-id="">
<div class="container">
  <h1>QR Order - 주문</h1>

  <!-- 테이블 / 결제 코드 -->
  <div class="card vstack">
    <div class="hstack" style="gap:12px;flex-wrap:wrap">
      <div class="vstack" style="min-width:220px;flex:1">
        <label class="small">테이블</label>
        <input id="tableNo" class="input" placeholder="예: 12">
      </div>
      <div class="vstack" style="min-width:220px;flex:1">
        <label class="small">오늘의 결제 코드</label>
        <input id="paycode" class="input" placeholder="관리자에게 받은 4자리">
      </div>
    </div>
  </div>

  <!-- 직원 호출 -->
  <div class="card vstack">
    <h3>직원 호출</h3>
    <div class="hstack" style="gap:8px;flex-wrap:wrap">
      <select id="call-reason" class="input" style="max-width:240px">
        <option>선택 없음</option>
        <option>물/수저 요청</option>
        <option>테이블 정리</option>
        <option>주문 문의</option>
      </select>
      <button id="call-btn" class="btn">직원 호출</button>
    </div>
    <div id="call-msg" class="small"></div>
  </div>

  <!-- 메뉴 -->
  <div class="card vstack">
    <h3>메뉴</h3>
    <div id="menu-grid" class="hstack" style="gap:12px;flex-wrap:wrap"></div>
  </div>

  <!-- 장바구니 -->
  <div class="card vstack">
    <h3>장바구니</h3>
    <div id="cart-box" class="vstack"></div>
  </div>

  <!-- 합계 / 주문 -->
  <div class="card hstack" style="justify-content:space-between;align-items:center">
    <div>합계: <b id="total">0</b>원</div>
    <button id="pay-btn" class="btn primary">주문하기</button>
  </div>

  <div class="small" style="color:#9ca3af;margin-top:6px">
    주문 접수 후 카운터에서 결제를 진행해주세요.
  </div>
</div>

<!-- 주문 완료 모달 -->
<div id="order-success-modal"
     style="
       display:none;
       position:fixed;
       inset:0;
       background:rgba(0,0,0,.45);
       z-index:1000;
       align-items:center;
       justify-content:center;
     ">
  <div style="
    background:#0d1117;
    color:#fff;
    padding:24px;
    border-radius:16px;
    width:90%;
    max-width:360px;
    text-align:center;
  ">
    <h3 style="margin-bottom:12px">주문이 접수되었습니다</h3>
    <p style="font-size:14px;color:#9ca3af;line-height:1.5">
      카운터에서 결제를 진행해주세요.
    </p>

    <button id="order-success-close"
            class="btn primary"
            style="margin-top:20px;width:100%">
      확인
    </button>
  </div>
</div>

<script type="module">
  import { renderMenu, makeCart } from '/src/order/assets/js/modules/menu-cart.js';
  import { get, patch } from '/src/order/assets/js/modules/cust-store.js';
  import { ensureStoreInitialized } from '/src/shared/store.js';

  // ───────────────────────────────────────────────────────────
  // storeId 초기화
  // ───────────────────────────────────────────────────────────
  const storeId = ensureStoreInitialized();
  window.qrnrStoreId = storeId;
  document.body.dataset.storeId = storeId;

  const url = new URL(location.href);
  const tableParam = url.searchParams.get('table') || '';
  const tableInput = document.getElementById('tableNo');
  if (tableParam && tableInput) tableInput.value = tableParam;

  // ───────────────────────────────────────────────────────────
  // 장바구니 & 메뉴
  // ───────────────────────────────────────────────────────────
  const cart = makeCart('cart-box', 'total');
  cart.render();
  renderMenu('menu-grid', cart);

  function clearCart() {
    cart.items.length = 0;
    cart.render();
  }

  // ───────────────────────────────────────────────────────────
  // 직원 호출
  // ───────────────────────────────────────────────────────────
  const adminChannel = new BroadcastChannel('qrnr-admin');
  const callBtn = document.getElementById('call-btn');

  if (callBtn) {
    callBtn.onclick = () => {
      const tableVal = (document.getElementById('tableNo')?.value || '').trim();
      const note = (document.getElementById('call-reason')?.value || '').trim();

      if (!tableVal) {
        alert('테이블 번호를 입력하세요.');
        return;
      }

      patch(['admin', 'notifyLogs'], (list) => {
        const arr = Array.isArray(list) ? [...list] : [];
        arr.unshift({
          id: 'CALL-' + Date.now(),
          type: 'CALL',
          ts: Date.now(),
          storeId,
          table: tableVal,
          message: note,
          status: '대기'
        });
        return arr;
      });

      adminChannel.postMessage({
        type: 'CALL',
        storeId,
        table: tableVal,
        note,
        ts: Date.now()
      });

      document.getElementById('call-msg').textContent =
        '호출 전송됨 (관리자 페이지에서 확인 가능)';
    };
  }

  // ───────────────────────────────────────────────────────────
  // 유틸
  // ───────────────────────────────────────────────────────────
  function currentTable() {
    return (document.getElementById('tableNo')?.value || '').trim();
  }

  function getPayCode() {
    try {
      const conf = get(['admin', 'paymentCode']) || {};
      return conf.code || '7111';
    } catch {
      return '7111';
    }
  }

  function totalAmountFromCart() {
    return cart.items.reduce(
      (sum, i) => sum + Number(i.price || 0) * Number(i.qty || 1),
      0
    );
  }

  function buildCart() {
    return cart.items.map(i => ({
      name: i.name,
      qty: i.qty,
      price: i.price
    }));
  }

  // ───────────────────────────────────────────────────────────
  // 주문 완료 모달
  // ───────────────────────────────────────────────────────────
  function openOrderSuccessModal() {
    document.getElementById('order-success-modal').style.display = 'flex';
  }

  function closeOrderSuccessModal() {
    document.getElementById('order-success-modal').style.display = 'none';
  }

  document.getElementById('order-success-close').onclick = () => {
    closeOrderSuccessModal();
    clearCart();
  };

  // ───────────────────────────────────────────────────────────
  // 주문하기 (POS 결제 방식)
  // ───────────────────────────────────────────────────────────
  document.getElementById('pay-btn').onclick = async (e) => {
    e.preventDefault();

    const table = currentTable();
    const inputCode = (document.getElementById('paycode')?.value || '').trim();
    const expectedCode = getPayCode();
    const items = buildCart();
    const amount = totalAmountFromCart();

    if (!table) return alert('테이블 번호를 입력하세요');
    if (inputCode !== expectedCode) return alert('결제 코드가 올바르지 않습니다');
    if (!items.length || !amount) return alert('장바구니가 비어 있습니다');

    // ✅ orderId / orderName 복구
    const orderId = 'S' + Date.now();
    const orderName =
      items.map(i => `${i.name}x${i.qty}`).join(', ').slice(0, 48) || '매장주문';

    const payload = {
      type: 'store',
      orderId,
      orderName,
      table,
      amount,
      cart: items,
      storeId,
      status: 'WAIT_PAY',
      ts: Date.now()
    };

    const r = await fetch('/api/orders', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const j = await r.json();
    if (!j.ok) return alert('주문 저장에 실패했습니다');

    openOrderSuccessModal();
  };
</script>
</body>
</html>
