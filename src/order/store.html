<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <title>ë§¤ì¥ ì£¼ë¬¸</title>
  <style>
    /* ğŸš€ ë©”ë‰´ ê·¸ë¦¬ë“œ ì¤‘ì•™ ì •ë ¬ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
    #menu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      justify-items: center; /* ì•„ì´í…œ ê°€ë¡œ ì¤‘ì•™ */
      text-align: center;
    }
    /* ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œ ì˜µì…˜ ìŠ¤íƒ€ì¼ */
    .cart-item-options {
      font-size: 0.85rem;
      color: #666;
      margin-left: 10px;
      line-height: 1.4;
    }
    /* í† ìŠ¤íŠ¸ ì•Œë¦¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
.toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #111922;
  border: 1px solid #263241;
  color: #fff;
  padding: 12px 16px;
  border-radius: 12px;
  font-size: 14px;
  z-index: 99999;
  opacity: 0;
  transition: opacity 0.2s ease;
}
.toast.show { opacity: 1; box-shadow: 0 8px 24px rgba(0,0,0,0.5); }
.toast-success { border-left: 5px solid #2ea043 !important; }
.toast-error { border-left: 5px solid #ef4444 !important; }
.toast-info { border-left: 5px solid #74c0fc !important; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body data-store-id="">
<div class="container">
  <h1>QR Order - ì£¼ë¬¸</h1>

  <div class="card vstack">
    <div class="hstack" style="gap:12px;flex-wrap:wrap">
      <div class="vstack" style="min-width:220px;flex:1">
        <label class="small">í…Œì´ë¸”</label>
        <input id="tableNo" class="input" placeholder="ì˜ˆ: 12">
      </div>
      <div class="vstack" style="min-width:220px;flex:1">
        <label class="small">ì˜¤ëŠ˜ì˜ ê²°ì œ ì½”ë“œ</label>
        <input id="paycode" class="input" placeholder="ê´€ë¦¬ìì—ê²Œ ë°›ì€ 4ìë¦¬">
      </div>
    </div>
  </div>

  <div class="card vstack">
    <h3>ì§ì› í˜¸ì¶œ</h3>
    <div class="hstack" style="gap:8px;flex-wrap:wrap">
      <select id="call-reason" class="input" style="max-width:240px"></select>
      <button id="call-btn" class="btn">ì§ì› í˜¸ì¶œ</button>
    </div>
    <div id="call-msg" class="small" style="color:var(--primary); margin-top:8px"></div>
  </div>

  <div class="card vstack">
    <h3>ë©”ë‰´</h3>
    <div id="menu-grid"></div>
  </div>

  <div class="card vstack">
    <h3>ì¥ë°”êµ¬ë‹ˆ</h3>
    <div id="cart-box" class="vstack" style="gap:10px; margin: 10px 0;"></div>
  </div>

  <div class="card hstack" style="justify-content:space-between;align-items:center; margin-bottom:100px;">
    <div>í•©ê³„: <b id="total" style="color:var(--primary); font-size:1.2rem;">0</b>ì›</div>
    <button id="pay-btn" class="btn primary large">ì£¼ë¬¸í•˜ê¸°</button>
  </div>

  <div class="small" style="color:#9ca3af;margin-top:6px; text-align:center;">
    ì£¼ë¬¸ ì ‘ìˆ˜ í›„ ì¹´ìš´í„°ì—ì„œ ê²°ì œë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.
  </div>
</div>

<div id="option-modal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
  <div class="content" style="background:#fff; padding:20px; border-radius:12px; width:90%; max-width:400px; color:#333;">
    <h3 id="opt-menu-name">ì˜µì…˜ ì„ íƒ</h3>
    <div id="opt-container" class="vstack" style="margin:15px 0"></div>
    <div class="hstack" style="gap:8px">
      <button id="opt-close" class="btn" style="flex:1">ì·¨ì†Œ</button>
      <button id="opt-add-cart" class="btn primary" style="flex:1">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
    </div>
  </div>
</div>

<div id="order-confirm-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:#0d1117; color:#fff; padding:20px; border-radius:16px; width:90%; max-width:420px;">
    <h3>ì£¼ë¬¸ í™•ì¸</h3>
    <pre id="confirm-items" style="white-space:pre-wrap;font-size:13px; background:#161b22; padding:10px; border-radius:8px; margin:10px 0;"></pre>
    <div style="margin-top:10px">í•©ê³„: <b id="confirm-total"></b>ì›</div>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button id="confirm-cancel" class="btn" style="flex:1">ì·¨ì†Œ</button>
      <button id="confirm-ok" class="btn primary" style="flex:1">í™•ì¸</button>
    </div>
  </div>
</div>

<div id="order-success-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:#0d1117; color:#fff; padding:24px; border-radius:16px; width:90%; max-width:360px; text-align:center;">
    <h3 style="margin-bottom:12px">ì£¼ë¬¸ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤</h3>
    <p style="font-size:14px;color:#9ca3af;line-height:1.5">ì¹´ìš´í„°ì—ì„œ ê²°ì œë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.</p>
    <button id="order-success-close" class="btn primary" style="margin-top:20px;width:100%">í™•ì¸</button>
  </div>
</div>

<script type="module">
  import { renderMenu, makeCart } from '/src/order/assets/js/modules/menu-cart.js';
  import { loadStoreInfo, currentStoreId } from '/src/order/assets/js/modules/cust-store.js';
  import { ensureStoreInitialized } from '/src/shared/store.js';
 
  /**
 * í‘œì¤€ í† ìŠ¤íŠ¸ ì•Œë¦¼ í•¨ìˆ˜
 * @param {string} msg - í‘œì‹œí•  ë©”ì‹œì§€
 * @param {string} variant - 'info', 'success', 'error' (ìƒ‰ìƒ êµ¬ë¶„ìš©)
 */
export function showToast(msg, variant = 'info') {
  const t = document.createElement('div');
  
  // ê¸°ë³¸ í´ë˜ìŠ¤ëŠ” toast, ìƒíƒœì— ë”°ë¼ í´ë˜ìŠ¤ ì¶”ê°€ (ì˜ˆ: toast-success)
  t.className = `toast toast-${variant}`; 
  t.textContent = msg;
  
  document.body.appendChild(t);

  // ë¸Œë¼ìš°ì €ê°€ ìš”ì†Œë¥¼ ì¸ì‹í•œ ì§í›„ì— 'show' í´ë˜ìŠ¤ ì¶”ê°€ (ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘)
  requestAnimationFrame(() => t.classList.add('show'));

  // 3ì´ˆ í›„ ì‚¬ë¼ì§
  setTimeout(() => {
    t.classList.remove('show');
    // ì• ë‹ˆë©”ì´ì…˜(0.2ì´ˆ)ì´ ëë‚œ í›„ ìš”ì†Œ ì‚­ì œ
    setTimeout(() => t.remove(), 200);
  }, 3000);
}
  // 1. ì§ì› í˜¸ì¶œ ì¿¨íƒ€ì„ ë¡œì§ (ì‚¬ì¥ë‹˜ ì›ë³¸ ìœ ì§€)
  const CALL_COOLDOWN_SEC = 10;
  const CALL_COOLDOWN_KEY = 'qrnr.call.cooldown';
  function getCallRemainSec() {
    const last = Number(localStorage.getItem(CALL_COOLDOWN_KEY) || 0);
    const diff = Math.floor((Date.now() - last) / 1000);
    return Math.max(0, CALL_COOLDOWN_SEC - diff);
  }
  function updateCallButtonState() {
    const btn = document.getElementById('call-btn');
    const msgEl = document.getElementById('call-msg');
    if (!btn) return;
    const remain = getCallRemainSec();
    if (remain > 0) {
      btn.disabled = true;
      btn.textContent = `ì§ì› í˜¸ì¶œ (${remain}s)`;
    } else {
      btn.disabled = false;
      btn.textContent = 'ì§ì› í˜¸ì¶œ';
    }
  }

  // 2. ì´ˆê¸°í™”
  const storeId = ensureStoreInitialized();
  window.qrnrStoreId = storeId;
  document.body.dataset.storeId = storeId;
  setInterval(updateCallButtonState, 1000);
  updateCallButtonState();

  // í…Œì´ë¸” ë²ˆí˜¸ ìë™ì…ë ¥
  const tableParam = new URLSearchParams(location.search).get('table') || '';
  if (tableParam) document.getElementById('tableNo').value = tableParam;

  // 3. ì¥ë°”êµ¬ë‹ˆ & ë©”ë‰´ ë Œë”ë§ (ì‚¬ì¥ë‹˜ JS í•¨ìˆ˜ í˜¸ì¶œ)
  const cart = makeCart('cart-box', 'total'); 
  cart.render();
  renderMenu('menu-grid', cart);

  // 4. ì§ì› í˜¸ì¶œ (ì‚¬ì¥ë‹˜ ì›ë³¸ ìœ ì§€)
  document.getElementById('call-btn').onclick = async () => {
    const remain = getCallRemainSec();
    if (remain > 0) return showToast(`ì§ì› í˜¸ì¶œì€ ${remain}ì´ˆ í›„ì— ë‹¤ì‹œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`,'info');
    const tableVal = document.getElementById('tableNo').value.trim();
    const note = document.getElementById('call-reason').value.trim();
    if (!tableVal) return showToast('í…Œì´ë¸” ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.','info');

    const r = await fetch('/api/call', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ storeId, table: tableVal, note })
    });
    if (r.ok) {
      localStorage.setItem(CALL_COOLDOWN_KEY, Date.now());
      document.getElementById('call-msg').textContent = 'ì§ì› í˜¸ì¶œì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.';
      setTimeout(() => { document.getElementById('call-msg').textContent = ''; }, 3000);
      updateCallButtonState();
      // ì•Œë¦¼ ì „ì†¡
      new BroadcastChannel('qrnr-admin').postMessage({ type: 'CALL', storeId, table: tableVal, note, ts: Date.now() });
    }
  };

  // í˜¸ì¶œ ì˜µì…˜ ë¡œë“œ (ì‚¬ì¥ë‹˜ ë¡œì§)
  (function loadOptions() {
    const select = document.getElementById('call-reason');
    const list = ['ë¬¼/ìˆ˜ì € ìš”ì²­', 'í…Œì´ë¸” ì •ë¦¬', 'ì£¼ë¬¸ ë¬¸ì˜', 'ì§ì› í˜¸ì¶œ'];
    select.innerHTML = list.map(opt => `<option value="${opt}">${opt}</option>`).join('');
  })();

  // 5. ì£¼ë¬¸í•˜ê¸° (ì‚¬ì¥ë‹˜ ì›ë³¸ ìœ ì§€ + ëª¨ë‹¬ ì—°ë™)
  document.getElementById('pay-btn').onclick = async (e) => {
    e.preventDefault();
    const table = document.getElementById('tableNo').value.trim();
    const inputCode = document.getElementById('paycode').value.trim();
    const pc = await fetch(`/api/payment-code?storeId=${storeId}`).then(r => r.json());
    
    if (!table) return showToast('í…Œì´ë¸” ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”','info');
    if (inputCode !== pc?.code) return showToast('ê²°ì œ ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤','info');
    if (!cart.items.length) return showToast('ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤','info');

    // í™•ì¸ ëª¨ë‹¬ ì—´ê¸°
    // confirm-items í…ìŠ¤íŠ¸ ìƒì„± ë¡œì§
    document.getElementById('confirm-items').textContent = cart.items.map(i => {
        let line = `${i.name} x${i.qty}`;
        if (i.optionText && i.optionText.length > 0) {
            const groups = {};
            i.optionText.forEach(t => {
                const [g, v] = t.split(':');
                if (!groups[g]) groups[g] = [];
                groups[g].push(v);
            });
            const optLine = Object.entries(groups)
                .map(([g, v]) => `   â”” ${g}: ${v.join(',')}`)
                .join('\n');
            line += `\n${optLine}`;
        }
        return line;
    }).join('\n');
    document.getElementById('confirm-total').textContent = cart.total().toLocaleString();
    document.getElementById('order-confirm-modal').style.display = 'flex';
  };

  document.getElementById('confirm-ok').onclick = async () => {
    const payload = {
      storeId,
      type: 'store',
      table: document.getElementById('tableNo').value,
      amount: cart.total(),
      cart: cart.items
    };
    const r = await fetch('/api/orders', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if ((await r.json()).ok) {
      document.getElementById('order-confirm-modal').style.display = 'none';
      document.getElementById('order-success-modal').style.display = 'flex';
    }
  };

  document.getElementById('confirm-cancel').onclick = () => document.getElementById('order-confirm-modal').style.display = 'none';
  document.getElementById('order-success-close').onclick = () => location.reload();
  // ğŸ”„ [ì‹¤ì‹œê°„ ë™ê¸°í™” ì¶”ê°€] ê´€ë¦¬ìê°€ ì„¤ì •ì„ ë°”ê¾¸ë©´ ì†ë‹˜ í™”ë©´ ìë™ ìƒˆë¡œê³ ì¹¨
  async function initRealtimeSync() {
    try {
        if (!window.supabase) {
            setTimeout(initRealtimeSync, 500);
            return;
        }

        const sid = window.qrnrStoreId || new URLSearchParams(location.search).get('store');
        if (!sid) return;

        const res = await fetch('/api/config');
        const { supabaseUrl, supabaseKey } = await res.json();
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        const channel = supabase.channel(`qrnr_realtime_${sid}`);
        
        channel.on('broadcast', { event: 'RELOAD_SIGNAL' }, async (payload) => {
            console.log("ğŸ”„ ê´€ë¦¬ì ìˆ˜ì • ì‹ í˜¸ ìˆ˜ì‹ :", payload);

            // 1. ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ (ì„ íƒ ì‚¬í•­)
            showToast("ğŸ“‹ ë©”ë‰´ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.", "info");

            // 2. [í•µì‹¬] ì„œë²„ì˜ DB ì²˜ë¦¬ê°€ ì™„ë£Œë  ì‹œê°„ì„ ì•„ì£¼ ì ê¹(0.3ì´ˆ) ê¸°ë‹¤ë¦° í›„ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            setTimeout(async () => {
                if (typeof renderMenu === 'function') {
                    // ì¥ë°”êµ¬ë‹ˆ(cart)ëŠ” ìœ ì§€í•˜ë©´ì„œ ë©”ë‰´íŒë§Œ ìƒˆë¡œ ê³ ì¹¨
                    await renderMenu('menu-grid', cart); 
                    console.log("âœ… ë©”ë‰´íŒ ë¶€ë¶„ ì—…ë°ì´íŠ¸ ì™„ë£Œ");
                }
            }, 300);
        })
        .subscribe((status) => {
            if (status === 'SUBSCRIBED') {
                console.log(`âœ… ì‹¤ì‹œê°„ ìˆ˜ì‹  ëŒ€ê¸° ì¤‘ (ì±„ë„: qrnr_realtime_${sid})`);
            }
        });
    } catch (e) {
        console.error("ì‹¤ì‹œê°„ ë™ê¸°í™” ì—ëŸ¬:", e);
    }
}

initRealtimeSync();
</script>
</body>
</html>
