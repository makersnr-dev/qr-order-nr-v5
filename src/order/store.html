<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>ë§¤ì¥ ì£¼ë¬¸</title>
    <link rel="stylesheet" href="/src/order/assets/css/style.css">
</head>
<body class="bg-dark">

<div id="toast-container" style="position:fixed; bottom:100px; left:50%; transform:translateX(-50%); z-index:10000; display:flex; flex-direction:column; gap:10px; width:80%; max-width:300px;"></div>

<div class="container" style="max-width: 600px; padding-bottom: 80px;">
    <header class="hstack" style="justify-content: space-between; padding: 16px 0; border-bottom: 1px solid #263241;">
        <div class="vstack">
            <h2 id="store-name-display" style="font-size: 20px;">ë§¤ì¥ ì •ë³´ ë¡œë”©ì¤‘...</h2>
            <span id="table-display" class="small" style="color: var(--primary); font-weight: 700;">í…Œì´ë¸” í™•ì¸ì¤‘</span>
        </div>
        <button id="btn-call" class="btn small" style="background: #1c2632; border: 1px solid #334155;">ì§ì› í˜¸ì¶œ</button>
    </header>

    <div id="menu-grid" class="vstack" style="gap: 12px; margin-top: 20px;"></div>
</div>

<div id="cart-bar" class="hstack" style="display:none; position: fixed; bottom: 0; left: 0; right: 0; background: #0b1620; padding: 16px; border-top: 1px solid #263241; justify-content: space-between; align-items: center; z-index: 999;">
    <div class="vstack">
        <span class="small" id="cart-count" style="opacity: 0.7;">0ê°œ ì„ íƒë¨</span>
        <span id="cart-total" style="font-size: 18px; font-weight: 700; color: var(--primary);">0ì›</span>
    </div>
    <button id="btn-order" class="btn primary" style="width: 140px; height: 48px; font-weight: 700;">ì£¼ë¬¸í•˜ê¸°</button>
</div>

<div id="call-modal" class="modal" style="display: none;">
    <div class="content vstack" style="max-width: 320px;">
        <h3 style="margin-bottom: 16px;">ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</h3>
        <div id="call-options" class="grid" style="gap: 8px; grid-template-columns: 1fr 1fr;"></div>
        <button id="call-close" class="btn" style="margin-top: 16px; width: 100%;">ë‹«ê¸°</button>
    </div>
</div>

<script type="module">
    import { currentStoreId, loadStoreInfo } from '/src/order/assets/js/modules/cust-store.js';
    import { renderMenu, renderOptionModal, calculateTotal } from '/src/order/assets/js/modules/menu-cart.js';

    const sid = currentStoreId();
    const urlParams = new URLSearchParams(location.search);
    const tableNo = urlParams.get('table') || 'ë¯¸ì§€ì •';
    let cart = [];

    // ğŸš€ ì„¸ë ¨ëœ í† ìŠ¤íŠ¸ í•¨ìˆ˜
    function showToast(msg) {
        const container = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.style.cssText = "background:rgba(0,0,0,0.85); color:#fff; padding:12px 20px; border-radius:30px; text-align:center; font-size:14px; border:1px solid #334155; animation: fadeInUp 0.3s;";
        t.textContent = msg;
        container.appendChild(t);
        setTimeout(() => {
            t.style.opacity = '0';
            t.style.transition = '0.5s';
            setTimeout(() => t.remove(), 500);
        }, 2000);
    }

    async function init() {
        const info = await loadStoreInfo();
        document.getElementById('store-name-display').textContent = info.name;
        document.getElementById('table-display').textContent = `${tableNo}ë²ˆ í…Œì´ë¸”`;

        await renderMenu('menu-grid', (item) => {
            renderOptionModal(item, (selectedItem, selectedOptions) => {
                addToCart(selectedItem, selectedOptions);
                showToast(`ğŸ›’ ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤.`);
            });
        });

        document.getElementById('btn-call').onclick = async () => {
            const res = await fetch(`/api/store-settings?storeId=${sid}`);
            const data = await res.json();
            const options = data.settings?.call_options || ['ë¬¼/ìˆ˜ì €', 'ì§ì› í˜¸ì¶œ'];
            
            const optBox = document.getElementById('call-options');
            optBox.innerHTML = options.map(opt => `<button class="btn small call-item" style="height:44px; background:#1c2632;">${opt}</button>`).join('');
            document.getElementById('call-modal').style.display = 'flex';

            optBox.querySelectorAll('.call-item').forEach(btn => {
                btn.onclick = async () => {
                    const note = btn.textContent;
                    const bc = new BroadcastChannel('qrnr-admin');
                    bc.postMessage({ type: 'CALL', storeId: sid, table: tableNo, note, at: Date.now() });
                    
                    await fetch('/api/call', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ storeId: sid, table: tableNo, note })
                    });

                    showToast(`ğŸ”” ${note} ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.`);
                    document.getElementById('call-modal').style.display = 'none';
                };
            });
        };

        document.getElementById('call-close').onclick = () => document.getElementById('call-modal').style.display = 'none';

        document.getElementById('btn-order').onclick = async () => {
            if (cart.length === 0) return;
            
            const res = await fetch('/api/orders', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ storeId: sid, type: 'store', table: tableNo, cart, amount: calculateTotal(cart), status: 'ì£¼ë¬¸ì ‘ìˆ˜' })
            });

            if (res.ok) {
                const bc = new BroadcastChannel('qrnr-admin');
                bc.postMessage({ type: 'NEW_ORDER', storeId: sid, table: tableNo, at: Date.now() });
                
                showToast('âœ… ì£¼ë¬¸ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤!');
                cart = [];
                updateCartBar();
            }
        };
    }

    function addToCart(item, options) {
        cart.push({ ...item, selectedOptions: options, qty: 1 });
        updateCartBar();
    }

    function updateCartBar() {
        const bar = document.getElementById('cart-bar');
        if (cart.length > 0) {
            bar.style.display = 'flex';
            document.getElementById('cart-count').textContent = `${cart.length}ê°œ ì„ íƒë¨`;
            document.getElementById('cart-total').textContent = `${calculateTotal(cart).toLocaleString()}ì›`;
        } else {
            bar.style.display = 'none';
        }
    }

    init();
</script>

<style>
@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
</body>
</html>
