<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <title>ë§¤ì¥ ì£¼ë¬¸</title>
</head>

<body data-store-id="">
<div class="container">
  <h1>QR Order - ì£¼ë¬¸</h1>

  <!-- í…Œì´ë¸” / ê²°ì œ ì½”ë“œ -->
  <div class="card vstack">
    <div class="hstack" style="gap:12px;flex-wrap:wrap">
      <div class="vstack" style="min-width:220px;flex:1">
        <label class="small">í…Œì´ë¸”</label>
        <input id="tableNo" class="input" placeholder="ì˜ˆ: 12">
      </div>
      <div class="vstack" style="min-width:220px;flex:1">
        <label class="small">ì˜¤ëŠ˜ì˜ ê²°ì œ ì½”ë“œ</label>
        <input id="paycode" class="input" placeholder="ê´€ë¦¬ìì—ê²Œ ë°›ì€ 4ìë¦¬">
      </div>
    </div>
  </div>

  <!-- ì§ì› í˜¸ì¶œ -->
  <div class="card vstack">
    <h3>ì§ì› í˜¸ì¶œ</h3>
    <div class="hstack" style="gap:8px;flex-wrap:wrap">
      <select id="call-reason" class="input" style="max-width:240px"></select>
      <button id="call-btn" class="btn">ì§ì› í˜¸ì¶œ</button>
    </div>
    <div id="call-msg" class="small"></div>
  </div>

  <!-- ë©”ë‰´ -->
  <div class="card vstack">
    <h3>ë©”ë‰´</h3>
    <div id="menu-grid" class="hstack" style="gap:12px;flex-wrap:wrap"></div>
  </div>

  <!-- ì¥ë°”êµ¬ë‹ˆ -->
  <div class="card vstack">
    <h3>ì¥ë°”êµ¬ë‹ˆ</h3>
    <div id="cart-box" class="vstack"></div>
  </div>

  <!-- í•©ê³„ / ì£¼ë¬¸ -->
  <div class="card hstack" style="justify-content:space-between;align-items:center">
    <div>í•©ê³„: <b id="total">0</b>ì›</div>
    <button id="pay-btn" class="btn primary">ì£¼ë¬¸í•˜ê¸°</button>
  </div>

  <div class="small" style="color:#9ca3af;margin-top:6px">
    ì£¼ë¬¸ ì ‘ìˆ˜ í›„ ì¹´ìš´í„°ì—ì„œ ê²°ì œë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.
  </div>
</div>

<!-- ì£¼ë¬¸ ì™„ë£Œ ëª¨ë‹¬ -->
<div id="order-success-modal"
     style="
       display:none;
       position:fixed;
       inset:0;
       background:rgba(0,0,0,.45);
       z-index:1000;
       align-items:center;
       justify-content:center;
     ">
  <div style="
    background:#0d1117;
    color:#fff;
    padding:24px;
    border-radius:16px;
    width:90%;
    max-width:360px;
    text-align:center;
  ">
    <h3 style="margin-bottom:12px">ì£¼ë¬¸ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤</h3>
    <p style="font-size:14px;color:#9ca3af;line-height:1.5">
      ì¹´ìš´í„°ì—ì„œ ê²°ì œë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.
    </p>

    <button id="order-success-close"
            class="btn primary"
            style="margin-top:20px;width:100%">
      í™•ì¸
    </button>
  </div>
</div>

<!-- ì£¼ë¬¸ í™•ì¸ ëª¨ë‹¬ (ë§¤ì¥ ì£¼ë¬¸ìš©) -->
<div id="order-confirm-modal"
     style="
       display:none;
       position:fixed;
       inset:0;
       background:rgba(0,0,0,.45);
       z-index:1000;
       align-items:center;
       justify-content:center;
     ">
  <div style="
    background:#0d1117;
    color:#fff;
    padding:20px;
    border-radius:16px;
    width:90%;
    max-width:420px;
  ">
    <h3>ì£¼ë¬¸ í™•ì¸</h3>

    <pre id="confirm-items"
         style="white-space:pre-wrap;font-size:13px"></pre>

    <div style="margin-top:10px">
      í•©ê³„: <b id="confirm-total"></b>ì›
    </div>

    <div style="display:flex;gap:8px;margin-top:16px">
      <button id="confirm-cancel" class="btn" style="flex:1">ì·¨ì†Œ</button>
      <button id="confirm-ok" class="btn primary" style="flex:1">í™•ì¸</button>
    </div>
  </div>
</div>


<script type="module">
  import { renderMenu, makeCart } from '/src/order/assets/js/modules/menu-cart.js';
  import { get, patch } from '/src/order/assets/js/modules/cust-store.js';
  import { ensureStoreInitialized } from '/src/shared/store.js';
  import { getPaymentCode } from '/src/admin/assets/js/modules/store.js';

  function showToast(msg, variant = "info") {
    const t = document.createElement('div');
    t.className = `toast show toast-${variant}`;
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => {
      t.classList.remove('show');
      setTimeout(() => t.remove(), 200);
    }, 3000);
  }

    showToast("ì–´ì„œì˜¤ì„¸ìš”!", "success");
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì§ì› í˜¸ì¶œ ì¿¨íƒ€ì„ ì„¤ì • (ì´ˆ)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const CALL_COOLDOWN_SEC = 10;
  const CALL_COOLDOWN_KEY = 'qrnr.call.cooldown';
  function getCallRemainSec() {
    const last = Number(localStorage.getItem(CALL_COOLDOWN_KEY) || 0);
    const diff = Math.floor((Date.now() - last) / 1000);
    return Math.max(0, CALL_COOLDOWN_SEC - diff);
  }
  function updateCallButtonState() {
    const btn = document.getElementById('call-btn');
    const msgEl = document.getElementById('call-msg');
    if (!btn) return;
  
    const remain = getCallRemainSec();
  
    if (remain > 0) {
      btn.disabled = true;
      btn.textContent = `ì§ì› í˜¸ì¶œ (${remain}s)`;
      if (msgEl) msgEl.textContent = `ì ì‹œ í›„ ë‹¤ì‹œ í˜¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (${remain}ì´ˆ)`;
    } else {
      btn.disabled = false;
      btn.textContent = 'ì§ì› í˜¸ì¶œ';
      if (msgEl) msgEl.textContent = '';
    }
  }


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // storeId ì´ˆê¸°í™”
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const storeId = ensureStoreInitialized();
  window.qrnrStoreId = storeId;
  loadCallOptions();
  // â± í˜¸ì¶œ ë²„íŠ¼ ì¿¨íƒ€ì„ ê°±ì‹  ë£¨í”„
  setInterval(updateCallButtonState, 1000);
  updateCallButtonState();

  document.body.dataset.storeId = storeId;

  const url = new URL(location.href);
  const tableParam = url.searchParams.get('table') || '';
  const tableInput = document.getElementById('tableNo');
  if (tableParam && tableInput) tableInput.value = tableParam;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì¥ë°”êµ¬ë‹ˆ & ë©”ë‰´
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const cart = makeCart('cart-box', 'total');
  cart.render();
  renderMenu('menu-grid', cart);

  function clearCart() {
    cart.items.length = 0;
    cart.render();
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì§ì› í˜¸ì¶œ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  const callBtn = document.getElementById('call-btn');
  function getAdminCallOptions(storeId) {
    return get(['admin', 'callOptions', storeId]) || [];
  }


  function loadCallOptions() {
  const select = document.getElementById('call-reason');
  if (!select) return;

  const storeId = window.qrnrStoreId || 'store1';

  // âœ… ê´€ë¦¬ì ì„¤ì •ì—ì„œ í˜¸ì¶œ í•­ëª© ì½ê¸°
  let list = getAdminCallOptions(storeId);

  // ê¸°ë³¸ê°’ (ê´€ë¦¬ìê°€ ì•„ì§ ì„¤ì • ì•ˆ í–ˆì„ ë•Œ)
  if (!Array.isArray(list) || !list.length) {
    list = ['ë¬¼/ìˆ˜ì € ìš”ì²­', 'í…Œì´ë¸” ì •ë¦¬', 'ì£¼ë¬¸ ë¬¸ì˜'];
  }

  select.innerHTML = `
    <option value="">ì„ íƒ ì—†ìŒ</option>
    ${list.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
  `;
}




if (callBtn) {
  callBtn.onclick = async () => {

    // â›” ì¿¨íƒ€ì„ ì²´í¬
    const remain = getCallRemainSec();
    if (remain > 0) {
      showToast(`ì§ì› í˜¸ì¶œì€ ${remain}ì´ˆ í›„ì— ë‹¤ì‹œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`, "info");
      return;
    }

    const tableVal = (document.getElementById('tableNo')?.value || '').trim();
    const note = (document.getElementById('call-reason')?.value || '').trim();

    if (!tableVal) {
      showToast('í…Œì´ë¸” ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', "info");
      return;
    }

    try {
      const r = await fetch('/api/call', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ storeId, table: tableVal, note })
      });

      const j = await r.json();
      if (!j.ok) throw new Error();

      // âœ… ì¿¨íƒ€ì„ ì‹œì‘
      localStorage.setItem(CALL_COOLDOWN_KEY, Date.now());

      const statKey = `qrnr.call.stat.${storeId}`;
      const today = new Date().toISOString().slice(0,10);
      const stat = JSON.parse(localStorage.getItem(statKey) || '{}');
      
      stat[today] = (stat[today] || 0) + 1;
      localStorage.setItem(statKey, JSON.stringify(stat));


      // âœ… ê´€ë¦¬ì ì•Œë¦¼
      const channel = new BroadcastChannel('qrnr-admin');
      channel.postMessage({
        type: 'CALL',
        storeId,
        table: tableVal,
        note,
        ts: Date.now()
      });

      const msgEl = document.getElementById('call-msg');
      msgEl.textContent = 'ğŸ”” ì§ì› í˜¸ì¶œì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.';
      msgEl.style.opacity = '1';

      setTimeout(() => {
        msgEl.style.opacity = '0';
        setTimeout(() => {
          msgEl.textContent = '';
          msgEl.style.opacity = '1';
        }, 300);
      }, 2000);

      // ğŸ” ë²„íŠ¼ ìƒíƒœ ì¦‰ì‹œ ê°±ì‹ 
      updateCallButtonState();

    } catch (e) {
      showToast('ì§ì› í˜¸ì¶œ ì‹¤íŒ¨', "error");
      console.error(e);
    }
  };
}



  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ìœ í‹¸
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function currentTable() {
    return (document.getElementById('tableNo')?.value || '').trim();
  }

  function getPayCode() {
  try {
    const storeId = window.qrnrStoreId;
    const pc = getPaymentCode(storeId);
    return pc?.code || '';
  } catch {
    return '';
  }
}




  function totalAmountFromCart() {
    return cart.items.reduce(
      (sum, i) => sum + Number(i.price || 0) * Number(i.qty || 1),
      0
    );
  }

  



  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì£¼ë¬¸ ì™„ë£Œ ëª¨ë‹¬
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openOrderConfirmModal(items, amount) {
  document.getElementById('confirm-items').textContent =
    items.map(i => {
      let line = `${i.name} x${i.qty}`;
      if (Array.isArray(i.options) && i.options.length) {
  const optText = i.options
    .map(o => {
      const group = o.group || o.name || 'ì˜µì…˜';
      const label = o.label || o.value || '';
      return label ? `${group}:${label}` : group;
    });

  line += '\n' + optText.map(t => ` â”” ${t}`).join('\n');
}

      return line;
    }).join('\n\n');

  document.getElementById('confirm-total').textContent =
    amount.toLocaleString();

  document.getElementById('order-confirm-modal').style.display = 'flex';
}

function closeOrderConfirmModal() {
  document.getElementById('order-confirm-modal').style.display = 'none';
}

  function openOrderSuccessModal() {
    document.getElementById('order-success-modal').style.display = 'flex';
  }

  function closeOrderSuccessModal() {
    document.getElementById('order-success-modal').style.display = 'none';
  }

  document.getElementById('order-success-close').onclick = () => {
    closeOrderSuccessModal();
    clearCart();
  };

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì£¼ë¬¸í•˜ê¸° (POS ê²°ì œ ë°©ì‹)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('pay-btn').onclick = (e) => {
  e.preventDefault();

  const table = currentTable();
  const inputCode = document.getElementById('paycode').value.trim();
  const expectedCode = getPayCode();
  const items = cart.items;
  const amount = cart.total();


  if (!table) return showToast('í…Œì´ë¸” ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', "info");
  if (inputCode !== expectedCode) return showToast('ê²°ì œ ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤', "info");
  if (!items.length) return showToast('ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤', "info");

  // ğŸ”¥ ì—¬ê¸°ì„œ ì£¼ë¬¸ ì•ˆ ë³´ëƒ„
  openOrderConfirmModal(items, amount);
};
document.getElementById('confirm-ok').onclick = async () => {
  closeOrderConfirmModal();

  const items = cart.items;
  const amount = cart.total();

  const table = currentTable();

 
  const orderName =
    items.map(i => `${i.name}x${i.qty}`).join(', ').slice(0, 48) || 'ë§¤ì¥ì£¼ë¬¸';

  const payload = {
  
  storeId,
  orderType: 'store',
  //status: 'WAIT_PAY',
  table,
  amount: cart.total(),

  items: cart.items.map(i => ({
    id: i.id,
    name: i.name,
    qty: i.qty,
    unitPrice: i.price,
    options: Array.isArray(i.options) ? i.options : []
  })),

  //createdAt: Date.now()
};


  const r = await fetch('/api/orders', {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify(payload)
  });

  const j = await r.json();
  if (!j.ok) return showToast('ì£¼ë¬¸ ì €ì¥ ì‹¤íŒ¨', "error");
  
  // ğŸ”” ê´€ë¦¬ì ì•Œë¦¼ (ë§¤ì¥ ì£¼ë¬¸)
  try {
    const channel = new BroadcastChannel('qrnr-admin');
    channel.postMessage({
      type: 'NEW_ORDER',
      orderType: 'store',        // â­ ë§¤ì¥ ì£¼ë¬¸
      storeId,
      table: table || null,
      amount: amount || 0,
      ts: Date.now()
    });
  } catch (e) {
    console.error('[store] admin notify error', e);
  }

  
  openOrderSuccessModal();
};

document.getElementById('confirm-cancel').onclick = closeOrderConfirmModal;


</script>
</body>
</html>
