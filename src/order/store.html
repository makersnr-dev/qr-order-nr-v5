
<!doctype html><html lang="ko"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="stylesheet" href="/src/admin/assets/css/style.css"/><title>ë§¤ì¥ ì£¼ë¬¸</title></head><body>
<div class="container">
  <h1>QR Order - ì£¼ë¬¸</h1>
  <div class="card vstack">
    <div class="hstack" style="gap:12px;flex-wrap:wrap">
      <div class="vstack" style="min-width:220px;flex:1"><label class="small">í…Œì´ë¸”</label><input id="tableNo" class="input" placeholder="ì˜ˆ: 12"></div>
      <div class="vstack" style="min-width:220px;flex:1"><label class="small">ì˜¤ëŠ˜ì˜ ê²°ì œ ì½”ë“œ</label><input id="paycode" class="input" placeholder="ê´€ë¦¬ìì—ê²Œ ë°›ì€ 4ìë¦¬"></div>
    </div>
  </div>
  <div class="card vstack"><h3>ì§ì› í˜¸ì¶œ</h3>
    <div class="hstack" style="gap:8px;flex-wrap:wrap"><select id="call-reason" class="input" style="max-width:240px"><option>ì„ íƒ ì—†ìŒ</option><option>ë¬¼/ìˆ˜ì € ìš”ì²­</option><option>í…Œì´ë¸” ì •ë¦¬</option><option>ì£¼ë¬¸ ë¬¸ì˜</option></select><button id="call-btn" class="btn">ì§ì› í˜¸ì¶œ</button></div>
    <div id="call-msg" class="small"></div>
  </div>
  <div class="card vstack"><h3>ë©”ë‰´</h3><div id="menu-grid" class="hstack" style="gap:12px;flex-wrap:wrap"></div></div>
  <div class="card vstack"><h3>ì¥ë°”êµ¬ë‹ˆ</h3><div id="cart-box" class="vstack"></div></div>
  <div class="card hstack" style="justify-content:space-between"><div>í•©ê³„: <b id="total">0</b>ì›</div><button id="pay-btn" class="btn primary">ê²°ì œí•˜ê¸°</button></div>
</div>

    <script type="module">
      import { setPendingOrder, startPayment } from '/src/shared/toss-client.js';
      function totalAmount(){
        const el = document.querySelector('[data-total]') || document.getElementById('total');
        const v = el ? (el.getAttribute('data-total') || el.textContent || '0') : '0';
        return Number(String(v).replace(/[^0-9.-]/g,'')) || 0;
      }
      function buildCart(){
        const items = [];
        document.querySelectorAll('[data-cart-item]').forEach(row=>{
          const name = row.getAttribute('data-name') || row.querySelector('.name')?.textContent || 'ë©”ë‰´';
          const qty = Number(row.getAttribute('data-qty') || row.querySelector('.qty')?.textContent || 1);
          const price = Number(row.getAttribute('data-price') || row.querySelector('.price')?.textContent || 0);
          items.push({ name, qty, price });
        });
        return items;
      }
      function customerInfo(){
        const info={};
        // common fields if exist
        const fields={ 
          name: '#custName,#name', 
          phone: '#custPhone,#phone', 
          addr: '#custAddr,#address', 
          req: '#custNote,#request'
        };
        Object.entries(fields).forEach(([k,sel])=>{
          const el=document.querySelector(sel);
          if(el) info[k]=el.value||el.textContent||'';
        });
        return info;
      }
      function currentTable(){
        const url = new URL(location.href);
        return url.searchParams.get('table');
      }
      function bindPay(){
  const btn =
    document.getElementById('pay-btn') ||    // ğŸ”´ ì‹¤ì œ ë²„íŠ¼ id
    document.getElementById('payBtn')  ||    // ì˜ˆë¹„ í˜¸í™˜
    document.querySelector('[data-action="pay"]') ||
    document.querySelector('.btn-pay, button.pay');

  if (!btn) return;

  btn.addEventListener('click', async (e) => {
    e.preventDefault();
    const orderId = 'ORD-' + Date.now();
    const amount = totalAmount();
    const orderName = document.title || 'ì£¼ë¬¸';
    const payload = {
      type: 'store',
      amount,
      orderName,
      cart: buildCart(),
      customer: customerInfo(),
      table: currentTable()
    };
    setPendingOrder(payload);                          // âœ… ì—¬ê¸°ì„œ pending ì €ì¥
    try {
      await startPayment({ orderId, amount, orderName });  // âœ… toss-client ê³µí†µ ë¡œì§
    } catch (err) {
      console.error('payment start error', err);
      alert('ê²°ì œë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
  });
}

      bindPay();
    </script>
  <script>
  (function () {
    try {
      const params = new URLSearchParams(location.search);
      const t = params.get('table');
      if (!t) return;
      const input = document.getElementById('tableNo');
      if (!input) return;
      input.value = t;
      // input.readOnly = true; // ì›í•˜ë©´ ì ê¸ˆ
    } catch (e) {
      console.error(e);
    }
  })();
</script>

    </body></html>
