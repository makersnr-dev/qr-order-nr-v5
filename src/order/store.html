
<!doctype html><html lang="ko"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="stylesheet" href="/src/admin/assets/css/style.css"/><title>ë§¤ì¥ ì£¼ë¬¸</title></head><body>
<div class="container">
  <h1>QR Order - ì£¼ë¬¸</h1>
  <div class="card vstack">
    <div class="hstack" style="gap:12px;flex-wrap:wrap">
      <div class="vstack" style="min-width:220px;flex:1"><label class="small">í…Œì´ë¸”</label><input id="tableNo" class="input" placeholder="ì˜ˆ: 12"></div>
      <div class="vstack" style="min-width:220px;flex:1"><label class="small">ì˜¤ëŠ˜ì˜ ê²°ì œ ì½”ë“œ</label><input id="paycode" class="input" placeholder="ê´€ë¦¬ìì—ê²Œ ë°›ì€ 4ìë¦¬"></div>
    </div>
  </div>
  <div class="card vstack"><h3>ì§ì› í˜¸ì¶œ</h3>
    <div class="hstack" style="gap:8px;flex-wrap:wrap"><select id="call-reason" class="input" style="max-width:240px"><option>ì„ íƒ ì—†ìŒ</option><option>ë¬¼/ìˆ˜ì € ìš”ì²­</option><option>í…Œì´ë¸” ì •ë¦¬</option><option>ì£¼ë¬¸ ë¬¸ì˜</option></select><button id="call-btn" class="btn">ì§ì› í˜¸ì¶œ</button></div>
    <div id="call-msg" class="small"></div>
  </div>
  <div class="card vstack"><h3>ë©”ë‰´</h3><div id="menu-grid" class="hstack" style="gap:12px;flex-wrap:wrap"></div></div>
  <div class="card vstack"><h3>ì¥ë°”êµ¬ë‹ˆ</h3><div id="cart-box" class="vstack"></div></div>
  <div class="card hstack" style="justify-content:space-between"><div>í•©ê³„: <b id="total">0</b>ì›</div><button id="pay-btn" class="btn primary">ê²°ì œí•˜ê¸°</button></div>
</div>
<script type="module">
import {renderMenu, makeCart} from '/src/order/assets/js/modules/menu-cart.js';
import {get, patch} from '/src/order/assets/js/modules/cust-store.js';
const url=new URL(location.href); const t=url.searchParams.get('table'); if(t) document.getElementById('tableNo').value=t;
const cart=makeCart('cart-box','total'); cart.render(); renderMenu('menu-grid', cart);
document.getElementById('call-btn').onclick=()=>{
  const reason=document.getElementById('call-reason').value; const table=document.getElementById('tableNo').value.trim()||'-';
  patch(['admin','ordersStore'], arr=>{ arr=[...(arr||[])]; arr.push({type:'CALL', time:new Date().toISOString(), table, items:[], total:0, status:'ëŒ€ê¸°', note:reason}); return arr; });
  document.getElementById('call-msg').textContent='í˜¸ì¶œ ì „ì†¡ë¨ (ê´€ë¦¬ì í˜ì´ì§€ì— ì•Œë¦¼)';
};

document.getElementById('pay-btn').onclick=async()=>{
// âœ… ì¹´ë“œ ê²°ì œ ë°”ë¡œ ì§„ì… ê°•ì œ ë²„ì „
const table = document.getElementById('tableNo')?.value.trim() || '';
const code  = document.getElementById('paycode')?.value.trim() || '';
const pc    = (typeof get === 'function' ? (get(['admin','paymentCode']) || { code: '7111' }) : { code: '7111' });

if (!table) { alert('í…Œì´ë¸” ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
if (code !== pc.code) { alert('ê²°ì œ ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤'); return; }
if (!cart?.items?.length) { alert('ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤'); return; }

const total = cart.items.reduce((s, i) => s + Number(i.price || 0) * Number(i.qty || 1), 0);
const orderId   = 'S' + Date.now();
const orderName = (cart.items.map(i => `${i.name}x${i.qty}`).join(', ').slice(0,48)) || 'ë§¤ì¥ì£¼ë¬¸';

// ì„±ê³µ í˜ì´ì§€ì—ì„œ ì €ì¥ìš©(ê´€ë¦¬ìí˜ì´ì§€ ì ì¬ìš©)
sessionStorage.setItem('qrnr.lastOrder', JSON.stringify({
  kind: 'store',
  payload: { type:'STORE', time:new Date().toISOString(), table, items:cart.items, total, status:'ëŒ€ê¸°' }
}));

// ğŸ”’ í˜¹ì‹œ ë‚¨ì•„ìˆëŠ” ìœ„ì ¯ UI/ì½”ë“œê°€ ê²°ì œìˆ˜ë‹¨ ì„ íƒ í™”ë©´ì„ ë„ìš°ëŠ” ê±¸ ë§‰ê¸°
try {
  // 1) ìœ„ì ¯ì´ ë Œë”ë˜ëŠ” ì»¨í…Œì´ë„ˆ ì œê±° (ìˆì„ ê²½ìš°)
  document.querySelectorAll('#payment-widget, #paymentMethods').forEach(el => el.remove());
  // 2) ìœ„ì ¯ ìŠ¤í¬ë¦½íŠ¸ê°€ ë¡œë“œë˜ì–´ ìˆì–´ë„ ì‚¬ìš©í•˜ì§€ ì•Šë„ë¡ ë³´ì¥
  //    (PaymentWidget ì „ì—­ì€ ë¬´ì‹œí•˜ê³  TossPaymentsë§Œ ì‚¬ìš©)
} catch(_) {}

// 1) í´ë¼ì´ì–¸íŠ¸ í‚¤
const { tossClientKey } = await fetch('/api/config', { cache: 'no-store' }).then(r => r.json());
if (!tossClientKey) { alert('TOSS_CLIENT_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return; }

// 2) v1/payment SDK ë¡œë“œ(ì¤‘ë³µ ë°©ì§€) â€” ìœ„ì ¯ ì•„ë‹˜!
if (!window.TossPayments) {
  await new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = 'https://js.tosspayments.com/v1/payment';
    s.onload = resolve;
    s.onerror = reject;
    document.head.appendChild(s);
  });
}

// 3) ì¸ìŠ¤í„´ìŠ¤ ìƒì„± (ìœ„ì ¯ ëŒ€ì‹  v1/payment)
const payments = window.TossPayments(tossClientKey);

// 4) ğŸš€ ì¹´ë“œ ê²°ì œ í™”ë©´ìœ¼ë¡œ ë°”ë¡œ ì§„ì… (ê²°ì œìˆ˜ë‹¨ ì„ íƒ ë‹¨ê³„ ìŠ¤í‚µ)
await payments.requestPayment({
  method: 'CARD', // ì¹´ë“œ ì§í–‰
  amount: Number(total),
  orderId,
  orderName,
  successUrl: `${location.origin}/toss/success?orderId=${encodeURIComponent(orderId)}&amount=${encodeURIComponent(total)}`,
  failUrl:    `${location.origin}/toss/fail?orderId=${encodeURIComponent(orderId)}`
});


};
</script>
    <script type="module">
      import { setPendingOrder, startPayment } from '/src/shared/toss-client.js';
      function totalAmount(){
        const el = document.querySelector('[data-total]') || document.getElementById('total');
        const v = el ? (el.getAttribute('data-total') || el.textContent || '0') : '0';
        return Number(String(v).replace(/[^0-9.-]/g,'')) || 0;
      }
      function buildCart(){
        const items = [];
        document.querySelectorAll('[data-cart-item]').forEach(row=>{
          const name = row.getAttribute('data-name') || row.querySelector('.name')?.textContent || 'ë©”ë‰´';
          const qty = Number(row.getAttribute('data-qty') || row.querySelector('.qty')?.textContent || 1);
          const price = Number(row.getAttribute('data-price') || row.querySelector('.price')?.textContent || 0);
          items.push({ name, qty, price });
        });
        return items;
      }
      function customerInfo(){
        const info={};
        // common fields if exist
        const fields={ 
          name: '#custName,#name', 
          phone: '#custPhone,#phone', 
          addr: '#custAddr,#address', 
          req: '#custNote,#request'
        };
        Object.entries(fields).forEach(([k,sel])=>{
          const el=document.querySelector(sel);
          if(el) info[k]=el.value||el.textContent||'';
        });
        return info;
      }
      function currentTable(){
        const url = new URL(location.href);
        return url.searchParams.get('table');
      }
      function bindPay(){
        const btn = document.getElementById('payBtn') || document.querySelector('[data-action="pay"]') || document.querySelector('.btn-pay, button.pay');
        if(!btn) return;
        btn.addEventListener('click', async (e)=>{
          e.preventDefault();
          const orderId = 'ORD-' + Date.now();
          const amount = totalAmount();
          const orderName = document.title || 'ì£¼ë¬¸';
          const payload = {
            type: 'store', amount, orderName, cart: buildCart(), 
            customer: customerInfo(), table: currentTable()
          };
          setPendingOrder(payload);
          try { await startPayment({orderId, amount, orderName}); }
          catch(err){ console.error('payment start error', err); alert('ê²°ì œë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); }
        });
      }
      bindPay();
    </script>
    </body></html>
