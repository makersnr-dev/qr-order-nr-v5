<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <title>매장 주문</title>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <link rel="stylesheet" href="/src/order/assets/css/order-common.css"/>
  <style>
/* 매장 주문 페이지만의 특수 스타일 (필요 시 추가) */
    .large-total { font-size: 1.2rem; color: var(--primary); font-weight: bold; }
    #confirm-items { 
        white-space: pre-wrap; font-size: 13px; background: #161b22; 
        padding: 10px; border-radius: 8px; margin: 10px 0; 
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body data-store-id="">
<div class="container">
  <h1>QR Order - 주문</h1>

  <div class="card vstack">
    <div class="hstack" style="gap:12px;flex-wrap:wrap">
      <div class="vstack" style="min-width:220px;flex:1">
        <label class="small">테이블</label>
        <input id="tableNo" class="input" placeholder="예: 12">
      </div>
      <div class="vstack" style="min-width:220px;flex:1">
        <label class="small">오늘의 결제 코드</label>
        <input id="paycode" class="input" placeholder="관리자에게 받은 4자리">
      </div>
    </div>
  </div>

  <div class="card vstack">
    <h3>직원 호출</h3>
    <div class="hstack" style="gap:8px;flex-wrap:wrap">
      <select id="call-reason" class="input" style="max-width:240px"></select>
      <button id="call-btn" class="btn">직원 호출</button>
    </div>
    <div id="call-msg" class="small" style="color:var(--primary); margin-top:8px"></div>
  </div>

  <div class="card vstack">
    <h3>메뉴</h3>
    <div id="menu-grid"></div>
  </div>

  <div class="card vstack">
    <h3>장바구니</h3>
    <div id="cart-box" class="vstack" style="gap:10px; margin: 10px 0;"></div>
  </div>

  <div class="card hstack" style="justify-content:space-between;align-items:center; margin-bottom:100px;">
    <div>합계: <b id="total" style="color:var(--primary); font-size:1.2rem;">0</b>원</div>
    <button id="pay-btn" class="btn primary large">주문하기</button>
  </div>

  <div class="small" style="color:#9ca3af;margin-top:6px; text-align:center;">
    주문 접수 후 카운터에서 결제를 진행해주세요.
  </div>
</div>

<div id="option-modal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
  <div class="content" style="background:#fff; padding:20px; border-radius:12px; width:90%; max-width:400px; color:#333;">
    <h3 id="opt-menu-name">옵션 선택</h3>
    <div id="opt-container" class="vstack" style="margin:15px 0"></div>
    <div class="hstack" style="gap:8px">
      <button id="opt-close" class="btn" style="flex:1">취소</button>
      <button id="opt-add-cart" class="btn primary" style="flex:1">장바구니 담기</button>
    </div>
  </div>
</div>

<div id="order-confirm-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:#0d1117; color:#fff; padding:20px; border-radius:16px; width:90%; max-width:420px;">
    <h3>주문 확인</h3>
    <pre id="confirm-items" style="white-space:pre-wrap;font-size:13px; background:#161b22; padding:10px; border-radius:8px; margin:10px 0;"></pre>
    <div style="margin-top:10px">합계: <b id="confirm-total"></b>원</div>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button id="confirm-cancel" class="btn" style="flex:1">취소</button>
      <button id="confirm-ok" class="btn primary" style="flex:1">확인</button>
    </div>
  </div>
</div>

<div id="order-success-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:#0d1117; color:#fff; padding:24px; border-radius:16px; width:90%; max-width:360px; text-align:center;">
    <h3 style="margin-bottom:12px">주문이 접수되었습니다</h3>
    <p style="font-size:14px;color:#9ca3af;line-height:1.5">카운터에서 결제를 진행해주세요.</p>
    <button id="order-success-close" class="btn primary" style="margin-top:20px;width:100%">확인</button>
  </div>
</div>

<script type="module">
  import { renderMenu, makeCart } from '/src/order/assets/js/modules/menu-cart.js';
  import { loadStoreInfo, currentStoreId } from '/src/order/assets/js/modules/cust-store.js';
  import { ensureStoreInitialized } from '/src/shared/store.js';
 
  /**
 * 표준 토스트 알림 함수
 * @param {string} msg - 표시할 메시지
 * @param {string} variant - 'info', 'success', 'error' (색상 구분용)
 */
export function showToast(msg, variant = 'info') {
  const t = document.createElement('div');
  
  // 기본 클래스는 toast, 상태에 따라 클래스 추가 (예: toast-success)
  t.className = `toast toast-${variant}`; 
  t.textContent = msg;
  
  document.body.appendChild(t);

  // 브라우저가 요소를 인식한 직후에 'show' 클래스 추가 (애니메이션 시작)
  requestAnimationFrame(() => t.classList.add('show'));

  // 3초 후 사라짐
  setTimeout(() => {
    t.classList.remove('show');
    // 애니메이션(0.2초)이 끝난 후 요소 삭제
    setTimeout(() => t.remove(), 200);
  }, 3000);
}
  // 1. 직원 호출 쿨타임 로직 (사장님 원본 유지)
  const CALL_COOLDOWN_SEC = 10;
  const CALL_COOLDOWN_KEY = 'qrnr.call.cooldown';
  function getCallRemainSec() {
    const last = Number(localStorage.getItem(CALL_COOLDOWN_KEY) || 0);
    const diff = Math.floor((Date.now() - last) / 1000);
    return Math.max(0, CALL_COOLDOWN_SEC - diff);
  }
  function updateCallButtonState() {
    const btn = document.getElementById('call-btn');
    const msgEl = document.getElementById('call-msg');
    if (!btn) return;
    const remain = getCallRemainSec();
    if (remain > 0) {
      btn.disabled = true;
      btn.textContent = `직원 호출 (${remain}s)`;
    } else {
      btn.disabled = false;
      btn.textContent = '직원 호출';
    }
  }

  // 2. 초기화
  const storeId = ensureStoreInitialized();
  window.qrnrStoreId = storeId;
  document.body.dataset.storeId = storeId;
  setInterval(updateCallButtonState, 1000);
  updateCallButtonState();

  // 테이블 번호 자동입력
  const tableParam = new URLSearchParams(location.search).get('table') || '';
  if (tableParam) document.getElementById('tableNo').value = tableParam;

  // 3. 장바구니 & 메뉴 렌더링 (사장님 JS 함수 호출)
  const cart = makeCart('cart-box', 'total'); 
  cart.render();
  renderMenu('menu-grid', cart);

  // 4. 직원 호출 (사장님 원본 유지)
  // 전역 변수로 선언하여 중복 생성을 방지합니다.
  let globalSupabase = null;
  let globalChannel = null;
  
  async function getSupabase() {
      if (globalSupabase) return { supabase: globalSupabase, channel: globalChannel };
  
      const configRes = await fetch('/api/config');
      const { supabaseUrl, supabaseKey } = await configRes.json();
      
      // 클라이언트를 딱 한 번만 만듭니다. (중복 인스턴스 경고 해결)
      globalSupabase = window.supabase.createClient(supabaseUrl, supabaseKey);
      globalChannel = globalSupabase.channel(`qrnr_realtime_${window.qrnrStoreId}`);
      
      // 채널 구독을 미리 완료해둡니다.
      globalChannel.subscribe();
      
      return { supabase: globalSupabase, channel: globalChannel };
  }
  
  document.getElementById('call-btn').onclick = async () => {
    const remain = getCallRemainSec();
    if (remain > 0) return showToast(`직원 호출은 ${remain}초 후에 다시 가능합니다.`, 'info');
    
    const tableVal = document.getElementById('tableNo').value.trim();
    const note = document.getElementById('call-reason').value.trim();
    if (!tableVal) return showToast('테이블 번호를 입력하세요.', 'info');

    // 1. DB 저장 (기존 유지)
    const r = await fetch('/api/call', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ storeId: window.qrnrStoreId, table: tableVal, note })
    });

    if (r.ok) {
    const { channel } = await getSupabase(); // 이미 만들어진 채널 사용
    
    localStorage.setItem(CALL_COOLDOWN_KEY, Date.now());
    document.getElementById('call-msg').textContent = '직원 호출이 전달되었습니다.';
    
    // 이 한 번의 send로 관리자에게 즉시 전달됩니다.
    await channel.send({
        type: 'broadcast',
        event: 'NEW_CALL',
        payload: { 
            table_no: tableVal, 
            note: note,
            at: new Date().toISOString()
        }
    });
    const msgEl = document.getElementById('call-msg');
    if (msgEl) {
        msgEl.textContent = '직원 호출이 전달되었습니다.';
        
        // 기존에 작동하던 타이머가 있다면 초기화하고 새로 설정
        if (window.callMsgTimer) clearTimeout(window.callMsgTimer);
        
        window.callMsgTimer = setTimeout(() => {
            msgEl.textContent = '';
        }, 3000); // 3초 뒤에 사라짐
    }
    //showToast("🔔 호출이 전달되었습니다.", "success");
    updateCallButtonState();
}
};
  //getSupabase();
  // 호출 옵션 로드 (사장님 로직)
  (function loadOptions() {
    const select = document.getElementById('call-reason');
    const list = ['물/수저 요청', '테이블 정리', '주문 문의', '직원 호출'];
    select.innerHTML = list.map(opt => `<option value="${opt}">${opt}</option>`).join('');
  })();

  // 5. 주문하기 (사장님 원본 유지 + 모달 연동)
  document.getElementById('pay-btn').onclick = async (e) => {
    e.preventDefault();
    const table = document.getElementById('tableNo').value.trim();
    const inputCode = document.getElementById('paycode').value.trim();
    const pc = await fetch(`/api/payment-code?storeId=${storeId}`).then(r => r.json());
    
    if (!table) return showToast('테이블 번호를 입력하세요','info');
    if (inputCode !== pc?.code) return showToast('결제 코드가 올바르지 않습니다','info');
    if (!cart.items.length) return showToast('장바구니가 비어 있습니다','info');

    // 확인 모달 열기
    // confirm-items 텍스트 생성 로직
    document.getElementById('confirm-items').textContent = cart.items.map(i => {
        let line = `${i.name} x${i.qty}`;
        if (i.optionText && i.optionText.length > 0) {
            const groups = {};
            i.optionText.forEach(t => {
                const [g, v] = t.split(':');
                if (!groups[g]) groups[g] = [];
                groups[g].push(v);
            });
            const optLine = Object.entries(groups)
                .map(([g, v]) => `   └ ${g}: ${v.join(',')}`)
                .join('\n');
            line += `\n${optLine}`;
        }
        return line;
    }).join('\n');
    document.getElementById('confirm-total').textContent = cart.total().toLocaleString();
    document.getElementById('order-confirm-modal').style.display = 'flex';
  };

  document.getElementById('confirm-ok').onclick = async () => {
    const payload = {
      storeId,
      type: 'store',
      table: document.getElementById('tableNo').value,
      amount: cart.total(),
      cart: cart.items
    };
    const r = await fetch('/api/orders', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if ((await r.json()).ok) {
      document.getElementById('order-confirm-modal').style.display = 'none';
      document.getElementById('order-success-modal').style.display = 'flex';
    }
  };

  document.getElementById('confirm-cancel').onclick = () => document.getElementById('order-confirm-modal').style.display = 'none';
  document.getElementById('order-success-close').onclick = () => location.reload();
// 🔄 [실시간 동기화 최종본]
async function initRealtimeSync() {
    try {
        // 1. Supabase 라이브러리 로드 대기
        if (!window.supabase) {
            setTimeout(initRealtimeSync, 500);
            return;
        }

        // 2. 매장 ID 및 환경 설정 가져오기
        const sid = window.qrnrStoreId || new URLSearchParams(location.search).get('store');
        if (!sid) return;

        
        
        // 3. 클라이언트 생성 및 채널 설정
        const { supabase, channel } = await getSupabase();
        const channelName = `qrnr_realtime_${sid}`;
       
        
        console.log(`📡 [실시간] 채널 연결 시도: ${channelName}`);

        channel.on('broadcast', { event: 'RELOAD_SIGNAL' }, async (payload) => {
            console.log("🔄 [신호 수신] 관리자가 데이터를 수정함:", payload);

            if (typeof showToast === 'function') showToast("📋 매장 정보가 업데이트되었습니다.", "info");

            setTimeout(async () => {
                try {
                  const updateType = payload.payload.type; // 관리자가 보낸 타입 ('menu_update', 'call_options_update' 등)
                   // 1. 메뉴 업데이트 신호일 때만 실행 (또는 전체 업데이트일 때)
            if (updateType === 'menu_update' || !updateType) {
                if (typeof renderMenu === 'function') {
                    await renderMenu('menu-grid', window.qrnrCart || cart);
                    console.log("✅ 메뉴판 실시간 업데이트 완료");
                }
            }

            // 2. 🚀 호출 옵션 업데이트 신호일 때만 실행
            if (updateType === 'call_options_update' || !updateType) {
                const select = document.getElementById('call-reason');
                if (select) {
                    const res = await fetch(`/api/store-settings?storeId=${sid}`);
                    const data = await res.json();
                    const list = data.settings?.call_options || ['물/수저 요청', '테이블 정리', '주문 문의', '직원 호출'];
                    select.innerHTML = list.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                    console.log("✅ 직원 호출 목록 실시간 업데이트 완료");
                }
            }

            // 공통 매장 정보 갱신
            if (typeof loadStoreInfo === 'function') await loadStoreInfo();

        } catch (updateErr) {
            console.error("❌ 부분 업데이트 실패, 새로고침 시도:", updateErr);
            location.reload(); 
        }
    }, 500);
  })
       /* .subscribe((status) => {
            if (status === 'SUBSCRIBED') {
                console.log(`✅ 실시간 수신 대기 중 (채널: ${channelName})`);
            } else if (status === 'CHANNEL_ERROR') {
                console.error("❌ 실시간 채널 연결 실패");
            }
        });*/
    console.log(`✅ 실시간 수신 대기 설정 완료: ${channelName}`);
    } catch (e) {
        console.error("실시간 동기화 초기화 에러:", e);
    }
}

initRealtimeSync();
</script>
</body>
</html>
