<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <title>ë°°ë‹¬/ì˜ˆì•½ (ë¹„íšŒì›)</title>

  <style>
    #privacy-open {
      transform: scale(0.7);
      transform-origin: left center;
      margin-left: 4px;
    }
    #privacy-row .vstack {
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }
    .clickable-label { cursor: pointer; user-select: none; }

    /* ì¡°íšŒ ëª¨ë‹¬ */
    #lookup-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #lookup-inner {
      background: #0f172a;
      padding: 20px;
      width: calc(100% - 40px);
      max-width: 450px;
      border-radius: 14px;
      max-height: 85vh;
      overflow-y: auto;
      border: 1px solid #1e293b;
    }

    .order-card {
      background: #1e293b;
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 12px;
    }

    .status {
      padding: 3px 8px;
      display: inline-block;
      border-radius: 6px;
      font-size: 13px;
      margin-bottom: 6px;
    }
    .st-wait { background:#334155;color:#e2e8f0; }
    .st-accept { background:#0ea5e9;color:white; }
    .st-cook { background:#f59e0b;color:black; }
    .st-delivery { background:#10b981;color:white; }
    .st-done { background:#475569;color:white; }

    /* ìƒì„¸ ëª¨ë‹¬ */
    #detail-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    #detail-box {
      background:#020617;
      padding:20px;
      width:calc(100% - 40px);
      max-width:480px;
      max-height:80vh;
      overflow:auto;
      border-radius:14px;
      border:1px solid #1e293b;
    }
  </style>
</head>

<body data-store-id="">

<script type="module">
  import { ensureStoreInitialized } from '/src/shared/store.js';
  const storeId = ensureStoreInitialized();
  window.qrnrStoreId = storeId;
  document.body.dataset.storeId = storeId;

  const url = new URL(location.href);
  if (!url.searchParams.get("store")) {
    url.searchParams.set("store", storeId);
    history.replaceState(null, "", url.toString());
  }
</script>

<div class="container">
  <div class="hstack" style="justify-content:space-between">
    <h1>ë¹„íšŒì› ë°°ë‹¬/ì˜ˆì•½</h1>

    <!-- ì£¼ë¬¸ ì¡°íšŒ ë²„íŠ¼ -->
    <button id="btn-lookup" class="btn">ì£¼ë¬¸ì¡°íšŒ</button>
  </div>

  <div class="card hstack" style="gap:8px">
    <label><input type="radio" name="tab" id="tab-deliv" checked> ë°°ë‹¬(ê²°ì œ)</label>
    <label><input type="radio" name="tab" id="tab-resv"> ì˜ˆì•½(ë¬´ê²°ì œ)</label>
  </div>

  <div class="card vstack" id="form-box">
    <h3>ì£¼ë¬¸ ì •ë³´ <span class="small">*</span></h3>

    <div class="vstack" style="gap:10px">

      <!-- ë°°ì†¡ì§€ -->
      <div class="field-row">
        <div class="field-label addr-label clickable-label">ë°°ì†¡ì§€</div>
        <div class="addr-wrap">
          <input id="addr" class="input"/>
          <input id="addr-detail" class="input addr-detail" placeholder="ìƒì„¸ì£¼ì†Œ"/>
        </div>
      </div>

      <!-- ì£¼ë¬¸ìëª… -->
      <div class="field-row">
        <div class="field-label">ì£¼ë¬¸ìëª…</div>
        <input id="cust" class="input"/>
      </div>

      <!-- ì—°ë½ì²˜ -->
      <div class="field-row">
        <div class="field-label">ì—°ë½ì²˜</div>
        <input id="phone" class="input" placeholder="ìˆ«ìë§Œ ì…ë ¥" inputmode="numeric"/>
      </div>

      <!-- ì˜ˆì•½ ì¼ì -->
      <div class="field-row" id="date-row">
        <div class="field-label">ì¼ì</div>
        <div class="date-time-row">
          <input id="date" type="date" class="input date-input">
          <span class="time-label">ì˜ˆì•½ì‹œê°„</span>
          <select id="time-ap" class="input input-sm time-ap"></select>
          <select id="time-hh" class="input input-sm"></select>
          <select id="time-mm" class="input input-sm"></select>
        </div>
      </div>

      <!-- ìš”ì²­ì‚¬í•­ -->
      <div class="field-row">
        <div class="field-label">ìš”ì²­ì‚¬í•­</div>
        <textarea id="memo" class="input" rows="3"></textarea>
      </div>

      <!-- ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸ -->
      <div class="field-row">
        <div class="field-label">ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸</div>
        <input id="pin" class="input" maxlength="4" inputmode="numeric" placeholder="4ìë¦¬"/>
      </div>

      <!-- ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ -->
      <div class="field-row small" id="privacy-row">
        <div class="field-label">ê°œì¸ì •ë³´</div>
        <div class="vstack" style="gap:4px;">
          <label style="display:flex;align-items:center;gap:6px;">
            <input type="checkbox" id="agree-privacy">
            <span>(í•„ìˆ˜) ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ë™ì˜</span>
          </label>
          <button type="button" class="btn" id="privacy-open">ë³´ê¸°</button>
        </div>
      </div>

      <!-- ì˜ˆì•½ ê³„ì¢Œ -->
      <div id="bank-box" class="field-row small" style="display:none;">
        <div class="field-label">ì…ê¸ˆê³„ì¢Œ</div>
        <div class="hstack" style="gap:6px;flex-wrap:wrap">
          <span id="bank-text"></span>
          <button class="btn" id="bank-copy">ë³µì‚¬</button>
        </div>
        <div class="small" style="margin-top:4px;color:#f97316;">
          â€» ì£¼ë¬¸ìëª…ìœ¼ë¡œ ì…ê¸ˆí•´ì£¼ì„¸ìš”!
        </div>
      </div>
    </div>
  </div>

  <!-- ë©”ë‰´ -->
  <div class="card vstack">
    <h3>ë©”ë‰´</h3>
    <div id="menu-grid" class="hstack" style="gap:12px;flex-wrap:wrap"></div>
  </div>

  <!-- ì¥ë°”êµ¬ë‹ˆ -->
  <div class="card vstack">
    <h3>ì¥ë°”êµ¬ë‹ˆ</h3>
    <div id="cart-box" class="vstack"></div>
  </div>

  <div class="card hstack" style="justify-content:space-between">
    <div>í•©ê³„: <b id="total">0</b>ì›</div>
    <button id="action-btn" class="btn primary">ê²°ì œí•˜ê¸°</button>
  </div>
</div>

<!-- ì¡°íšŒ ëª¨ë‹¬ -->
<div id="lookup-modal">
  <div id="lookup-inner">
    <h3>ë¹„íšŒì› ì£¼ë¬¸ ì¡°íšŒ</h3>

    <div class="vstack" style="gap:10px;margin-top:10px">
      <input id="lk-name" class="input" placeholder="ì´ë¦„"/>
      <input id="lk-phone" class="input" placeholder="ì „í™”ë²ˆí˜¸ (ìˆ«ìë§Œ)" inputmode="numeric"/>
      <input id="lk-pin" class="input" placeholder="ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬" maxlength="4" inputmode="numeric"/>
      <button class="btn primary" id="lk-submit">ì¡°íšŒí•˜ê¸°</button>
      <button class="btn" id="lk-close">ë‹«ê¸°</button>
    </div>

    <hr style="margin:16px 0;border-color:#1e293b"/>

    <div id="lk-result" class="vstack" style="gap:10px"></div>
  </div>
</div>

<!-- ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
<div id="detail-modal">
  <div id="detail-box">
    <h3>ì£¼ë¬¸ ìƒì„¸</h3>
    <div id="detail-body" class="small" style="white-space:pre-line;margin-top:10px"></div>
    <button class="btn" id="detail-close" style="margin-top:12px">ë‹«ê¸°</button>
  </div>
</div>

<!-- ë‹¤ìŒ ì£¼ì†Œ API -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script type="module">
  import { renderMenu, makeCart } from '/src/order/assets/js/modules/menu-cart.js';
  import { get } from '/src/order/assets/js/modules/cust-store.js';
  import { fillTimeSelectors, getTimeValue } from '/src/order/assets/js/modules/time.js';
  import { setPendingOrder, startPayment } from '/src/shared/toss-client.js';

  const storeId = window.qrnrStoreId;

  /* ì£¼ì†Œ ê²€ìƒ‰ */
  function openAddrSearch() {
    if (!window.daum?.Postcode) return alert("ì£¼ì†Œ ê²€ìƒ‰ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    new window.daum.Postcode({
      oncomplete(data) {
        document.getElementById("addr").value =
          data.roadAddress || data.jibunAddress || data.address;
        document.getElementById("addr-detail").focus();
      }
    }).open();
  }
  document.querySelector(".addr-label").onclick = openAddrSearch;
  document.getElementById("addr").onclick = openAddrSearch;

  /* ì „í™”ë²ˆí˜¸ */
  const phoneInput = document.getElementById("phone");
  phoneInput.addEventListener("input", () => {
    phoneInput.value = phoneInput.value.replace(/\D/g, "");
  });

  /* ë©”ë‰´/ì¹´ë“œ/ì‹œê°„ */
  fillTimeSelectors("time");
  const cart = makeCart("cart-box", "total");
  cart.render();
  renderMenu("menu-grid", cart);

  /* ê°œì¸ì •ë³´ ëª¨ë‹¬ */
  const modalPrivacy = document.getElementById("privacy-modal");
  if (document.getElementById("privacy-open")) {
    document.getElementById("privacy-open").onclick = () => {
      const txt =
        get(['admin','privacyPolicy',storeId]) ||
        get(['admin','privacyPolicy']) ||
        "ê´€ë¦¬ìì—ì„œ ë“±ë¡ëœ ì •ì±…ì´ ì—†ìŠµë‹ˆë‹¤.";
      document.getElementById("privacy-modal-body").textContent = txt;
      modalPrivacy.style.display = "flex";
    };
  }
  document.getElementById("privacy-close").onclick = () => modalPrivacy.style.display="none";

  /* ì˜ˆì•½ íƒ­ ë³€ê²½ */
  function updateTab() {
    const isResv = document.getElementById("tab-resv").checked;
    document.getElementById("bank-box").style.display = isResv ? "block" : "none";
    document.getElementById("date-row").style.display = isResv ? "block" : "none";
    document.getElementById("action-btn").textContent = isResv ? "ì˜ˆì•½í•˜ê¸°" : "ê²°ì œí•˜ê¸°";

    const bank =
      get(["admin","ownerBank",storeId]) ||
      get(["admin","ownerBank"]) ||
      {};
    document.getElementById("bank-text").textContent =
      bank.bank ? `${bank.bank} ${bank.number} (${bank.holder||""})` : "(ë“±ë¡ëœ ê³„ì¢Œì—†ìŒ)";
  }
  document.getElementById("tab-deliv").onchange = updateTab;
  document.getElementById("tab-resv").onchange = updateTab;
  updateTab();

  /* ê²°ì œ/ì˜ˆì•½ ë²„íŠ¼ */
  document.getElementById("action-btn").onclick = async () => {
    const addr = document.getElementById("addr").value.trim();
    const addr2 = document.getElementById("addr-detail").value.trim();
    const fullAddr = addr2 ? `${addr} ${addr2}` : addr;

    const cust = document.getElementById("cust").value.trim();
    const phone = phoneInput.value.trim();
    const memo = document.getElementById("memo").value.trim();
    const pin = document.getElementById("pin").value.trim();

    if (!/^\d{4}$/.test(pin)) return alert("ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    if (!document.getElementById("agree-privacy").checked)
      return alert("ê°œì¸ì •ë³´ ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
    if (!addr || !cust) return alert("ì£¼ì†Œì™€ ì£¼ë¬¸ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    if (!cart.items.length) return alert("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");

    const isResv = document.getElementById("tab-resv").checked;

    /* ì˜ˆì•½ */
    if (isResv) {
      const date = document.getElementById("date").value;
      const { ap, hh, mm } = getTimeValue("time") || {};
      if (!date) return alert("ì˜ˆì•½ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
      if (!ap || !hh || !mm || hh==="ì‹œ" || mm==="ë¶„")
        return alert("ì˜ˆì•½ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

      const payload = {
        type:"reserve",
        amount:cart.total(),
        orderName:"ì˜ˆì•½ ì£¼ë¬¸",
        cart:cart.items,
        customer:{ name:cust, phone, addr:fullAddr, req:memo, secretPin:pin },
        reserveDate:date,
        reserveTime:`${ap} ${hh}:${mm}`,
        status:"ëŒ€ê¸°",
        storeId,
        agreePrivacy:true
      };

      const r = await fetch("/api/orders", {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body:JSON.stringify(payload)
      });
      const j = await r.json();
      if (!j.ok) return alert("ì˜ˆì•½ ì €ì¥ ì‹¤íŒ¨");
      return location.replace(`/src/order/reserve-success.html`);
    }

    /* ë°°ë‹¬ ê²°ì œ */
    const orderId = "DELIV-" + Date.now();

    setPendingOrder({
      type:"delivery",
      amount:cart.total(),
      orderName:"ë°°ë‹¬ ì£¼ë¬¸",
      cart:cart.items,
      customer:{ name:cust, phone, addr:fullAddr, req:memo, secretPin:pin },
      memo,
      storeId,
      agreePrivacy:true,
      returnTo:location.pathname + location.search
    });

    await startPayment({ orderId, amount:cart.total(), orderName:"ë°°ë‹¬ ì£¼ë¬¸" });
  };

  /* ğŸ” ì£¼ë¬¸ ì¡°íšŒ ëª¨ë‹¬ */
  const lkModal = document.getElementById("lookup-modal");
  document.getElementById("btn-lookup").onclick = () => lkModal.style.display="flex";
  document.getElementById("lk-close").onclick = () => lkModal.style.display="none";

  document.getElementById("lk-submit").onclick = async () => {
    const n = document.getElementById("lk-name").value.trim();
    const p = document.getElementById("lk-phone").value.trim().replace(/\D/g,"");
    const pin = document.getElementById("lk-pin").value.trim();
    if (!n || !p || !/^\d{4}$/.test(pin))
      return alert("ì´ë¦„, ì „í™”ë²ˆí˜¸, 4ìë¦¬ PINì„ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    const r = await fetch(`/api/orders?storeId=${storeId}`);
    const j = await r.json();
    if (!j.ok) return alert("ì¡°íšŒ ì‹¤íŒ¨");

    const box = document.getElementById("lk-result");
    box.innerHTML = "";

    const match = j.orders.filter(o =>
      o.customer?.name === n &&
      o.customer?.phone?.replace(/\D/g,"") === p &&
      o.customer?.secretPin === pin
    );

    if (!match.length) {
      box.innerHTML = `<div class="small" style="color:#f87171">ì¼ì¹˜í•˜ëŠ” ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
      return;
    }

    for (const o of match) {
      const st = {
        "ëŒ€ê¸°":"st-wait",
        "ì ‘ìˆ˜":"st-accept",
        "ì¡°ë¦¬ì¤‘":"st-cook",
        "ë°°ë‹¬ì¤‘":"st-delivery",
        "ì™„ë£Œ":"st-done"
      }[o.status] || "st-wait";

      const div = document.createElement("div");
      div.className = "order-card";
      div.innerHTML = `
        <div class="status ${st}">${o.status}</div>
        <div><b>${o.orderName}</b></div>
        <div class="small" style="color:#a1a1aa">${o.dateTime}</div>
        <div class="small">${o.customer?.addr || ""}</div>
        <div style="margin-top:6px;">ì´ ê¸ˆì•¡: <b>${o.amount.toLocaleString()}ì›</b></div>
        <div class="small" style="margin-top:4px;color:#cbd5e1">
          ë©”ë‰´: ${o.cart.map(i=>`${i.name}x${i.qty}`).join(", ")}
        </div>
      `;

      div.style.cursor = "pointer";
      div.onclick = () => openDetail(o);

      box.appendChild(div);
    }
  };

  /* ìƒì„¸ë³´ê¸° ëª¨ë‹¬ */
  const detailModal = document.getElementById("detail-modal");
  document.getElementById("detail-close").onclick = () => detailModal.style.display="none";

  function openDetail(o) {
    const body = `
ì£¼ë¬¸ëª…: ${o.orderName}
ìƒíƒœ: ${o.status}
ì‹œê°„: ${o.dateTime}

[ê³ ê° ì •ë³´]
ì´ë¦„: ${o.customer?.name}
ì „í™”: ${o.customer?.phone}
ì£¼ì†Œ: ${o.customer?.addr}

[ë©”ë‰´]
${o.cart.map(i=>`- ${i.name} x ${i.qty}`).join("\n")}

[ìš”ì²­ì‚¬í•­]
${o.customer?.req || "(ì—†ìŒ)"}
    `.trim();

    document.getElementById("detail-body").textContent = body;
    detailModal.style.display = "flex";
  }
</script>

</body>
</html>
