<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <title>ì˜ˆì•½ (ë¹„íšŒì›)</title>

  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <link rel="stylesheet" href="/src/order/assets/css/order-common.css"/>
 <style>
    /* 1. ë‚ ì§œ ë° ì‹œê°„ ì˜ì—­ ë ˆì´ì•„ì›ƒ ë³µêµ¬ */
    .datetime-wrap { flex: 1; width: 100%; }
    .datetime-row { 
        display: flex; 
        align-items: center; 
        gap: 8px; 
        flex-wrap: nowrap; /* PCì—ì„œ í•œ ì¤„ ìœ ì§€ */
    }

    /* 2. ë‚ ì§œ ì…ë ¥ì°½ íŠ¹ìˆ˜ êµ¬ì¡° ë³µêµ¬ */
    .date-field { 
        position: relative; 
        min-width: 160px; 
        flex: 1.2; 
    }

    /* ë‚ ì§œ ì…ë ¥ì°½ ë‚´ë¶€ í…ìŠ¤íŠ¸(ì—°/ì›”/ì¼) í°ìƒ‰ ê°•ì œ */
    input[type="date"].date-input {
        width: 100%;
        color: #ffffff !important;
        background: #0d1117;
        text-align: left;
    }

    /* ë¸Œë¼ìš°ì €ë³„ ë‚´ë¶€ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ëŒ€ì‘ */
    input[type="date"].date-input::-webkit-datetime-edit-text,
    input[type="date"].date-input::-webkit-datetime-edit-month-field,
    input[type="date"].date-input::-webkit-datetime-edit-day-field,
    input[type="date"].date-input::-webkit-datetime-edit-year-field {
        color: #ffffff !important;
    }

    /* ì•ˆë‚´ ë¬¸êµ¬(placeholder) ìœ„ì¹˜ ì¡ê¸° */
    .date-placeholder {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        font-size: 14px;
        pointer-events: none;
        transition: opacity 0.15s;
    }

    /* ë‚ ì§œê°€ ì„ íƒë˜ë©´ placeholder ìˆ¨ê¹€ */
    input[type="date"]:valid + .date-placeholder,
    input[type="date"]:focus + .date-placeholder {
        opacity: 0;
    }

    /* 3. ëª¨ë°”ì¼ ìµœì í™” (ê¹¨ì§ ë°©ì§€) */
    @media (max-width: 640px) {
        .datetime-row { 
            flex-wrap: wrap; /* ëª¨ë°”ì¼ì€ ì¤„ë°”ê¿ˆ */
        }
        .date-field { 
            min-width: 100%; 
            margin-bottom: 4px;
        }
        .datetime-row select {
            flex: 1;
            min-width: 80px;
        }
    }

    /* 4. íƒ­ë°” ì¶”ê°€ ë³´ì • (í†µí•© CSS ë³´ì¡°) */
    #order-cat-tabs {
        padding: 5px 0 15px 0;
    }

   #privacy-row label {
      font-size: 13px !important; /* í™•ì‹¤í•˜ê²Œ ì¤„ì´ê¸° */
      color: #e5e7eb;           
      letter-spacing: -0.5px;    /* ê¸€ì ê°„ê²©ì„ ì¢í˜€ì„œ ë” ê¹”ë”í•˜ê²Œ */
  }

 
.bank-container-wrapper {
    display: flex;
    align-items: center; /* ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ ìœ ì§€ */
    justify-content: flex-start; /* ğŸš€ ì™¼ìª½ìœ¼ë¡œ ë¶™ì„ */
    width: 100%;
}
   
   #bank-text {
    font-size: 13px !important;
    font-weight: 600;
    color: #e5e7eb;
     display: block;
}

/* ì•„ë˜ì¹¸ìœ¼ë¡œ ë‚´ë ¤ê°„ ì˜ˆê¸ˆì£¼ & ì£¼ì˜ì‚¬í•­ ë¬¶ìŒ */
.bank-info-sub {
    margin-top: 2px;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

/* ì˜ˆê¸ˆì£¼ ê¸€ì”¨ */
#bank-holder-display {
    font-size: 13px;
    color: #e5e7eb; /* íë¦¿í•œ íšŒìƒ‰ */
}

/* 'ì£¼ë¬¸ìëª…ìœ¼ë¡œ ì…ê¸ˆ...' ì£¼ì˜ì‚¬í•­ */
.warning-text {
    font-size: 11px !important;
    color: #f97316 !important; /* ì˜¤ë Œì§€ìƒ‰ ìœ ì§€ */
    margin: 0;
}
/* ë³µì‚¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì‚´ì§ ë³´ì • */
#bank-copy {
    padding: 5px 10px;
    font-size: 11px;
    height: fit-content;
    flex-shrink: 0;
    background: #1c2632; /* ì£¼ë³€ë³´ë‹¤ ì•½ê°„ ë°ì€ ë°°ê²½ìƒ‰ìœ¼ë¡œ êµ¬ë¶„ê° ì£¼ê¸° */
    border: 1px solid #30363d;
}
   
</style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body data-store-id="">

<!-- storeId ì´ˆê¸°í™” -->
<script type="module">
  import { ensureStoreInitialized } from '/src/shared/store.js';
  const storeId = ensureStoreInitialized();
  window.qrnrStoreId = storeId;

  const url = new URL(location.href);
  if (!url.searchParams.get("store")) {
    url.searchParams.set("store", storeId);
    history.replaceState(null, "", url.toString());
  }
</script>

<div class="container">

  <h1>ì˜ˆì•½ (ë¹„íšŒì›)</h1>

  <div class="card vstack">
    <h3>ì˜ˆì•½ ì •ë³´ *</h3>

    <div class="vstack" style="gap:14px">

      <!-- ë°°ì†¡ì§€ -->
      <div class="field-row">
        <div class="field-label addr-label clickable-label">ë°°ì†¡ì§€</div>
        <div class="addr-wrap" style="flex:1">
          <input id="addr" class="input"/>
          <input id="addr-detail" class="input" placeholder="ìƒì„¸ì£¼ì†Œ" style="margin-top:6px"/>
        </div>
      </div>

      <!-- ì£¼ë¬¸ìëª… -->
      <div class="field-row">
        <div class="field-label">ì£¼ë¬¸ìëª…</div>
        <input id="cust" class="input" style="flex:1"/>
      </div>

      <!-- ì—°ë½ì²˜ -->
      <div class="field-row">
        <div class="field-label">ì—°ë½ì²˜</div>
        <input id="phone" class="input" placeholder="ìˆ«ìë§Œ ì…ë ¥" inputmode="numeric" style="flex:1"/>
      </div>

      <!-- ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸ -->
      <div class="field-row">
        <div class="field-label label-lookup">ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸</div>
        <input id="lookupPw" class="input" placeholder="4ìë¦¬ ìˆ«ì" maxlength="4" inputmode="numeric" style="flex:1"/>
      </div>

      <!-- ì˜ˆì•½ì¼ì‹œ -->
      <div class="field-row" id="date-row">
        <div class="field-label">ì˜ˆì•½ì¼ì‹œ</div>

        <div class="datetime-wrap">
          <div class="datetime-row">
           <div class="date-field">
            <input
              id="date"
              type="date"
              class="input date-input"
            >
            <span class="date-placeholder">ì˜ˆì•½ ë‚ ì§œ ì„ íƒ</span>
          </div>

            <select id="time-ap" class="input input-sm"></select>
            <select id="time-hh" class="input input-sm"></select>
            <select id="time-mm" class="input input-sm"></select>
          </div>
        </div>
      </div>

      <!-- ìš”ì²­ì‚¬í•­ -->
      <div class="field-row">
        <div class="field-label">ìš”ì²­ì‚¬í•­</div>
        <textarea id="memo" class="input" rows="4" style="flex:1"></textarea>
      </div>

      <!-- ê°œì¸ì •ë³´ -->
      <div class="field-row" id="privacy-row">
        <div class="field-label">ê°œì¸ì •ë³´</div>
        <div class="hstack" style="gap:10px">
          <label style="display:flex;align-items:center;gap:6px;">
            <input type="checkbox" id="agree-privacy">
            (í•„ìˆ˜) ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ë™ì˜
          </label>
          <button id="privacy-open" class="btn">ë³´ê¸°</button>
        </div>
      </div>

      
      <!-- ì…ê¸ˆê³„ì¢Œ -->
    <div class="field-row" id="bank-box">
    <div class="field-label">ì…ê¸ˆê³„ì¢Œ</div>
    
    <div class="bank-container-wrapper" style="flex:1; display:flex; align-items:center; gap:12px;">
      
      <div class="vstack" style="gap:2px;">
        <div class="bank-line">
          <span id="bank-text"></span>
        </div>
        <div class="bank-info-sub">
          <span id="bank-holder-display"></span>
          <p class="warning-text">â€» ì£¼ë¬¸ìëª…ìœ¼ë¡œ ì…ê¸ˆí•´ì£¼ì„¸ìš”!</p>
        </div>
      </div>
      
      <button id="bank-copy" class="btn">ë³µì‚¬</button>
      
    </div>
  </div>
        

  <!-- ë©”ë‰´ -->
  <div class="card vstack">
    <h3>ë©”ë‰´</h3>
    <div id="menu-grid"></div>
  </div>

  <!-- ì¥ë°”êµ¬ë‹ˆ -->
  <div class="card vstack">
    <h3>ì¥ë°”êµ¬ë‹ˆ</h3>
    <div id="cart-box" class="vstack"></div>
  </div>

  <!-- ê¸ˆì•¡ -->
  <div class="card hstack" style="justify-content:space-between">
    <div>í•©ê³„: <b id="total">0</b>ì›</div>
    <button id="action-btn" class="btn primary">ì˜ˆì•½í•˜ê¸°</button>
  </div>

</div>

<!-- ê°œì¸ì •ë³´ ëª¨ë‹¬ -->
<div id="privacy-modal" style="
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.55); z-index:9998;
  align-items:center; justify-content:center;">
  <div style="
    background:#020617; padding:16px 18px;
    border-radius:12px; max-width:520px;
    width:calc(100% - 40px); max-height:80vh;
    overflow:auto;">
    <h3>ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨</h3>
    <div id="privacy-modal-body" class="small" style="white-space:pre-wrap;"></div>
    <div class="hstack" style="justify-content:flex-end;margin-top:12px">
      <button id="privacy-close" class="btn">ë‹«ê¸°</button>
    </div>
  </div>
</div>

  <!-- ì˜ˆì•½ ì™„ë£Œ ëª¨ë‹¬ -->
<div id="reserve-done-modal" style="
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.55); z-index:9999;
  align-items:center; justify-content:center;">
  <div style="
    background:#0d1117;
    padding:24px 22px;
    border-radius:16px;
    max-width:420px;
    width:calc(100% - 40px);
    text-align:center;">
    <h3 style="margin-bottom:8px;">ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h3>
    <p class="small" style="line-height:1.6;">
      ê³„ì¢Œë¡œ <b>1ì‹œê°„ ì´ë‚´</b>ì—<br>
      <b id="reserve-amount"></b>ì›ì„ ì…ê¸ˆí•´ì£¼ì„¸ìš”.
    </p>
    <div class="small" style="margin:10px 0;color:#9ca3af;">
      <span id="reserve-bank"></span>
    </div>
    <button id="reserve-done-ok" class="btn primary" style="width:100%;">
      í™•ì¸
    </button>
  </div>
</div>

    <!-- ì£¼ë¬¸/ì˜ˆì•½ í™•ì¸ ëª¨ë‹¬ -->
<div id="confirm-modal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  z-index:9999;
  align-items:center;
  justify-content:center;
">
  <div style="
    background:#0d1117;
    padding:22px;
    border-radius:16px;
    max-width:420px;
    width:calc(100% - 40px);
  ">
    <h3 style="margin-bottom:10px;">ì£¼ë¬¸ í™•ì¸</h3>

    <div id="confirm-items"
     class="small"
     style="line-height:1.6;white-space:pre-wrap;"></div>

<div class="small" style="margin-top:8px;color:#9ca3af;">
  ì˜ˆì•½ì¼ì‹œ:
  <b id="confirm-datetime"></b>
</div>

<div style="margin-top:12px;">
  í•©ê³„: <b id="confirm-total"></b>ì›
</div>


    <div class="hstack" style="gap:8px;margin-top:16px;">
      <button id="confirm-cancel" class="btn" style="flex:1;">
        ì·¨ì†Œ
      </button>
      <button id="confirm-ok" class="btn primary" style="flex:1;">
        í™•ì¸
      </button>
    </div>
  </div>
</div>


<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script type="module">
  import { renderMenu, makeCart } from '/src/order/assets/js/modules/menu-cart.js';
  import { get } from '/src/order/assets/js/modules/cust-store.js';
  import { fillTimeSelectors, getTimeValue } from '/src/order/assets/js/modules/time.js';
  //import { setPendingOrder, startPayment } from '/src/shared/toss-client.js';
  import { INITIAL_STATUS } from '/src/shared/constants/status.js';

  const adminChannel = new BroadcastChannel("qrnr-admin");


  const storeId = window.qrnrStoreId;
  /* --- ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ --- */
let globalSupabase = null;
let globalChannel = null;

/* --- ê³µí†µ ì—°ê²° í•¨ìˆ˜ (ì¶”ê°€) --- */
async function getSupabase() {
    // ì´ë¯¸ ë§Œë“¤ì–´ì§„ ì—°ê²°ì´ ìˆë‹¤ë©´ ì¬ì‚¬ìš© (ì¤‘ë³µ ì¸ìŠ¤í„´ìŠ¤ ë°©ì§€)
    if (globalSupabase) return { supabase: globalSupabase, channel: globalChannel };

    const configRes = await fetch('/api/config');
    const { supabaseUrl, supabaseKey } = await configRes.json();
    
    // ë”± í•œ ë²ˆë§Œ í´ë¼ì´ì–¸íŠ¸ ìƒì„±
    globalSupabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    globalChannel = globalSupabase.channel(`qrnr_realtime_${window.qrnrStoreId}`);
    
    // ì¦‰ì‹œ êµ¬ë… ì‹œì‘
    globalChannel.subscribe();
    
    return { supabase: globalSupabase, channel: globalChannel };
}

  /**
 * í‘œì¤€ í† ìŠ¤íŠ¸ ì•Œë¦¼ í•¨ìˆ˜
 * @param {string} msg - í‘œì‹œí•  ë©”ì‹œì§€
 * @param {string} variant - 'info', 'success', 'error' (ìƒ‰ìƒ êµ¬ë¶„ìš©)
 */
export function showToast(msg, variant = 'info') {
  const t = document.createElement('div');
  
  // ê¸°ë³¸ í´ë˜ìŠ¤ëŠ” toast, ìƒíƒœì— ë”°ë¼ í´ë˜ìŠ¤ ì¶”ê°€ (ì˜ˆ: toast-success)
  t.className = `toast toast-${variant}`; 
  t.textContent = msg;
  
  document.body.appendChild(t);

  // ë¸Œë¼ìš°ì €ê°€ ìš”ì†Œë¥¼ ì¸ì‹í•œ ì§í›„ì— 'show' í´ë˜ìŠ¤ ì¶”ê°€ (ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘)
  requestAnimationFrame(() => t.classList.add('show'));

  // 3ì´ˆ í›„ ì‚¬ë¼ì§
  setTimeout(() => {
    t.classList.remove('show');
    // ì• ë‹ˆë©”ì´ì…˜(0.2ì´ˆ)ì´ ëë‚œ í›„ ìš”ì†Œ ì‚­ì œ
    setTimeout(() => t.remove(), 200);
  }, 3000);
}

  function fail(msg) {
  showToast(msg,'error');
  return false; // ì—¬ê¸°ì„œ íë¦„ ì™„ì „íˆ ëŠìŒ
}


  async function submitReserve() {

  const addr1 = document.getElementById("addr").value.trim();
  const addr2 = document.getElementById("addr-detail").value.trim();
  const fullAddr = addr2 ? addr1 + " " + addr2 : addr1;
  const cust = document.getElementById("cust").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const memo = document.getElementById("memo").value.trim();
  const pw = document.getElementById("lookupPw").value.trim();
  const agree = document.getElementById("agree-privacy").checked;
  const rawItems = cart.items || [];

  


    
  if (!agree) {fail("ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•´ì£¼ì„¸ìš”.");return;}
  if (!addr1 || !cust) {fail("ì£¼ì†Œì™€ ì£¼ë¬¸ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");return;}
  if (phone.length < 9) {fail("ì „í™”ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");return;}
  if (pw.length !== 4) {fail("ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");return;}
  if (!cart.items.length) {fail("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");return;}

  const date = document.getElementById("date").value;
  const { ap, hh, mm } = getTimeValue("time") || {};
  if (!date) {fail("ì˜ˆì•½ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");return;}
  if (!ap || !hh || !mm) {fail("ì˜ˆì•½ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");return;}

  /*const payload = {
  orderId: 'R' + Date.now(),
  storeId,
  orderType: 'reserve',
  //status: INITIAL_STATUS.reserve,
  amount: cart.total(),
  items: cart.items.map(i => ({
  id: i.id,
  name: i.name,
  qty: i.qty,
  unitPrice: i.price,
  options: Array.isArray(i.options) ? i.options : []
})),
  customer: {
    name: cust,
    phone,
    addr: fullAddr,
    memo
  },
  reserve: {
    date,
    time: `${ap} ${hh}:${mm}`
  },
  createdAt: Date.now()
};*/
    const payload = {
  storeId,
  type: 'reserve',
  amount: cart.total(),

  cart: cart.items.map(i => ({
    id: i.id,
    name: i.name,
    qty: i.qty,
    price: i.price,                 // ğŸ”¥ unitPrice âŒ â†’ price âœ…
    options: Array.isArray(i.options) ? i.options : []
  })),

  customer: {
    name: cust,
    phone,
    fullAddr,
    memo
  },

  reserve: {
    date,
    time: `${ap} ${hh}:${mm}`
  },
  lookupPw: document.getElementById("lookupPw").value.trim(),
  agreePrivacy: true
};


  const r = await fetch("/api/orders", {
    method: "POST",
    headers: { "content-type": "application/json" },
    body: JSON.stringify(payload)
  });

  const j = await r.json();
  if (!j.ok) fail("ì˜ˆì•½ ì €ì¥ ì‹¤íŒ¨");

  // ğŸ”” ê´€ë¦¬ì ì•Œë¦¼
  adminChannel.postMessage({
    type: "NEW_ORDER",
    orderType: "reserve",
    storeId,
    customer: { name: cust },
    cart: cart.items, 
    reserveDate: date,
    reserveTime: `${ap} ${hh}:${mm}`,
    amount: cart.total(),
    ts: Date.now()
  });

  // âœ… ì™„ë£Œ ëª¨ë‹¬
  document.getElementById("reserve-amount").textContent =
    cart.total().toLocaleString();

  document.getElementById("reserve-done-modal").style.display = "flex";
}


  document.getElementById("bank-copy").onclick = () => {
    const bankNumber = document.getElementById("bank-text").textContent;
    //const holder = document.getElementById("bank-holder-display").textContent;
    
    if (!bankNumber || bankNumber.includes("ë“±ë¡ëœ")) {
        showToast("ë³µì‚¬í•  ê³„ì¢Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.", "error");
        return;
    }
    //const fullText = `${bankNumber} ${holder}`;
    
    navigator.clipboard.writeText(bankNumber).then(() => {
        showToast("ê³„ì¢Œë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.", "info");
    });
  };

  
  /* -------- ì£¼ì†Œ ê²€ìƒ‰ -------- */
  function openAddrSearch() {
    new window.daum.Postcode({
      oncomplete(data) {
        document.getElementById("addr").value =
          data.roadAddress || data.jibunAddress || data.address;
        document.getElementById("addr-detail").focus();
      }
    }).open();
  }
  document.querySelector(".addr-label").onclick = openAddrSearch;
  document.getElementById("addr").onclick = openAddrSearch;

  /* -------- ì…ë ¥ ì œí•œ -------- */
  document.getElementById("phone").addEventListener("input", e => {
    e.target.value = e.target.value.replace(/\D/g, "");
  });
  document.getElementById("lookupPw").addEventListener("input", e => {
    e.target.value = e.target.value.replace(/\D/g, "").slice(0, 4);
  });


  /* -------- ë©”ë‰´ ë° ì¹´íŠ¸ -------- */
  fillTimeSelectors("time");
  const cart = makeCart("cart-box", "total");
  cart.render();
  renderMenu("menu-grid", cart);
  /* -------- ì…ê¸ˆê³„ì¢Œ ì´ˆê¸° í‘œì‹œ (ê´€ë¦¬ì ì„¤ì •ê°’) -------- */
  // [ì¶”ê°€] DBì—ì„œ ê³„ì¢Œ ì •ë³´ ì‹¤ì‹œê°„ ë¡œë“œ
    try {
    const res = await fetch(`/api/store-settings?storeId=${storeId}`);
    const data = await res.json();
    
    if (data.ok && data.settings?.owner_bank) {
        const bank = data.settings.owner_bank;
        const b = typeof bank === 'string' ? JSON.parse(bank) : bank;
        
        if (b.bank && b.number) {
            // 1. ê³„ì¢Œë²ˆí˜¸ ì¹¸ì—ëŠ” ì€í–‰ê³¼ ë²ˆí˜¸ë§Œ
            document.getElementById("bank-text").textContent = `${b.bank} ${b.number}`;
            // 2. ì˜ˆê¸ˆì£¼ ì¹¸ì— ì˜ˆê¸ˆì£¼ëª… ë”°ë¡œ ì…ë ¥
            document.getElementById("bank-holder-display").textContent = `ì˜ˆê¸ˆì£¼: ${b.holder || ""}`;
        } else {
            document.getElementById("bank-text").textContent = "ë“±ë¡ëœ ê³„ì¢Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";
        }
    } else {
        document.getElementById("bank-text").textContent = "ê´€ë¦¬ì ì„¤ì •ì—ì„œ ê³„ì¢Œë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.";
    }
}catch (e) {
        console.error("ê³„ì¢Œ ë¡œë“œ ì‹¤íŒ¨:", e);
        document.getElementById("bank-text").textContent = "ê³„ì¢Œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
    }

 /* -------- ê°œì¸ì •ë³´ ë³´ê¸° (DB ì—°ë™ ë²„ì „) -------- */
const modal = document.getElementById("privacy-modal");
document.getElementById("privacy-open").onclick = async () => {
  try {
    // 1. ì„œë²„ì—ì„œ í•´ë‹¹ ë§¤ì¥ì˜ ì„¤ì •ê°’(ë°©ì¹¨ í¬í•¨)ì„ ê°€ì ¸ì˜´
    const res = await fetch(`/api/store-settings?storeId=${storeId}`);
    const data = await res.json();
    
    // 2. DBì— ì €ì¥ëœ ë°©ì¹¨ì´ ìˆìœ¼ë©´ ì¶œë ¥, ì—†ìœ¼ë©´ ê¸°ë³¸ ì•ˆë‚´ ë¬¸êµ¬ ì¶œë ¥
    const policyText = data.ok && data.settings?.privacy_policy 
      ? data.settings.privacy_policy 
      : "ë“±ë¡ëœ ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.";

    document.getElementById("privacy-modal-body").textContent = policyText;
    modal.style.display = "flex";
  } catch (e) {
    console.error("ë°©ì¹¨ ë¡œë“œ ì‹¤íŒ¨:", e);
    showToast("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",'error');
  }
};

document.getElementById("privacy-close").onclick = () =>
  modal.style.display = "none";


  
/* -------- ê²°ì œ / ì˜ˆì•½ ì²˜ë¦¬ -------- */
document.getElementById("action-btn").onclick = () => {
  document.getElementById("action-btn").disabled = true;

  const items = cart.items;

  if (!items.length) {
    showToast("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.",'info');
    document.getElementById("action-btn").disabled = false;
    return;
  }

  const date = document.getElementById("date").value;
  const { ap, hh, mm } = getTimeValue("time") || {};

  // âœ… ì£¼ë¬¸ í™•ì¸ìš© ì¥ë°”êµ¬ë‹ˆ í‘œì‹œ
  // confirm-items í…ìŠ¤íŠ¸ ìƒì„± ë¡œì§
  document.getElementById('confirm-items').textContent = cart.items.map(i => {
      let line = `${i.name} x${i.qty}`;
      if (i.optionText && i.optionText.length > 0) {
          const groups = {};
          i.optionText.forEach(t => {
              const [g, v] = t.split(':');
              if (!groups[g]) groups[g] = [];
              groups[g].push(v);
          });
          const optLine = Object.entries(groups)
              .map(([g, v]) => `   â”” ${g}: ${v.join(',')}`)
              .join('\n');
          line += `\n${optLine}`;
      }
      return line;
  }).join('\n');

  document.getElementById("confirm-total").textContent =
    cart.total().toLocaleString();

  document.getElementById("confirm-datetime").textContent =
    date && ap && hh && mm
      ? `${date} ${ap} ${hh}:${mm}`
      : "-";

  document.getElementById("confirm-modal").style.display = "flex";
};

  
    /* ---- ë°°ë‹¬ ê²°ì œ ---- */
   /* const orderId = "DELIV-" + Date.now();

    setPendingOrder({
      type: "delivery",
      amount: cart.total(),
      orderName: "ë°°ë‹¬ ì£¼ë¬¸",
      cart: cart.items,
      customer: { name: cust, phone, addr: fullAddr, req: memo },
      lookupPw: pw,
      memo,
      storeId,
      agreePrivacy: true,
      returnTo: location.pathname + location.search
    });

    await startPayment({
      orderId,
      amount: cart.total(),
      orderName: "ë°°ë‹¬ ì£¼ë¬¸"
    }); };*/
  

  
  document.getElementById("reserve-done-ok").onclick = () => {
  document.getElementById("reserve-done-modal").style.display = "none";
  document.getElementById("action-btn").disabled = false;
  // ì…ë ¥ ì´ˆê¸°í™”
  document.getElementById("addr").value = "";
  document.getElementById("addr-detail").value = "";
  document.getElementById("cust").value = "";
  document.getElementById("phone").value = "";
  document.getElementById("lookupPw").value = "";
  document.getElementById("memo").value = "";
  document.getElementById("date").value = "";
  document.getElementById("time-ap").selectedIndex = 0;
  document.getElementById("time-hh").selectedIndex = 0;
  document.getElementById("time-mm").selectedIndex = 0;
  
  cart.items.length = 0;  // ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸°
  cart.render();          // í™”ë©´ ê°±ì‹ 

  window.scrollTo({ top: 0, behavior: "smooth" });
  };

const confirmOkBtn = document.getElementById("confirm-ok");

confirmOkBtn.onclick = async () => {
  confirmOkBtn.disabled = true;          // ğŸ”’ ì—°íƒ€ ë°©ì§€
  confirmOkBtn.textContent = "ì²˜ë¦¬ ì¤‘â€¦";

  document.getElementById("confirm-modal").style.display = "none";

  try {
    await submitReserve();
  } finally {
    confirmOkBtn.disabled = false;
    confirmOkBtn.textContent = "í™•ì¸";
  }
};


document.getElementById("confirm-cancel").onclick = () => {
  document.getElementById("confirm-modal").style.display = "none";
  document.getElementById("action-btn").disabled = false;

};
// ğŸ”„ [delivery-guest.html ì „ìš©] ì‹¤ì‹œê°„ ë™ê¸°í™” ìµœì¢…ë³¸
async function initRealtimeSync() {
    try {
        if (!window.supabase) {
            setTimeout(initRealtimeSync, 500);
            return;
        }

        const sid = window.qrnrStoreId || new URLSearchParams(location.search).get('store');
        if (!sid) return;

        /* --- âŒ ì´ì „ ì½”ë“œ (ì‚­ì œ ëŒ€ìƒ) ---
        const config = await res.json();
        const supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseKey);
        const channel = supabase.channel(`qrnr_realtime_${sid}`);
        ------------------------------- */

        // âœ… [ìˆ˜ì •ë³¸] ê³µí†µ í•¨ìˆ˜ í˜¸ì¶œ
        const { supabase, channel } = await getSupabase(); 
        
        console.log(`ğŸ“¡ [ì‹¤ì‹œê°„] ìˆ˜ì‹  ëŒ€ê¸° ì¤‘: qrnr_realtime_${sid}`);

        channel.on('broadcast', { event: 'RELOAD_SIGNAL' }, async (payload) => {
            console.log("ğŸ”„ ê´€ë¦¬ì ìˆ˜ì • ì‹ í˜¸ ìˆ˜ì‹ :", payload);
            const updateType = payload.payload.type;

            // 1. ë©”ë‰´ ì •ë³´ ì—…ë°ì´íŠ¸ (ë©”ë‰´íŒ ê·¸ë¦¬ë“œ)
            if (updateType === 'menu_update' || !updateType) {
                if (typeof renderMenu === 'function') {
                    // ê¸°ì¡´ ì¥ë°”êµ¬ë‹ˆ(cart) ìœ ì§€í•˜ë©° ë©”ë‰´íŒë§Œ ê°±ì‹ 
                    await renderMenu("menu-grid", cart);
                    console.log("âœ… ë©”ë‰´íŒ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì™„ë£Œ");
                }
            }

            // 2. ê³„ì¢Œ ì •ë³´ ì—…ë°ì´íŠ¸ (í™”ë©´ í•˜ë‹¨ ì…ê¸ˆê³„ì¢Œ í…ìŠ¤íŠ¸)
            if (updateType === 'bank_update' || !updateType) {
                try {
                    const res = await fetch(`/api/store-settings?storeId=${sid}`);
                    const data = await res.json();
                    if (data.ok && data.settings?.owner_bank) {
                        const b = data.settings.owner_bank;
                        document.getElementById("bank-text").textContent = 
                            `${b.bank} ${b.number} (ì˜ˆê¸ˆì£¼: ${b.holder || ""})`;
                        console.log("âœ… ì…ê¸ˆ ê³„ì¢Œ ì •ë³´ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì™„ë£Œ");
                    }
                } catch (e) { console.error("ê³„ì¢Œ ì •ë³´ ê°±ì‹  ì‹¤íŒ¨", e); }
            }

            // 3. ê°œì¸ì •ë³´ ë°©ì¹¨ ì—…ë°ì´íŠ¸
            // (ë°©ì¹¨ì€ 'ë³´ê¸°' ë²„íŠ¼ í´ë¦­ ì‹œ ì„œë²„ì—ì„œ ìƒˆë¡œ ë°›ì•„ì˜¤ë¯€ë¡œ ë³„ë„ UI ê°±ì‹  ë¶ˆí•„ìš”)

            showToast("ğŸ“‹ ë§¤ì¥ ì„¤ì •ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.", "info");
        })
        .subscribe((status) => {
            if (status === 'SUBSCRIBED') {
                console.log(`âœ… ì˜ˆì•½ í˜ì´ì§€ ì‹¤ì‹œê°„ ìˆ˜ì‹  ì¤‘ (ì±„ë„: qrnr_realtime_${sid})`);
            }
        });

    } catch (e) {
        console.error("ì‹¤ì‹œê°„ ë™ê¸°í™” ì—ëŸ¬:", e);
    }
}

  initRealtimeSync();

</script>




</body>
</html> 
