<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <title>배달/예약 (비회원)</title>

  <style>
    /* ----- 공통 레이아웃 ----- */
    .field-row {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      width: 100%;
    }
    .field-label {
      width: 80px;
      flex-shrink: 0;
      margin-top: 10px;
    }
    .label-lookup {
      width: 80px;
      text-align: center;
      white-space: nowrap;
      margin-top: 10px;
    }

    /* ---- 날짜 + 시간 ---- */
    .datetime-wrap {
      flex: 1;
    }

    .datetime-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: nowrap;
      width: 100%;
    }

    input[type="text"].date-input {
      width: 180px;
      height: 40px;
      padding: 0 10px;
      color: #ffffff;
      background: #0d1117;
    }

    /* placeholder 왼쪽 정렬 */
    .date-input::placeholder {
      text-align: left;
      color: #9ca3af;
    }

    /* 오전/오후 드롭다운 */
    #time-ap {
      padding: 8px 20px;
      min-width: 120px;
      text-align: left;
    }

    #time-hh,
    #time-mm {
      padding: 8px 12px;
      min-width: 80px;
      text-align: left;
    }

    /* 개인정보 보기 버튼 */
    #privacy-open {
      transform: scale(0.9);
      transform-origin: right center;
      white-space: nowrap;
    }

    /* 입금 계좌 라인 */
    .bank-line {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: nowrap;
    }

    /* 모바일 반응형 */
    @media (max-width: 640px) {
      input[type="date"].date-input {
    /*width: 100%;       전체 라인 폭 사용 */
    min-width: 200px; /* 지나치게 작아지는 것 방지 */
  }
      .field-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }

      .field-label {
        margin-bottom: 2px;
      }

      .datetime-row {
        flex-wrap: wrap;
        gap: 8px;
      }

      .datetime-row select,
      .datetime-row input {
        min-width: 110px;
        flex: 1;
      }
    }
    /* 공통 placeholder 스타일 */
input[type="date"].date-input::placeholder {
  color: #ffffff !important;
  opacity: 1;
}

/* WebKit 브라우저 (Chrome, Navermobile, Samsung Browser, Android) */
input[type="date"].date-input::-webkit-input-placeholder {
  color: #ffffff !important;
  opacity: 1;
}

/* iOS Safari */
input[type="date"].date-input::-webkit-date-and-time-value {
  color: #ffffff !important;
}

/* 안드로이드에서 날짜 placeholder 강제색 변경 */
input[type="date"].date-input::-webkit-datetime-edit-fields-wrapper {
  color: #ffffff !important;
}

/* 연/월/일 각각의 placeholder */
input[type="date"].date-input::-webkit-datetime-edit-year-field,
input[type="date"].date-input::-webkit-datetime-edit-month-field,
input[type="date"].date-input::-webkit-datetime-edit-day-field {
  color: #ffffff !important;
  opacity: 0.75;
}

  </style>
</head>

<body data-store-id="">

<!-- storeId 초기화 -->
<script type="module">
  import { ensureStoreInitialized } from '/src/shared/store.js';
  const storeId = ensureStoreInitialized();
  window.qrnrStoreId = storeId;

  const url = new URL(location.href);
  if (!url.searchParams.get("store")) {
    url.searchParams.set("store", storeId);
    history.replaceState(null, "", url.toString());
  }
</script>

<div class="container">

  <h1>배달/예약 (비회원)</h1>

  <div class="card hstack" style="gap:8px">
    <label><input type="radio" name="tab" id="tab-deliv" checked> 배달(결제)</label>
    <label><input type="radio" name="tab" id="tab-resv"> 예약(무결제)</label>
  </div>

  <div class="card vstack">
    <h3>배달/예약 정보 *</h3>

    <div class="vstack" style="gap:14px">

      <!-- 배송지 -->
      <div class="field-row">
        <div class="field-label addr-label clickable-label">배송지</div>
        <div class="addr-wrap" style="flex:1">
          <input id="addr" class="input"/>
          <input id="addr-detail" class="input" placeholder="상세주소" style="margin-top:6px"/>
        </div>
      </div>

      <!-- 주문자명 -->
      <div class="field-row">
        <div class="field-label">주문자명</div>
        <input id="cust" class="input" style="flex:1"/>
      </div>

      <!-- 연락처 -->
      <div class="field-row">
        <div class="field-label">연락처</div>
        <input id="phone" class="input" placeholder="숫자만 입력" inputmode="numeric" style="flex:1"/>
      </div>

      <!-- 조회 비밀번호 -->
      <div class="field-row">
        <div class="field-label label-lookup">조회 비밀번호</div>
        <input id="lookupPw" class="input" placeholder="4자리 숫자" maxlength="4" inputmode="numeric" style="flex:1"/>
      </div>

      <!-- 예약일시 -->
      <div class="field-row" id="date-row">
        <div class="field-label">예약일시</div>

        <div class="datetime-wrap">
          <div class="datetime-row">
            <input id="date" type="text" class="input date-input" placeholder="연-월-일 선택">

            <select id="time-ap" class="input input-sm"></select>
            <select id="time-hh" class="input input-sm"></select>
            <select id="time-mm" class="input input-sm"></select>
          </div>
        </div>
      </div>

      <!-- 요청사항 -->
      <div class="field-row">
        <div class="field-label">요청사항</div>
        <textarea id="memo" class="input" rows="4" style="flex:1"></textarea>
      </div>

      <!-- 개인정보 -->
      <div class="field-row" id="privacy-row">
        <div class="field-label">개인정보</div>
        <div class="hstack" style="gap:10px">
          <label style="display:flex;align-items:center;gap:6px;">
            <input type="checkbox" id="agree-privacy">
            (필수) 개인정보 수집·이용 동의
          </label>
          <button id="privacy-open" class="btn">보기</button>
        </div>
      </div>

      <!-- 입금계좌 -->
      <div class="field-row" id="bank-box" style="display:none;">
        <div class="field-label">입금계좌</div>

        <div class="bank-line">
          <span id="bank-text"></span>
          <button id="bank-copy" class="btn">복사</button>
        </div>

        <div class="small" style="margin-top:4px; color:#f97316;">
          ※ 주문자명으로 입금해주세요!
        </div>
      </div>

    </div>
  </div>

  <!-- 메뉴 -->
  <div class="card vstack">
    <h3>메뉴</h3>
    <div id="menu-grid" class="hstack" style="gap:12px;flex-wrap:wrap"></div>
  </div>

  <!-- 장바구니 -->
  <div class="card vstack">
    <h3>장바구니</h3>
    <div id="cart-box" class="vstack"></div>
  </div>

  <!-- 금액 -->
  <div class="card hstack" style="justify-content:space-between">
    <div>합계: <b id="total">0</b>원</div>
    <button id="action-btn" class="btn primary">결제하기</button>
  </div>

</div>

<!-- 개인정보 모달 -->
<div id="privacy-modal" style="
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.55); z-index:9998;
  align-items:center; justify-content:center;">
  <div style="
    background:#020617; padding:16px 18px;
    border-radius:12px; max-width:520px;
    width:calc(100% - 40px); max-height:80vh;
    overflow:auto;">
    <h3>개인정보 처리방침</h3>
    <div id="privacy-modal-body" class="small" style="white-space:pre-wrap;"></div>
    <div class="hstack" style="justify-content:flex-end;margin-top:12px">
      <button id="privacy-close" class="btn">닫기</button>
    </div>
  </div>
</div>

<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script type="module">
  import { renderMenu, makeCart } from '/src/order/assets/js/modules/menu-cart.js';
  import { get } from '/src/order/assets/js/modules/cust-store.js';
  import { fillTimeSelectors, getTimeValue } from '/src/order/assets/js/modules/time.js';
  import { setPendingOrder, startPayment } from '/src/shared/toss-client.js';

  const storeId = window.qrnrStoreId;

  /* -------- 주소 검색 -------- */
  function openAddrSearch() {
    new window.daum.Postcode({
      oncomplete(data) {
        document.getElementById("addr").value =
          data.roadAddress || data.jibunAddress || data.address;
        document.getElementById("addr-detail").focus();
      }
    }).open();
  }
  document.querySelector(".addr-label").onclick = openAddrSearch;
  document.getElementById("addr").onclick = openAddrSearch;

  /* -------- 입력 제한 -------- */
  document.getElementById("phone").addEventListener("input", e => {
    e.target.value = e.target.value.replace(/\D/g, "");
  });
  document.getElementById("lookupPw").addEventListener("input", e => {
    e.target.value = e.target.value.replace(/\D/g, "").slice(0, 4);
  });

  /* -------- date-picker 즉시 팝업 -------- */
  const dateInput = document.getElementById("date");

  dateInput.addEventListener("mousedown", () => {
    if (dateInput.type !== "date") {
      dateInput.type = "date";
    }
    setTimeout(() => {
      if (dateInput.showPicker) dateInput.showPicker();
    }, 0);
  });

  dateInput.addEventListener("focus", () => {
    if (dateInput.type !== "date") dateInput.type = "date";
    setTimeout(() => {
      if (dateInput.showPicker) dateInput.showPicker();
    }, 0);
  });

  dateInput.addEventListener("blur", () => {
    if (!dateInput.value) dateInput.type = "text";
  });

  /* -------- 메뉴 및 카트 -------- */
  fillTimeSelectors("time");
  const cart = makeCart("cart-box", "total");
  cart.render();
  renderMenu("menu-grid", cart);

  /* -------- 개인정보 보기 -------- */
  const modal = document.getElementById("privacy-modal");
  document.getElementById("privacy-open").onclick = () => {
    const t =
      get(["admin", "privacyPolicy", storeId]) ||
      get(["admin", "privacyPolicy"]) ||
      "관리자에서 개인정보 처리방침이 등록되지 않았습니다.";
    document.getElementById("privacy-modal-body").textContent = t;
    modal.style.display = "flex";
  };
  document.getElementById("privacy-close").onclick = () =>
    modal.style.display = "none";

  /* -------- 탭 전환 -------- */
  function updateTab() {
    const isResv = document.getElementById("tab-resv").checked;

    document.getElementById("date-row").style.display = isResv ? "block" : "none";
    document.getElementById("bank-box").style.display = isResv ? "flex" : "none";
    document.getElementById("action-btn").textContent = isResv ? "예약하기" : "결제하기";

    if (isResv) {
      const b =
        get(["admin", "ownerBank", storeId]) ||
        get(["admin", "ownerBank"]) ||
        {};
      const bt = document.getElementById("bank-text");
      bt.textContent = (b.bank && b.number)
        ? `${b.bank} ${b.number} (${b.holder || ""})`
        : "(관리자에 계좌 정보 없음)";
    }
  }
  document.getElementById("tab-deliv").onchange = updateTab;
  document.getElementById("tab-resv").onchange = updateTab;
  updateTab();

  /* -------- 결제 / 예약 처리 -------- */
  document.getElementById("action-btn").onclick = async () => {
    const addr1 = document.getElementById("addr").value.trim();
    const addr2 = document.getElementById("addr-detail").value.trim();
    const fullAddr = addr2 ? addr1 + " " + addr2 : addr1;
    const cust = document.getElementById("cust").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const memo = document.getElementById("memo").value.trim();
    const pw = document.getElementById("lookupPw").value.trim();
    const agree = document.getElementById("agree-privacy").checked;

    if (!agree) return alert("개인정보 수집·이용에 동의해주세요.");
    if (!addr1 || !cust) return alert("주소와 주문자명을 입력해주세요.");
    if (phone.length < 9) return alert("전화번호를 확인해주세요.");
    if (pw.length !== 4) return alert("조회 비밀번호 4자리를 입력해주세요.");
    if (!cart.items.length) return alert("장바구니가 비어 있습니다.");

    const isResv = document.getElementById("tab-resv").checked;

    /* ---- 예약 ---- */
    if (isResv) {
      const date = document.getElementById("date").value;
      const { ap, hh, mm } = getTimeValue("time") || {};
      if (!date) return alert("예약 날짜를 선택해주세요.");
      if (!ap || !hh || !mm) return alert("예약 시간을 선택해주세요.");

      const payload = {
        type: "reserve",
        amount: cart.total(),
        orderName: "예약 주문",
        cart: cart.items,
        customer: { name: cust, phone, addr: fullAddr, req: memo },
        reserveDate: date,
        reserveTime: `${ap} ${hh}:${mm}`,
        status: "대기",
        lookupPw: pw,
        storeId,
        agreePrivacy: true
      };

      const r = await fetch("/api/orders", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if (!j.ok) return alert("예약 저장 실패");

      return location.replace(`/src/order/reserve-success.html`);
    }

    /* ---- 배달 결제 ---- */
    const orderId = "DELIV-" + Date.now();

    setPendingOrder({
      type: "delivery",
      amount: cart.total(),
      orderName: "배달 주문",
      cart: cart.items,
      customer: { name: cust, phone, addr: fullAddr, req: memo },
      lookupPw: pw,
      memo,
      storeId,
      agreePrivacy: true,
      returnTo: location.pathname + location.search
    });

    await startPayment({
      orderId,
      amount: cart.total(),
      orderName: "배달 주문"
    });
  };
</script>

</body>
</html>
