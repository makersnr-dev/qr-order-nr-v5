<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
<link rel="icon" href="/favicon.ico" type="image/x-icon">
  <title>ì˜ˆì•½ (ë¹„íšŒì›)</title>

  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <link rel="stylesheet" href="/src/order/assets/css/order-common.css"/>
 <style>
    /* 1. ë‚ ì§œ ë° ì‹œê°„ ì˜ì—­ ë ˆì´ì•„ì›ƒ - ì™¼ìª½ ì •ë ¬ ë° ê°„ê²© ê³ ì • */
    .datetime-wrap { flex: 1; width: 100%; }
    .datetime-row { 
        display: flex; 
        align-items: center; 
        gap: 6px;          /* ğŸš€ ì¼ìì™€ ì‹œê°„ ì‚¬ì´ ê°„ê²© (ì›í•˜ëŠ” ë§Œí¼ ì¡°ì ˆ) */
        justify-content: flex-start; /* ğŸš€ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë°€ë¦¬ì§€ ì•Šê²Œ ì™¼ìª½ ì •ë ¬ */
        flex-wrap: nowrap; /* PCì—ì„œ í•œ ì¤„ ìœ ì§€ */
    }

    /* 2. ë‚ ì§œ ì…ë ¥ì°½ í¬ê¸° ê³ ì • - ë‹¤ë¥¸ ìš”ì†Œë“¤ì„ ë°€ì–´ë‚´ì§€ ì•Šê²Œ í•¨ */
    .date-field { 
        position: relative; 
        width: 150px;      /* ğŸš€ ë‚ ì§œ ë°•ìŠ¤ ë„ˆë¹„ë¥¼ ê³ ì •í•´ì„œ ì‹œê°„ì´ ë°”ë¡œ ì˜†ì— ì˜¤ê²Œ í•¨ */
        flex: 0 0 auto;    /* ğŸš€ ê³µê°„ì„ í˜¼ì ë‹¤ ì°¨ì§€(flex: 1.2)í•˜ì§€ ì•Šë„ë¡ ìˆ˜ì • */
    }

    /* ì‹œê°„ ì„ íƒ(Select)ì°½ í¬ê¸°ë„ ì ë‹¹íˆ ê³ ì • */
    .datetime-row .input-sm {
        width: 70px !important; /* ğŸš€ ì‹œ/ë¶„ ë°•ìŠ¤ í¬ê¸°ê°€ ì»¤ì§€ì§€ ì•Šê²Œ ê³ ì • */
        flex: 0 0 auto;
        padding: 8px 5px;
    }

    /* ë‚ ì§œ ì…ë ¥ì°½ ë‚´ë¶€ í…ìŠ¤íŠ¸(ì—°/ì›”/ì¼) í°ìƒ‰ ê°•ì œ */
    input[type="date"].date-input {
        width: 100%;
        color: #ffffff !important;
        background: #0d1117;
        text-align: left;
    }

    /* ë¸Œë¼ìš°ì €ë³„ ë‚´ë¶€ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ëŒ€ì‘ */
    input[type="date"].date-input::-webkit-datetime-edit-text,
    input[type="date"].date-input::-webkit-datetime-edit-month-field,
    input[type="date"].date-input::-webkit-datetime-edit-day-field,
    input[type="date"].date-input::-webkit-datetime-edit-year-field {
        color: #ffffff !important;
    }

    /* ì•ˆë‚´ ë¬¸êµ¬(placeholder) ìœ„ì¹˜ ì¡ê¸° */
    .date-placeholder {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        font-size: 14px;
        pointer-events: none;
        transition: opacity 0.15s;
    }

    /* ë‚ ì§œê°€ ì„ íƒë˜ë©´ placeholder ìˆ¨ê¹€ */
    input[type="date"]:valid + .date-placeholder,
    input[type="date"]:focus + .date-placeholder {
        opacity: 0;
    }

    /* 3. ëª¨ë°”ì¼ ìµœì í™” (ê¹¨ì§ ë°©ì§€) */
    @media (max-width: 640px) {
        .datetime-row { 
            flex-wrap: wrap; /* ëª¨ë°”ì¼ì€ ì¤„ë°”ê¿ˆ */
        }
        .date-field { 
            min-width: 100%; 
            margin-bottom: 4px;
        }
        .datetime-row select {
            flex: 1;
            min-width: 80px;
        }
    }

    /* 4. íƒ­ë°” ì¶”ê°€ ë³´ì • (í†µí•© CSS ë³´ì¡°) */
    #order-cat-tabs {
        padding: 5px 0 15px 0;
    }

   #privacy-row label {
      font-size: 13px !important; /* í™•ì‹¤í•˜ê²Œ ì¤„ì´ê¸° */
      color: #e5e7eb;           
      letter-spacing: -0.5px;    /* ê¸€ì ê°„ê²©ì„ ì¢í˜€ì„œ ë” ê¹”ë”í•˜ê²Œ */
  }

   /* ê³µí†µìœ¼ë¡œ ì‚¬ìš©í•  ì‘ì€ ë³´ì¡° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.btn-sub-small {
    padding: 4px 10px !important; /* ë³µì‚¬ ë²„íŠ¼ê³¼ ë™ì¼í•œ íŒ¨ë”© */
    font-size: 11px !important;    /* ì‘ì€ ê¸€ì”¨ */
    height: 26px !important;      /* ë²„íŠ¼ ë†’ì´ í†µì¼ */
    line-height: 1 !important;
    background: #1c2632 !important; /* ì–´ë‘ìš´ ë°°ê²½ìƒ‰ */
    border: 1px solid #30363d !important;
    border-radius: 8px !important;
    color: #e5e7eb !important;
    cursor: pointer;
    flex-shrink: 0;
}

.btn-sub-small:active {
    background: #263241 !important;
    transform: scale(0.95);
}

 
.bank-container-wrapper {
    display: flex;
    align-items: center; /* ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ ìœ ì§€ */
    justify-content: flex-start; /* ğŸš€ ì™¼ìª½ìœ¼ë¡œ ë¶™ì„ */
    width: 100%;
}
   
   #bank-text {
    font-size: 13px !important;
    font-weight: 600;
    color: #e5e7eb;
     display: block;
}

/* ì•„ë˜ì¹¸ìœ¼ë¡œ ë‚´ë ¤ê°„ ì˜ˆê¸ˆì£¼ & ì£¼ì˜ì‚¬í•­ ë¬¶ìŒ */
.bank-info-sub {
    margin-top: 2px;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

/* ì˜ˆê¸ˆì£¼ ê¸€ì”¨ */
#bank-holder-display {
    font-size: 13px;
    color: #e5e7eb; /* íë¦¿í•œ íšŒìƒ‰ */
}

/* 'ì£¼ë¬¸ìëª…ìœ¼ë¡œ ì…ê¸ˆ...' ì£¼ì˜ì‚¬í•­ */
.warning-text {
    font-size: 11px !important;
    color: #f97316 !important; /* ì˜¤ë Œì§€ìƒ‰ ìœ ì§€ */
    margin: 0;
}
/* ë³µì‚¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì‚´ì§ ë³´ì • */
#bank-copy, #privacy-open {
    padding: 5px 10px;
    font-size: 11px;
    height: fit-content;
    flex-shrink: 0;
    background: #1c2632; /* ì£¼ë³€ë³´ë‹¤ ì•½ê°„ ë°ì€ ë°°ê²½ìƒ‰ìœ¼ë¡œ êµ¬ë¶„ê° ì£¼ê¸° */
    border: 1px solid #30363d;
}
   
</style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body data-store-id="">

<!-- storeId ì´ˆê¸°í™” -->
<script type="module">
  import { ensureStoreInitialized } from '/src/shared/store.js';
  const storeId = ensureStoreInitialized();
  window.qrnrStoreId = storeId;

  const url = new URL(location.href);
  if (!url.searchParams.get("store")) {
    url.searchParams.set("store", storeId);
    history.replaceState(null, "", url.toString());
  }
</script>

<div class="container">

  <div class="hstack" style="justify-content: space-between; align-items: center; margin-bottom: 25px;">
    <h1 style="margin:0; font-size: 1.5rem;">ì˜ˆì•½ (ë¹„íšŒì›)</h1>
    <button id="btn-open-lookup" class="btn small" style="background:#1c2632; border-color:#263241; border-radius:10px; padding: 8px 12px; font-size: 12px;">
        ğŸ” ë‚´ ì˜ˆì•½ ì¡°íšŒ
    </button>
  </div>

<div id="lookup-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:6000; align-items:center; justify-content:center; padding:20px;">
    <div style="background:#0d1117; color:#fff; padding:20px; border-radius:16px; width:100%; max-width:360px; border:1px solid #263241;">
        <h3 style="margin-bottom:15px;">ì˜ˆì•½ ë‚´ì—­ ì¡°íšŒ</h3>
        <div class="vstack" style="gap:10px;">
            <input id="look-name" class="input" placeholder="ì£¼ë¬¸ì ì´ë¦„">
            <input id="look-phone" class="input" placeholder="ì—°ë½ì²˜" inputmode="numeric">
            <input id="look-pw" type="password" class="input" placeholder="ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬" maxlength="4" inputmode="numeric">
            <button id="btn-do-lookup" class="btn primary" style="height:46px; margin-top:10px;">ì¡°íšŒí•˜ê¸°</button>
        </div>
        <button id="lookup-close" class="btn" style="width:100%; margin-top:10px; background:transparent; border:none; color:#9ca3af;">ë‹«ê¸°</button>
    </div>
</div>

<div id="result-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:6100; align-items:center; justify-content:center; padding:20px;">
    <div style="background:#0d1117; color:#fff; padding:20px; border-radius:16px; width:100%; max-width:420px; max-height:80vh; overflow-y:auto; border:1px solid #263241;">
        <h3 style="margin-bottom:15px; border-bottom:1px solid #263241; padding-bottom:10px;">ì¡°íšŒ ê²°ê³¼</h3>
        <div id="lookup-result-list" class="vstack" style="gap:12px;"></div>
        <button id="result-close" class="btn primary" style="width:100%; margin-top:20px;">í™•ì¸</button>
    </div>
</div>

  <div class="card vstack">
    <h3>ì˜ˆì•½ ì •ë³´ *</h3>

    <div class="vstack" style="gap:14px">

      <!-- ë°°ì†¡ì§€ -->
      <div class="field-row">
        <div class="field-label addr-label clickable-label">ë°°ì†¡ì§€</div>
        <div class="addr-wrap" style="flex:1">
          <input id="addr" class="input"/>
          <input id="addr-detail" class="input" placeholder="ìƒì„¸ì£¼ì†Œ" style="margin-top:6px"/>
        </div>
      </div>

      <!-- ì£¼ë¬¸ìëª… -->
      <div class="field-row">
        <div class="field-label">ì£¼ë¬¸ìëª…</div>
        <input id="cust" class="input" style="flex:1"/>
      </div>

      <!-- ì—°ë½ì²˜ -->
      <div class="field-row">
        <div class="field-label">ì—°ë½ì²˜</div>
        <input id="phone" class="input" placeholder="ìˆ«ìë§Œ ì…ë ¥" inputmode="numeric" style="flex:1"/>
      </div>

      <!-- ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸ -->
      <div class="field-row">
        <div class="field-label label-lookup">ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸</div>
        <input id="lookupPw" class="input" placeholder="4ìë¦¬ ìˆ«ì" maxlength="4" inputmode="numeric" style="flex:1"/>
      </div>

      <!-- ì˜ˆì•½ì¼ì‹œ -->
      <div class="field-row" id="date-row">
        <div class="field-label">ì˜ˆì•½ì¼ì‹œ</div>

        <div class="datetime-wrap">
          <div class="datetime-row">
           <div class="date-field">
            <input
              id="date"
              type="date"
              class="input date-input"
            >
            <span class="date-placeholder">ì˜ˆì•½ ë‚ ì§œ ì„ íƒ</span>
          </div>

            <select id="time-ap" class="input input-sm"></select>
            <select id="time-hh" class="input input-sm"></select>
            <select id="time-mm" class="input input-sm"></select>
          </div>
        </div>
      </div>

      <!-- ìš”ì²­ì‚¬í•­ -->
      <div class="field-row">
        <div class="field-label">ìš”ì²­ì‚¬í•­</div>
        <textarea id="memo" class="input" rows="4" style="flex:1"></textarea>
      </div>

      <!-- ê°œì¸ì •ë³´ -->
      <div class="field-row" id="privacy-row">
        <div class="field-label">ê°œì¸ì •ë³´</div>
        <div class="hstack" style="flex:1; justify-content: flex-start; align-items: center; gap: 10px;">
          <label style="display:flex; align-items:center; gap:6px; margin:0;">
            <input type="checkbox" id="agree-privacy">
            (í•„ìˆ˜) ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ë™ì˜
          </label>
          <button id="privacy-open" class="btn btn-sub-small">ë³´ê¸°</button>
        </div>
      </div>

      
      <!-- ì…ê¸ˆê³„ì¢Œ -->
    <div class="field-row" id="bank-box">
    <div class="field-label">ì…ê¸ˆê³„ì¢Œ</div>
    
    <div class="bank-container-wrapper" style="flex:1; display:flex; align-items:center; gap:12px;">
      
      <div class="vstack" style="gap:2px;">
        <div class="bank-line">
          <span id="bank-text"></span>
        </div>
        <div class="bank-info-sub">
          <span id="bank-holder-display"></span>
          <p class="warning-text">â€» ì£¼ë¬¸ìëª…ìœ¼ë¡œ ì…ê¸ˆí•´ì£¼ì„¸ìš”!</p>
        </div>
      </div>
      
      <button id="bank-copy" class="btn">ë³µì‚¬</button>
      
    </div>
  </div>
        

  <!-- ë©”ë‰´ -->
  <div class="card vstack">
    <h3>ë©”ë‰´</h3>
    <div id="menu-grid"></div>
  </div>

  <!-- ì¥ë°”êµ¬ë‹ˆ -->
  <div class="card vstack">
    <h3>ì¥ë°”êµ¬ë‹ˆ</h3>
    <div id="cart-box" class="vstack"></div>
  </div>

  <!-- ê¸ˆì•¡ -->
  <div class="card hstack" style="justify-content:space-between">
    <div>í•©ê³„: <b id="total">0</b>ì›</div>
    <button id="action-btn" class="btn primary">ì˜ˆì•½í•˜ê¸°</button>
  </div>

</div>

<!-- ê°œì¸ì •ë³´ ëª¨ë‹¬ -->
<div id="privacy-modal" style="
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.55); z-index:9998;
  align-items:center; justify-content:center;">
  <div style="
    background:#020617; padding:16px 18px;
    border-radius:12px; max-width:520px;
    width:calc(100% - 40px); max-height:80vh;
    overflow:auto;">
    <h3>ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨</h3>
    <div id="privacy-modal-body" class="small" style="white-space:pre-wrap;"></div>
    <div class="hstack" style="justify-content:flex-end;margin-top:12px">
      <button id="privacy-close" class="btn">ë‹«ê¸°</button>
    </div>
  </div>
</div>

  <!-- ì˜ˆì•½ ì™„ë£Œ ëª¨ë‹¬ -->
<div id="reserve-done-modal" style="
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.55); z-index:9999;
  align-items:center; justify-content:center;">
  <div style="
    background:#0d1117;
    padding:24px 22px;
    border-radius:16px;
    max-width:420px;
    width:calc(100% - 40px);
    text-align:center;">
    <h3 style="margin-bottom:8px;">ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h3>
    <p class="small" style="line-height:1.6;">
      ê³„ì¢Œë¡œ <b>1ì‹œê°„ ì´ë‚´</b>ì—<br>
      <b id="reserve-amount"></b>ì›ì„ ì…ê¸ˆí•´ì£¼ì„¸ìš”.
    </p>
    <div class="small" style="margin:10px 0;color:#9ca3af;">
      <span id="reserve-bank"></span>
    </div>
    <button id="reserve-done-ok" class="btn primary" style="width:100%;">
      í™•ì¸
    </button>
  </div>
</div>

    <!-- ì£¼ë¬¸/ì˜ˆì•½ í™•ì¸ ëª¨ë‹¬ -->
<div id="confirm-modal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  z-index:9999;
  align-items:center;
  justify-content:center;
">
  <div style="
    background:#0d1117;
    padding:22px;
    border-radius:16px;
    max-width:420px;
    width:calc(100% - 40px);
  ">
    <h3 style="margin-bottom:10px;">ì£¼ë¬¸ í™•ì¸</h3>

    <div id="confirm-items"
     class="small"
     style="line-height:1.6;white-space:pre-wrap;"></div>

<div class="small" style="margin-top:8px;color:#9ca3af;">
  ì˜ˆì•½ì¼ì‹œ:
  <b id="confirm-datetime"></b>
</div>

<div style="margin-top:12px;">
  í•©ê³„: <b id="confirm-total"></b>ì›
</div>


    <div class="hstack" style="gap:8px;margin-top:16px;">
      <button id="confirm-cancel" class="btn" style="flex:1;">
        ì·¨ì†Œ
      </button>
      <button id="confirm-ok" class="btn primary" style="flex:1;">
        í™•ì¸
      </button>
    </div>
  </div>
</div>


<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script type="module">
  import { renderMenu, makeCart } from '/src/order/assets/js/modules/menu-cart.js';
  import { get } from '/src/order/assets/js/modules/cust-store.js';
  import { fillTimeSelectors, getTimeValue, isDayOff, checkBusinessHours, isManuallyBlocked } from '/src/order/assets/js/modules/time.js';
  import { INITIAL_STATUS } from '/src/shared/constants/status.js';
  import { supabaseMgr } from '/src/shared/supabase-manager.js';
  
  const adminChannel = new BroadcastChannel("qrnr-admin");
  const storeId = window.qrnrStoreId;
  let currentLookupOrderNo = null;
  
  // ğŸ›  ìˆ˜ì •: cart ë³€ìˆ˜ë¥¼ ì „ì—­ì— ì„ ì–¸í•˜ì—¬ ëª¨ë“  í•¨ìˆ˜ì—ì„œ ê³µìœ 
  let cart = null;

  function esc(str) {
    if (!str) return "";
    return String(str).replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[m]));
  }

  function formatPhoneNumber(num) {
    if (!num) return "-";
    const cleanNum = num.replace(/\D/g, "");
    if (cleanNum.length === 11) {
        return cleanNum.replace(/(\d{3})(\d{4})(\d{4})/, "$1-$2-$3");
    } else if (cleanNum.length === 10) {
        return cleanNum.replace(/(\d{2,3})(\d{3,4})(\d{4})/, "$1-$2-$3");
    }
    return num;
  }

  export function showToast(msg, variant = 'info') {
    const t = document.createElement('div');
    t.className = `toast toast-${variant}`; 
    t.textContent = msg;
    document.body.appendChild(t);
    requestAnimationFrame(() => t.classList.add('show'));
    setTimeout(() => {
        t.classList.remove('show');
        setTimeout(() => t.remove(), 200);
    }, 3000);
  }

  function fail(msg) {
    showToast(msg, 'error');
    document.getElementById("action-btn").disabled = false; 
    const confirmOkBtn = document.getElementById("confirm-ok");
    if (confirmOkBtn) confirmOkBtn.disabled = false;
    return false; 
  }

  // [ê¸°ì¡´ ë¡œì§ ìœ ì§€] ì˜ˆì•½ ì œì¶œ í•¨ìˆ˜
  async function submitReserve() {
    const addr1 = document.getElementById("addr").value.trim();
    const addr2 = document.getElementById("addr-detail").value.trim();
    const fullAddr = addr2 ? addr1 + " " + addr2 : addr1;
    const cust = document.getElementById("cust").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const memo = document.getElementById("memo").value.trim();
    const pw = document.getElementById("lookupPw").value.trim();
    const agree = document.getElementById("agree-privacy").checked;

    if (!agree) {fail("ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•´ì£¼ì„¸ìš”.");return;}
    if (!addr1 || !cust) {fail("ì£¼ì†Œì™€ ì£¼ë¬¸ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");return;}
    if (phone.length < 9) {fail("ì „í™”ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");return;}
    if (pw.length !== 4) {fail("ì¡°íšŒ ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");return;}
    if (!cart.items.length) {fail("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");return;}

    const date = document.getElementById("date").value;
    const { ap, hh, mm } = getTimeValue("time") || {};
    if (!date) {fail("ì˜ˆì•½ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");return;}
    if (!ap || !hh || !mm) {fail("ì˜ˆì•½ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");return;}

    let hour24 = parseInt(hh);
    if (ap === "PM" && hour24 < 12) hour24 += 12;
    if (ap === "AM" && hour24 === 12) hour24 = 0;
    const selectedDateTime = new Date(`${date}T${String(hour24).padStart(2, '0')}:${mm}:00`);
    const now = new Date();
    if (selectedDateTime <= now) {
      fail("í˜„ì¬ ì‹œê°„ë³´ë‹¤ ì´í›„ì˜ ì‹œê°„ìœ¼ë¡œ ì˜ˆì•½í•´ì£¼ì„¸ìš”.");
      return;
    }
    
    const payload = {
      storeId,
      type: 'reserve',
      amount: cart.total(),
      cart: cart.items.map(i => ({
        id: i.id, name: i.name, qty: i.qty, price: i.price, optionText: i.optionText || []
      })),
      customer: { name: cust, phone, fullAddr, memo },
      reserve: { date, time: `${ap} ${hh}:${mm}` },
      lookupPw: document.getElementById("lookupPw").value.trim(),
      agreePrivacy: true
    };

    try {
      const r = await fetch("/api/orders", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!r.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
      const j = await r.json();
      if (!j.ok) return fail(j.msg || "ì˜ˆì•½ ì €ì¥ ì‹¤íŒ¨");

      document.getElementById("reserve-amount").textContent = cart.total().toLocaleString();
      document.getElementById("reserve-done-modal").style.display = "flex";
    } catch (error) {
      fail("ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
  }

  // [ê¸°ì¡´ ë¡œì§ ìœ ì§€] ê³„ì¢Œ ì •ë³´ ë¡œë“œ
  async function loadBankInfo() {
    try {
      const res = await fetch(`/api/store-settings?storeId=${storeId}`);
      const data = await res.json();
      if (data.ok && data.settings?.owner_bank) {
        const bank = data.settings.owner_bank;
        const b = typeof bank === 'string' ? JSON.parse(bank) : bank;
        if (b.bank && b.number) {
          document.getElementById("bank-text").textContent = `${b.bank} ${b.number}`;
          document.getElementById("bank-holder-display").textContent = `ì˜ˆê¸ˆì£¼: ${b.holder || ""}`;
        } else {
          document.getElementById("bank-text").textContent = "ë“±ë¡ëœ ê³„ì¢Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";
        }
      }
    } catch (e) { console.error(e); }
  }

  // ğŸš€ ì´ˆê¸°í™” í†µí•© í•¨ìˆ˜ (ì‹¤í–‰ ìˆœì„œ ë³´ì¥)
  async function initApp() {
    // 1. ë§¤ì¥ ì„¤ì •(ì˜ì—…ì‹œê°„) ë¨¼ì € ê°€ì ¸ì˜¤ê¸°
    const sRes = await fetch(`/api/store-settings?storeId=${storeId}`);
    const sData = await sRes.json();
    const bh = sData.settings?.business_hours;
    
    fillTimeSelectors("time");

    const dateInput = document.getElementById('date');
    if (!dateInput) return;
    dateInput.min = new Date(Date.now() + 9 * 60 * 60 * 1000).toISOString().split("T")[0];

    // ë‚ ì§œ ì„ íƒ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    dateInput.addEventListener('change', (e) => {
        const selectedDate = e.target.value;
        if (!selectedDate) return;

        // íœ´ë¬´ì¼ ì²´í¬
        if (isDayOff(bh, selectedDate)) {
            showToast("ì„ íƒí•˜ì‹  ë‚ ì§œëŠ” ì˜ˆì•½ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.", "error");
            e.target.value = ""; // ì„ íƒ ì´ˆê¸°í™”
            return;
        }
      // 2. ê´€ë¦¬ì ìˆ˜ë™ ì°¨ë‹¨(ì¢…ì¼) ì²´í¬
    const manualCheck = isManuallyBlocked(bh, selectedDate);
    if (!manualCheck.ok) {
        showToast(manualCheck.msg, "error");
        e.target.value = ""; 
        return;
    }
    });

    // ğŸš€ ì‹œê°„ ë³€ê²½ ì‹œ ì‹¤ì‹œê°„ ì²´í¬ í•¨ìˆ˜ (ê³µí†µ ì‚¬ìš©)
    const checkCurrentTimeSlot = () => {
        const date = dateInput.value;
        if (!date) return;

        const { ap, hh, mm } = getTimeValue("time");
        if (!ap || !hh || !mm) return;

        // 24ì‹œê°„ì œ ë¬¸ìì—´ ìƒì„± (ì˜ˆ: "14:30")
        let hour24 = parseInt(hh);
        if (ap === "PM" && hour24 < 12) hour24 += 12;
        if (ap === "AM" && hour24 === 12) hour24 = 0;
        const timeStr = `${String(hour24).padStart(2, '0')}:${mm}`;
        const targetDT = new Date(`${date}T${timeStr}:00`);

        // A. ì˜ì—…ì‹œê°„ ë²”ìœ„ ì²´í¬
        const rangeCheck = checkBusinessHours(bh, targetDT);
        if (!rangeCheck.ok) {
            showToast(rangeCheck.msg, "error");
            return;
        }

        // B. ê´€ë¦¬ì ìˆ˜ë™ ì°¨ë‹¨(íŠ¹ì •ì‹œê°„) ì²´í¬
        const manualCheck = isManuallyBlocked(bh, date, timeStr);
        if (!manualCheck.ok) {
            showToast(manualCheck.msg, "error");
        }
    };

    // ì‹œê°„ ì„ íƒ ìš”ì†Œë“¤ì— ì´ë²¤íŠ¸ ë°”ì¸ë”©
    ['time-ap', 'time-hh', 'time-mm'].forEach(id => {
        document.getElementById(id).addEventListener('change', checkCurrentTimeSlot);
    });
    
    // 1. ì¹´íŠ¸ ë¨¼ì € ìƒì„±
    cart = makeCart("cart-box", "total");
    window.qrnrCart = cart;
    cart.render();

    // 2. ë©”ë‰´ ë Œë”ë§
    await renderMenu("menu-grid", cart);
    
    // 3. ê³„ì¢Œ ë¡œë“œ
    await loadBankInfo();

    initRealtimeSync();
  }

  function initRealtimeSync() {
    try {
      supabaseMgr.getChannel(storeId).then(channel => {
        if (!channel) return;
        // ğŸš€ [ì¶”ê°€ ì‹œì‘] ê´€ë¦¬ìê°€ ì˜ˆì•½ ìƒíƒœë¥¼ ë°”ê¿¨ì„ ë•Œ í™”ë©´ì˜ ê¸€ìë¥¼ ì¦‰ì‹œ ê³ ì¹¨
        channel.on('broadcast', { event: 'STATUS_CHANGED' }, (payload) => {
            const { orderId, status } = payload.payload;
            
            // í˜„ì¬ ë‚´ê°€ ì¡°íšŒ ì¤‘ì¸ ì˜ˆì•½ ë²ˆí˜¸ì™€ ê´€ë¦¬ìê°€ ë°”ê¾¼ ë²ˆí˜¸ê°€ ì¼ì¹˜í•  ë•Œë§Œ ì‹¤í–‰
            if (currentLookupOrderNo === orderId) {
                // ì¡°íšŒ ê²°ê³¼ ì°½ì—ì„œ ìƒíƒœë¥¼ ë‚˜íƒ€ë‚´ëŠ” íƒœê·¸(ìƒ‰ìƒ ë°°ê²½ì´ ìˆëŠ” b íƒœê·¸)ë¥¼ ì°¾ì•„ ê¸€ì ë³€ê²½
                const badge = document.querySelector('#lookup-result-list b[style*="background"]');
                if (badge) {
                    badge.textContent = status;
                    // ìƒíƒœì— ë”°ë¼ ë°°ê²½ìƒ‰ ë³€ê²½ (ì£¼ë¬¸ì·¨ì†ŒëŠ” ë¹¨ê°„ìƒ‰, ë‚˜ë¨¸ì§€ëŠ” ì´ˆë¡ìƒ‰)
                    badge.style.background = (status === 'ì£¼ë¬¸ì·¨ì†Œ') ? '#ef4444' : '#2ea043';
                    showToast(`ğŸ”” ì˜ˆì•½ ìƒíƒœê°€ [${status}]ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, "info");
                }
            }
        });
        channel.on('broadcast', { event: 'RELOAD_SIGNAL' }, async (payload) => {
          const updateType = payload.payload.type;
          if (updateType === 'menu_update' || !updateType) await renderMenu("menu-grid", cart);
          if (updateType === 'bank_update' || !updateType) await loadBankInfo();
          showToast("ğŸ“‹ ë§¤ì¥ ì„¤ì •ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.", "info");
        });
      });
    } catch (e) { console.error(e); }
  }

  // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì›ë³¸ ìœ ì§€) ---
  document.getElementById("bank-copy").onclick = () => {
    const bankNumber = document.getElementById("bank-text").textContent;
    if (!bankNumber || bankNumber.includes("ë“±ë¡ëœ")) return showToast("ë³µì‚¬í•  ê³„ì¢Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.", "error");
    navigator.clipboard.writeText(bankNumber).then(() => showToast("ê³„ì¢Œë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.", "info"));
  };

  const openAddr = () => new window.daum.Postcode({ oncomplete(data) { document.getElementById("addr").value = data.roadAddress || data.address; document.getElementById("addr-detail").focus(); } }).open();
  document.querySelector(".addr-label").onclick = openAddr;
  document.getElementById("addr").onclick = openAddr;

  document.getElementById("phone").addEventListener("input", e => e.target.value = e.target.value.replace(/\D/g, ""));
  document.getElementById("lookupPw").addEventListener("input", e => e.target.value = e.target.value.replace(/\D/g, "").slice(0, 4));

  document.getElementById("action-btn").onclick = () => {
    if (!cart.items.length) return showToast("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.",'info');
    document.getElementById("action-btn").disabled = true;
    const date = document.getElementById("date").value;
    const { ap, hh, mm } = getTimeValue("time") || {};

    document.getElementById('confirm-items').textContent = cart.items.map(i => {
      let line = `${i.name} x${i.qty}`;
      if (i.optionText && i.optionText.length > 0) {
        const groups = {};
        i.optionText.forEach(t => { const [g, v] = t.split(':'); if (!groups[g]) groups[g] = []; groups[g].push(v); });
        const optLine = Object.entries(groups).map(([g, v]) => `    â”” ${g}: ${v.join(',')}`).join('\n');
        line += `\n${optLine}`;
      }
      return line;
    }).join('\n');

    document.getElementById("confirm-total").textContent = cart.total().toLocaleString();
    document.getElementById("confirm-datetime").textContent = date && ap && hh && mm ? `${date} ${ap} ${hh}:${mm}` : "-";
    document.getElementById("confirm-modal").style.display = "flex";
  };

  document.getElementById("confirm-ok").onclick = async () => {
    const btn = document.getElementById("confirm-ok");
    btn.disabled = true; btn.textContent = "ì²˜ë¦¬ ì¤‘â€¦";
    document.getElementById("confirm-modal").style.display = "none";
    try { await submitReserve(); } finally { btn.disabled = false; btn.textContent = "í™•ì¸"; }
  };

  document.getElementById("confirm-cancel").onclick = () => {
    document.getElementById("confirm-modal").style.display = "none";
    document.getElementById("action-btn").disabled = false;
  };

  document.getElementById("reserve-done-ok").onclick = () => { location.reload(); };

  document.getElementById("privacy-open").onclick = async () => {
    try {
      const res = await fetch(`/api/store-settings?storeId=${storeId}`);
      const data = await res.json();
      document.getElementById("privacy-modal-body").textContent = data.ok && data.settings?.privacy_policy ? data.settings.privacy_policy : "ë“±ë¡ëœ ë°©ì¹¨ì´ ì—†ìŠµë‹ˆë‹¤.";
      document.getElementById("privacy-modal").style.display = "flex";
    } catch (e) { showToast("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨",'error'); }
  };
  document.getElementById("privacy-close").onclick = () => document.getElementById("privacy-modal").style.display = "none";

  // ğŸ” [ì›ë³¸ HTML ìœ ì§€] ë‚´ ì˜ˆì•½ ì¡°íšŒ ë¡œì§
  document.getElementById('btn-open-lookup').onclick = () => document.getElementById('lookup-modal').style.display = 'flex';
  // lookup-close í´ë¦­ ì‹œ
  document.getElementById('lookup-close').onclick = () => {
      document.getElementById('lookup-modal').style.display = 'none';
      currentLookupOrderNo = null; // ê°ì‹œ í•´ì œ
  };
  document.getElementById('result-close').onclick = () => document.getElementById('result-modal').style.display = 'none';

  document.getElementById('look-phone').addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/[^0-9]/g, "").replace(/^(\d{2,3})(\d{3,4})(\d{4})$/, `$1-$2-$3`);
  });

  document.getElementById('btn-do-lookup').onclick = async () => {
    const name = document.getElementById('look-name').value.trim();
    const cleanPhone = document.getElementById('look-phone').value.trim();
    const pw = document.getElementById('look-pw').value.trim();
    const phone = cleanPhone.replace(/\D/g, "");
    if (!name || !phone || !pw) return showToast("ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "info");

    
    if (phone.length < 10 || phone.length > 11) {
        return showToast("ì—°ë½ì²˜ë¥¼ ì „ì²´ ë²ˆí˜¸ë¡œ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.", "error");
    }

    const btn = document.getElementById('btn-do-lookup');
    btn.disabled = true; 
    btn.textContent = "ì¡°íšŒ ì¤‘...";

    try {
      const res = await fetch('/api/orders/lookup', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ name, phone, pw, storeId })
      });
      const data = await res.json();

      if (data.ok && data.orders.length > 0) {
        currentLookupOrderNo = data.orders[0].id;
        document.getElementById('lookup-result-list').innerHTML = data.orders.map(o => {
          const itemsHtml = o.items.map(i => {
            let optStr = "";
            if (i.optionText && i.optionText.length > 0) {
              const opts = i.optionText.map(t => esc(t.split(':')[1])).join(', ');
              optStr = `<div style="font-size:11px; color:#9ca3af; margin-left:10px;">â”” ì˜µì…˜: ${opts}</div>`;
            }
            return `<div style="margin-bottom:4px;">â€¢ ${esc(i.name)} x${i.qty} ${optStr}</div>`;
          }).join('');

          const meta = o.meta || {};
          const resDate = meta.reserve?.date || '-';
          const resTime = meta.reserve?.time || '-';
          const memo = meta.memo || 'ì—†ìŒ';

          // âš ï¸ ì—¬ê¸° ë°±í‹± ë‚´ë¶€ì˜ HTMLì€ ì‚¬ìš©ìë‹˜ì˜ ì›ë³¸ì„ í•œ ê¸€ìë„ ë°”ê¾¸ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
          // delivery-guest.html ë‚´ ì¡°íšŒ ê²°ê³¼ ìƒì„± ë¶€ë¶„ ìˆ˜ì •
          return `
              <div class="order-card" data-oid="${o.id}" style="background:#161b22; padding:15px; border-radius:12px; border:1px solid #2ea043; line-height:1.6; font-size:13px; margin-bottom:10px;">
                  <div class="hstack" style="justify-content:space-between; border-bottom:1px solid #263241; padding-bottom:8px; margin-bottom:10px;">
                      <b style="color:#2ea043; font-size:14px;">ì˜ˆì•½ë²ˆí˜¸: ${esc(o.id.split('-').pop())}</b>
                      
                      <b class="status-badge" style="background:${o.status === 'ì£¼ë¬¸ì·¨ì†Œ' ? '#ef4444' : '#2ea043'}; padding:2px 8px; border-radius:4px; font-size:11px;">
                          ${esc(o.status)}
                      </b>
                  </div>
                  
                  <div style="margin-bottom:8px;">
                      <div style="color:#9ca3af; font-size:11px;">ğŸ“ ë°°ì†¡ì§€ / ì£¼ë¬¸ì</div>
                      <div>${esc(o.address) || '-'}</div>
                      <div>${esc(o.customer_name)} (${formatPhoneNumber(esc(o.customer_phone))})</div>
                  </div>
          
                  <div style="margin-bottom:8px;">
                      <div style="color:#9ca3af; font-size:11px;">â° ì˜ˆì•½ ì¼ì‹œ</div>
                      <div style="color:#f97316; font-weight:bold;">${esc(resDate)} ${esc(resTime)}</div>
                  </div>
          
                  <div style="margin-bottom:8px;">
                      <div style="color:#9ca3af; font-size:11px;">ğŸ’¬ ìš”ì²­ì‚¬í•­</div>
                      <div style="font-style:italic;">"${esc(memo)}"</div>
                  </div>
          
                  <div style="margin-bottom:8px; background:#0d1117; padding:8px; border-radius:8px;">
                      <div style="color:#9ca3af; font-size:11px; margin-bottom:4px;">ğŸ“¦ ì£¼ë¬¸ ë©”ë‰´</div>
                      ${itemsHtml}
                  </div>
          
                  <div style="text-align:right; font-weight:bold; font-size:15px; color:#2ea043; margin-top:10px;">
                      ìµœì¢… ê²°ì œ ê¸ˆì•¡: ${Number(o.amount).toLocaleString()}ì›
                  </div>
              </div>
          `;
        }).join('');
        document.getElementById('lookup-modal').style.display = 'none';
        document.getElementById('result-modal').style.display = 'flex';
      } else {
        showToast("ì¼ì¹˜í•˜ëŠ” ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.", "error");
      }
    }
    catch (e) {
        showToast("ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
    }
    finally {
      btn.disabled = false; 
      btn.textContent = "ì¡°íšŒí•˜ê¸°";
    }
  };

  document.addEventListener("DOMContentLoaded", initApp);
</script>



</body>
</html> 
