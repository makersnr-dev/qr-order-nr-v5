<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <title>예약 (비회원)</title>
  <style>
    .field-row { display: flex; align-items: flex-start; gap: 12px; width: 100%; }
    .field-label { width: 80px; flex-shrink: 0; margin-top: 10px; }
    .date-field { position: relative; width: 180px; }
    .date-placeholder {
      position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
      color: #9ca3af; font-size: 14px; pointer-events: none; transition: opacity 0.15s ease;
    }
    .date-field input:not(:placeholder-shown) + .date-placeholder { opacity: 0; }
  </style>
</head>

<body data-store-id="">
<div class="container">
  <h1>비회원 예약</h1>
  
  <div class="card vstack">
    <div class="field-row">
      <div class="field-label">예약 날짜</div>
      <div class="date-field">
        <input type="date" id="date" class="input" placeholder=" " required>
        <span class="date-placeholder">날짜를 선택하세요</span>
      </div>
    </div>
    
    <div class="field-row">
      <div class="field-label">예약 시간</div>
      <div class="hstack" style="gap:8px">
        <select id="time-ap" class="input"><option>오전</option><option>오후</option></select>
        <select id="time-hh" class="input"></select>
        <select id="time-mm" class="input"></select>
      </div>
    </div>

    <input id="cust" class="input" placeholder="성함">
    <input id="phone" class="input" placeholder="연락처">
    <input id="addr" class="input" placeholder="주소">
    <input id="addr-detail" class="input" placeholder="상세주소">
    <input id="lookupPw" class="input" type="password" placeholder="조회용 비밀번호 (4자리)">
    <textarea id="memo" class="input" placeholder="요청사항"></textarea>
  </div>

  <div id="menu-list" class="vstack" style="gap:16px; margin-top:20px"></div>

  <div class="bottom-bar">
    <button id="action-btn" class="btn primary w-full">예약하기</button>
  </div>
</div>

<div id="reserve-done-modal" class="modal-overlay">
  <div class="modal-content">
    <h3>예약 접수 완료</h3>
    <p>입금 확인 후 예약이 확정됩니다.</p>
    <button id="reserve-done-ok" class="btn primary">확인</button>
  </div>
</div>

<script type="module">
import cart from '/src/order/assets/js/modules/cart.js';
import { ensureStoreInitialized } from '/src/shared/store.js';

const storeId = ensureStoreInitialized();
window.qrnrStoreId = storeId;

async function loadMenus() {
  const r = await fetch(`/api/menus?storeId=${storeId}`);
  const j = await r.json();
  if (j.ok) cart.init(j.menus, 'total-price', 'menu-list');
}
loadMenus();

// 시간 옵션 생성 로직 (사장님 원본 유지)
const hh = document.getElementById("time-hh");
for(let i=1; i<=12; i++) hh.innerHTML += `<option>${i}</option>`;
const mm = document.getElementById("time-mm");
['00','15','30','45'].forEach(m => mm.innerHTML += `<option>${m}</option>`);

document.getElementById("action-btn").onclick = async () => {
  if (!cart.items.length) return alert("장바구니가 비어있습니다.");
  
  const payload = {
    storeId,
    type: 'reserve',
    amount: cart.total(),
    table: 'GUEST',
    customer: {
      name: document.getElementById("cust").value,
      phone: document.getElementById("phone").value,
      addr: document.getElementById("addr").value,
      addrDetail: document.getElementById("addr-detail").value,
      pw: document.getElementById("lookupPw").value
    },
    reserve: {
      date: document.getElementById("date").value,
      time: `${document.getElementById("time-ap").value} ${document.getElementById("time-hh").value}:${document.getElementById("time-mm").value}`,
      memo: document.getElementById("memo").value
    },
    cart: cart.items
  };

  const r = await fetch('/api/orders', {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify(payload)
  });
  if ((await r.json()).ok) document.getElementById("reserve-done-modal").style.display = "flex";
};

document.getElementById("reserve-done-ok").onclick = () => location.reload();
</script>
</body>
</html>