<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <title>ë°°ë‹¬/ì˜ˆì•½ (ë¹„íšŒì›)</title>

  <style>
    /* ê°œì¸ì •ë³´ ë³´ê¸° ë²„íŠ¼ í¬ê¸° ì¶•ì†Œ */
    #privacy-open {
      transform: scale(0.7);
      transform-origin: left center;
      margin-left: 4px;
    }

    /* ê°œì¸ì •ë³´ ë™ì˜ ì˜ì—­ ì •ë ¬ */
    #privacy-row .vstack {
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    /* ì£¼ì†Œ í´ë¦­ ê°€ëŠ¥ í‘œì‹œ */
    .clickable-label {
      cursor: pointer;
      user-select: none;
    }

    /* ì˜ˆì•½ ì¼ì + ì‹œê°„ ì •ë ¬ ê°œì„  */
    .date-time-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .date-input {
      width: 140px;
    }

    .time-label {
      margin-left: 2px;
      margin-right: 2px;
      font-size: 14px;
      color: #ccc;
    }

    .input-sm {
      width: 80px;
    }

    /* ê³„ì¢Œ ë³µì‚¬ ë²„íŠ¼ */
    #bank-copy {
      height: 28px;
      padding: 0 10px;
      margin-left: 8px;
    }

    /* ìƒë‹¨ ë²„íŠ¼ ìš°ì¸¡ ê³ ì • */
    .top-right-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }
  </style>
</head>

<body data-store-id="">

<!-- â­ storeId ì´ˆê¸°í™” -->
<script type="module">
  import { ensureStoreInitialized } from '/src/shared/store.js';

  const storeId = ensureStoreInitialized();
  window.qrnrStoreId = storeId;
  document.body.dataset.storeId = storeId;

  const url = new URL(location.href);
  if (!url.searchParams.get("store")) {
    url.searchParams.set("store", storeId);
    history.replaceState(null, "", url.toString());
  }
</script>

<div class="container">
  <div class="hstack" style="justify-content:space-between">
    <h1>ë°°ë‹¬/ì˜ˆì•½ (ë¹„íšŒì›)</h1>

    <!-- ğŸ”¹ ë¹„íšŒì› ì „ìš©: ì£¼ë¬¸ì¡°íšŒ ë²„íŠ¼ë§Œ -->
    <div class="top-right-buttons">
      <a id="btn-lookup" class="btn" href="/src/order/lookup.html">ì£¼ë¬¸ ì¡°íšŒ</a>
    </div>
  </div>

  <!-- ğŸ”¹ ë°°ë‹¬/ì˜ˆì•½ íƒ­ -->
  <div class="card hstack" style="gap:8px">
    <label><input type="radio" name="tab" id="tab-deliv" checked> ë°°ë‹¬(ê²°ì œ)</label>
    <label><input type="radio" name="tab" id="tab-resv"> ì˜ˆì•½(ë¬´ê²°ì œ)</label>
  </div>

  <!-- ===========================
       ì£¼ë¬¸ ì •ë³´ ì…ë ¥
       =========================== -->
  <div class="card vstack" id="form-box">
    <h3>ë°°ë‹¬/ì˜ˆì•½ ì •ë³´ <span class="small">*</span></h3>

    <div class="vstack" style="gap:10px">

      <!-- ë°°ì†¡ì§€ -->
      <div class="field-row">
        <div class="field-label addr-label clickable-label">ë°°ì†¡ì§€</div>
        <div class="addr-wrap">
          <input id="addr" class="input"/>
          <input id="addr-detail" class="input addr-detail" placeholder="ìƒì„¸ì£¼ì†Œ"/>
        </div>
      </div>

      <!-- ì£¼ë¬¸ìëª… -->
      <div class="field-row">
        <div class="field-label">ì£¼ë¬¸ìëª…</div>
        <input id="cust" class="input"/>
      </div>

      <!-- ì—°ë½ì²˜ -->
      <div class="field-row">
        <div class="field-label">ì—°ë½ì²˜</div>
        <input id="phone" class="input" placeholder="ìˆ«ìë§Œ ê¸°ì…" inputmode="numeric"/>
      </div>

      <!-- ì˜ˆì•½ ì¼ì/ì‹œê°„ -->
      <div class="field-row" id="date-row">
        <div class="field-label">ì¼ì</div>

        <div class="date-time-row">
          <input id="date" type="date" class="input date-input">

          <span class="time-label">ì˜ˆì•½</span>

          <select id="time-ap" class="input input-sm"></select>
          <select id="time-hh" class="input input-sm"></select>
          <select id="time-mm" class="input input-sm"></select>
        </div>
      </div>

      <!-- ìš”ì²­ì‚¬í•­ -->
      <div class="field-row">
        <div class="field-label">ìš”ì²­ì‚¬í•­</div>
        <textarea id="memo" class="input" rows="4"></textarea>
      </div>

      <!-- ê°œì¸ì •ë³´ ë™ì˜ -->
      <div class="field-row small" id="privacy-row">
        <div class="field-label">ê°œì¸ì •ë³´</div>
        <div class="vstack">
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
            <input type="checkbox" id="agree-privacy">
            <span>(í•„ìˆ˜) ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ë™ì˜</span>
          </label>
          <button type="button" class="btn" id="privacy-open">ë³´ê¸°</button>
        </div>
      </div>

      <!-- ì˜ˆì•½ ê³„ì¢Œ -->
      <div id="bank-box" class="field-row small" style="display:none">
        <div class="field-label">ì…ê¸ˆê³„ì¢Œ</div>
        <div class="hstack" style="gap:6px;flex-wrap:wrap">
          <span id="bank-text"></span>
          <button class="btn" id="bank-copy" type="button">ë³µì‚¬</button>
        </div>
        <div class="small" style="margin-top:4px;color:#f97316;">
          â€» ì˜ˆì•½ìëª…ìœ¼ë¡œ ì…ê¸ˆí•´ì£¼ì„¸ìš”!
        </div>
      </div>

    </div>
  </div>

  <!-- ë©”ë‰´ -->
  <div class="card vstack">
    <h3>ë©”ë‰´</h3>
    <div id="menu-grid" class="hstack" style="gap:12px;flex-wrap:wrap"></div>
  </div>

  <!-- ì¥ë°”êµ¬ë‹ˆ -->
  <div class="card vstack">
    <h3>ì¥ë°”êµ¬ë‹ˆ</h3>
    <div id="cart-box" class="vstack"></div>
  </div>

  <!-- ê²°ì œ ë²„íŠ¼ -->
  <div class="card hstack" style="justify-content:space-between">
    <div>í•©ê³„: <b id="total">0</b>ì›</div>
    <button id="action-btn" class="btn primary">ê²°ì œí•˜ê¸°</button>
  </div>
</div>

<!-- ê°œì¸ì •ë³´ ëª¨ë‹¬ -->
<div id="privacy-modal" style="
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.55);
  z-index:9999;
  align-items:center; justify-content:center;">
  <div style="
    background:#020617;
    padding:16px 18px;
    border-radius:12px;
    max-width:520px;
    width:calc(100% - 40px);
    max-height:80vh;
    overflow:auto;">
    <h3 style="margin:0 0 8px 0;">ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨</h3>
    <div id="privacy-modal-body" class="small" style="white-space:pre-wrap;"></div>
    <div class="hstack" style="justify-content:flex-end;margin-top:12px">
      <button type="button" id="privacy-close" class="btn">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- ë‹¤ìŒ ì£¼ì†Œ ê²€ìƒ‰ API -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<!-- ===================== -->
<!-- ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ -->
<!-- ===================== -->
<script type="module">
  import { renderMenu, makeCart } from '/src/order/assets/js/modules/menu-cart.js';
  import { get } from '/src/order/assets/js/modules/cust-store.js';
  import { fillTimeSelectors, getTimeValue } from '/src/order/assets/js/modules/time.js';
  import { setPendingOrder, startPayment } from '/src/shared/toss-client.js';

  const storeId = window.qrnrStoreId;

  /* ---------------- ì£¼ì†Œ ê²€ìƒ‰ ---------------- */
  function openAddrSearch() {
    if (!window.daum?.Postcode)
      return alert("ì£¼ì†Œ ê²€ìƒ‰ ë¡œë”© ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");

    new window.daum.Postcode({
      oncomplete(data) {
        document.getElementById("addr").value =
          data.roadAddress || data.jibunAddress || data.address;
        document.getElementById("addr-detail").focus();
      }
    }).open();
  }
  document.querySelector(".addr-label")?.addEventListener("click", openAddrSearch);
  document.getElementById("addr")?.addEventListener("click", openAddrSearch);

  /* ---------------- ì „í™”ë²ˆí˜¸ ---------------- */
  const phoneInput = document.getElementById("phone");
  phoneInput.addEventListener("input", () => {
    phoneInput.value = phoneInput.value.replace(/\D/g, "");
  });

  /* ---------------- ë©”ë‰´ / ì¥ë°”êµ¬ë‹ˆ ---------------- */
  fillTimeSelectors('time');

  const cart = makeCart('cart-box', 'total');
  cart.render();
  renderMenu('menu-grid', cart);

  /* ---------------- ê³„ì¢Œ ì •ë³´ ë¡œë”© ---------------- */
  function loadBankInfo() {
    const bank =
      get(['admin', 'ownerBank', storeId]) ||
      get(['admin', 'ownerBank']) ||
      { bank:"", number:"", holder:"" };

    const bankText = document.getElementById("bank-text");

    if (!bank.bank || !bank.number) {
      bankText.textContent = "(ê´€ë¦¬ìì— ê³„ì¢Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤)";
    } else {
      bankText.textContent = `${bank.bank} ${bank.number} (${bank.holder || ""})`;
    }
  }

  /* ---------------- ê³„ì¢Œ ë³µì‚¬ ---------------- */
  document.getElementById("bank-copy")?.addEventListener("click", async () => {
    const txt = document.getElementById("bank-text").textContent.trim();
    if (!txt || txt.startsWith("(")) return alert("ë³µì‚¬í•  ê³„ì¢Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");

    try {
      await navigator.clipboard.writeText(txt);
      alert("ê³„ì¢Œë²ˆí˜¸ ë³µì‚¬ ì™„ë£Œ");
    } catch {
      alert("ë¸Œë¼ìš°ì €ì—ì„œ ë³µì‚¬ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
  });

  /* ---------------- ê°œì¸ì •ë³´ ëª¨ë‹¬ ---------------- */
  const modal = document.getElementById("privacy-modal");

  document.getElementById("privacy-open").onclick = () => {
    const text =
      get(['admin', 'privacyPolicy', storeId]) ||
      get(['admin', 'privacyPolicy']) ||
      "ê´€ë¦¬ìì—ì„œ ì •ì±…ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";

    document.getElementById("privacy-modal-body").textContent = text;
    modal.style.display = "flex";
  };

  document.getElementById("privacy-close").onclick = () => {
    modal.style.display = "none";
  };
  modal.onclick = e => { if (e.target === modal) modal.style.display = "none"; };

  /* ---------------- íƒ­ ì „í™˜ ---------------- */
  function updateTab() {
    const isResv = document.getElementById("tab-resv").checked;

    document.getElementById("bank-box").style.display = isResv ? "block" : "none";
    document.getElementById("date-row").style.display = isResv ? "flex" : "none";
    document.getElementById("action-btn").textContent = isResv ? "ì˜ˆì•½í•˜ê¸°" : "ê²°ì œí•˜ê¸°";

    if (isResv) loadBankInfo();
  }
  document.getElementById("tab-deliv").addEventListener("change", updateTab);
  document.getElementById("tab-resv").addEventListener("change", updateTab);
  updateTab();

  /* ---------------- ê²°ì œ/ì˜ˆì•½ ë²„íŠ¼ ---------------- */
  document.getElementById("action-btn").onclick = async () => {
    const addr = document.getElementById("addr").value.trim();
    const addr2 = document.getElementById("addr-detail").value.trim();
    const fullAddr = addr2 ? `${addr} ${addr2}` : addr;

    const cust = document.getElementById("cust").value.trim();
    const phone = phoneInput.value.trim();
    const memo = document.getElementById("memo").value.trim();
    const agree = document.getElementById("agree-privacy").checked;

    if (!agree) return alert("ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
    if (!addr || !cust) return alert("ì£¼ì†Œì™€ ì£¼ë¬¸ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    if (phone.replace(/\D/g, "").length < 10)
      return alert("ì „í™”ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");

    if (!cart.items.length) return alert("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");

    const isResv = document.getElementById("tab-resv").checked;

    /* ------------ ì˜ˆì•½ (ë¬´ê²°ì œ) ------------ */
    if (isResv) {
      const date = document.getElementById("date").value;
      const { ap, hh, mm } = getTimeValue("time") || {};

      if (!date) return alert("ì˜ˆì•½ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
      if (!ap || !hh || !mm || hh === "ì‹œ" || mm === "ë¶„")
        return alert("ì˜ˆì•½ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

      const payload = {
        type: "reserve",
        amount: cart.total(),
        orderName: "ì˜ˆì•½ ì£¼ë¬¸",
        cart: cart.items,
        customer: { name: cust, phone, addr: fullAddr, req: memo },
        reserveDate: date,
        reserveTime: `${ap} ${hh}:${mm}`,
        status: "ëŒ€ê¸°",
        storeId,
        agreePrivacy: true
      };

      const r = await fetch("/api/orders", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if (!j.ok) return alert("ì˜ˆì•½ ì €ì¥ ì‹¤íŒ¨");

      return location.replace(
        `/src/order/reserve-success.html?returnTo=${encodeURIComponent(location.pathname + location.search)}`
      );
    }

    /* ------------ ë°°ë‹¬ (ê²°ì œ) ------------ */
    const orderId = "DELIV-" + Date.now();

    setPendingOrder({
      type: "delivery",
      amount: cart.total(),
      orderName: "ë°°ë‹¬ ì£¼ë¬¸",
      cart: cart.items,
      customer: { name: cust, phone, addr: fullAddr, req: memo },
      memo,
      storeId,
      agreePrivacy: true,
      returnTo: location.pathname + location.search
    });

    await startPayment({
      orderId,
      amount: cart.total(),
      orderName: "ë°°ë‹¬ ì£¼ë¬¸"
    });
  };
</script>

</body>
</html>
