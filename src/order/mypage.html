<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <title>마이페이지</title>
</head>
<body>
<div class="container">
  <div class="hstack" style="justify-content:space-between">
    <h1>마이페이지</h1>
    <!-- ✅ JS에서 storeId를 붙이기 위해 id 부여 -->
    <a id="btn-back" class="btn" href="#">← 주문으로 돌아가기</a>
  </div>
  <div class="card vstack">
    <h3>내 주문 내역</h3>
    <div id="list"></div>
  </div>
</div>

<script type="module">
import { get } from '/src/order/assets/js/modules/cust-store.js';

// ===== 1) 현재 storeId 결정 =====
const url = new URL(location.href);

let storeId =
  url.searchParams.get('store') ||                    // 우선: ?store= 에서
  localStorage.getItem('qrnr.lastStoreId') ||         // 없으면: 마지막으로 본 매장
  localStorage.getItem('qrnr.storeId') ||             // 그래도 없으면: 기본 storeId
  'store1';

// 혹시라도 나중에 다시 쓸 수 있게 갱신
try {
  localStorage.setItem('qrnr.lastStoreId', storeId);
} catch (_) {}

// "주문으로 돌아가기" 버튼 href 세팅
const btnBack = document.getElementById('btn-back');
if (btnBack) {
  btnBack.href =
    '/src/order/delivery.html?store=' + encodeURIComponent(storeId);
}

// ===== 2) 내 주문 내역 표시 (기존 로직 유지) =====
const list = document.getElementById('list');
const orders = (get(['admin','ordersDelivery']) || []);

if (!orders.length) {
  list.innerHTML = '<div class="small">주문 내역이 없습니다.</div>';
}

orders.slice().reverse().forEach(o => {
  const div = document.createElement('div');
  div.className = 'vstack';
  div.style.border = '1px solid #263241';
  div.style.borderRadius = '12px';
  div.style.padding = '10px';
  div.style.margin = '6px 0';

  const items = (o.items || []).map(i => i.name + 'x' + i.qty).join(', ');

  // 타입 표시는 기존 그대로 유지 (나중에 서버 타입 'reserve'/'delivery'에 맞춰 바꿔도 됨)
  const typeLabel = (o.type === 'RESV' || o.type === 'reserve') ? '예약' : '배달';

  const timeStr = o.time
    ? new Date(o.time).toLocaleString()
    : (o.dateTime || '');

  div.innerHTML = `
    <div class="hstack" style="justify-content:space-between">
      <b>${typeLabel}</b>
      <span class="small">${timeStr}</span>
    </div>
    <div class="small">${o.addr || ''}</div>
    <div class="small">예약: ${o.reserve || '-'}</div>
    <div>${items}</div>
    <div><b>${(o.total || 0).toLocaleString()}원</b> · 상태: ${o.status || '-'}</div>
  `;
  list.appendChild(div);
});
</script>
</body>
</html>
