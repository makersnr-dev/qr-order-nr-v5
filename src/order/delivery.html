<!doctype html><html lang="ko"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
<title>ë°°ë‹¬/ì˜ˆì•½</title>
</head><body>
<div class="container">
  <div class="hstack" style="justify-content:space-between">
    <h1>ë°°ë‹¬/ì˜ˆì•½</h1>
    <div class="hstack" style="gap:8px">
      <a class="btn" href="/src/order/mypage.html">ë§ˆì´í˜ì´ì§€</a>
      <a class="btn" href="/src/order/select.html">ì£¼ë¬¸ ìœ í˜•</a>
    </div>
  </div>

  <div class="card hstack" style="gap:8px">
    <label><input type="radio" name="tab" id="tab-deliv" checked> ë°°ë‹¬(ê²°ì œ)</label>
    <label><input type="radio" name="tab" id="tab-resv"> ì˜ˆì•½(ë¬´ê²°ì œ)</label>
  </div>

  <div class="card vstack" id="form-box">
    <h3>ë°°ë‹¬/ì˜ˆì•½ ì •ë³´ <span class="small">*</span></h3>
    <div class="vstack" style="gap:10px">
      <input id="addr" class="input" placeholder="ë°°ì†¡ì§€ ì£¼ì†Œ *">
      <input id="cust" class="input" placeholder="ì£¼ë¬¸ì ì´ë¦„ *">
      <input id="phone" class="input" placeholder="ì—°ë½ì²˜ (ìˆ«ìë§Œ) *">
      <div class="hstack" style="gap:8px;flex-wrap:wrap">
        <input id="date" type="date" class="input" style="max-width:200px">
        <div class="hstack" style="gap:6px">
          <span class="small">ì˜ˆì•½ì‹œê°„</span>
          <select id="time-ap" class="input" style="width:120px"></select>
          <select id="time-hh" class="input" style="width:90px"></select>
          <select id="time-mm" class="input" style="width:90px"></select>
        </div>
      </div>
      <textarea id="memo" class="input" rows="5" placeholder="ìš”ì²­ì‚¬í•­"></textarea>

      <div id="bank-box" class="small" style="display:none">
        <b>ì…ê¸ˆ ê³„ì¢Œ:</b> <span id="bank-text"></span>
        <button class="btn" id="bank-copy">ë³µì‚¬</button>
      </div>
    </div>
  </div>

  <div class="card vstack">
    <h3>ë©”ë‰´</h3>
    <div id="menu-grid" class="hstack" style="gap:12px;flex-wrap:wrap"></div>
  </div>

  <div class="card vstack">
    <h3>ì¥ë°”êµ¬ë‹ˆ</h3>
    <div id="cart-box" class="vstack"></div>
  </div>

  <div class="card hstack" style="justify-content:space-between">
    <div>í•©ê³„: <b id="total">0</b>ì›</div>
    <button id="action-btn" class="btn primary">ê²°ì œí•˜ê¸°</button>
  </div>
</div>

<script type="module">
import { requireCust } from '/src/order/assets/js/modules/cust-auth.js';
import { renderMenu, makeCart } from '/src/order/assets/js/modules/menu-cart.js';
import { get, patch } from '/src/order/assets/js/modules/cust-store.js';
import { fillTimeSelectors, getTimeValue } from '/src/order/assets/js/modules/time.js';
import { setPendingOrder, startPayment } from '/src/shared/toss-client.js';

await requireCust();

// ì˜ˆì•½ì‹œê°„ ì„ íƒ ì…€ë ‰í„° ì±„ìš°ê¸°
fillTimeSelectors('time');

// ì¥ë°”êµ¬ë‹ˆ / ë©”ë‰´ ë Œë”
const cart = makeCart('cart-box', 'total');
cart.render();
renderMenu('menu-grid', cart);

// íƒ­ ì „í™˜ì— ë”°ë¼ UI ë³€ê²½
function updateTab() {
  const isResv = document.getElementById('tab-resv').checked;
  const bank = get(['admin', 'ownerBank']) || { bank: '', number: '', holder: '' };

  document.getElementById('bank-box').style.display = isResv ? 'block' : 'none';
  document.getElementById('action-btn').textContent = isResv ? 'ì˜ˆì•½í•˜ê¸°' : 'ê²°ì œí•˜ê¸°';

  document.getElementById('bank-text').textContent =
    bank.bank && bank.number
      ? `${bank.bank} ${bank.number} (${bank.holder || ''})`
      : '(ê´€ë¦¬ìì— ê³„ì¢Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤)';
}
['tab-deliv', 'tab-resv'].forEach(id => {
  document.getElementById(id).addEventListener('change', updateTab);
});
updateTab();

// ê³„ì¢Œ ë³µì‚¬
document.getElementById('bank-copy').onclick = () => {
  const txt = document.getElementById('bank-text').textContent;
  if (txt) navigator.clipboard.writeText(txt);
};

// í•©ê³„ ê³„ì‚° (ë°°ë‹¬ ê²°ì œìš©)
function totalAmount() {
  if (typeof cart.total === 'function') return cart.total();
  if (Array.isArray(cart.items)) {
    return cart.items.reduce((sum, i) =>
      sum + Number(i.price || 0) * Number(i.qty || 1), 0);
  }
  return 0;
}

// ë©”ì¸ ë²„íŠ¼ ë™ì‘
const actionBtn = document.getElementById('action-btn');

actionBtn.onclick = async (e) => {
  e.preventDefault();

  const addr = document.getElementById('addr').value.trim();
  const cust = document.getElementById('cust').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const date = document.getElementById('date').value;        // ğŸ”¹ ë‹¬ë ¥ì—ì„œ ì„ íƒí•œ ë‚ ì§œ
  const memo = document.getElementById('memo').value.trim();

  const items = cart.items || [];
  if (!items.length) {
    alert('ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
    return;
  }
  if (!addr || !cust || !phone) {
    alert('ì£¼ì†Œ / ì£¼ë¬¸ì / ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  const isResv = document.getElementById('tab-resv').checked;
  const t = getTimeValue('time'); // { ap, hh, mm }
  const timeStr = `${t.ap} ${t.hh}:${t.mm}`;

  if (isResv) {
    // âœ… ì˜ˆì•½(ë¬´ê²°ì œ) ì²˜ë¦¬
    if (!date) {
      alert('ì˜ˆì•½ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    const reserveAt = `${date} ${timeStr}`;
    const total = totalAmount();

    // ê´€ë¦¬ì ë°°ë‹¬/ì˜ˆì•½ ëª©ë¡ì— ë¡œì»¬ ì €ì¥ (API í˜¸ì¶œ ì—†ìŒ)
    patch(['admin', 'ordersDelivery'], (list) => {
      const arr = Array.isArray(list) ? [...list] : [];
      arr.push({
        id: 'RESV-' + Date.now(),
        type: 'reserve',
        time: new Date().toISOString(),
        reserveAt,
        addr,
        customer: { name: cust, phone },
        items,
        total,
        status: 'ëŒ€ê¸°',
        memo
      });
      return arr;
    });

    alert('ì˜ˆì•½ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. (ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤)');
    return;
  }

  // âœ… ë°°ë‹¬(ê²°ì œ) ì²˜ë¦¬
  const amount = totalAmount();
  if (!amount) {
    alert('ê²°ì œ ê¸ˆì•¡ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    return;
  }

  const orderId = 'DELIV-' + Date.now();
  const orderName = 'ë°°ë‹¬ ì£¼ë¬¸';

  const payload = {
    type: 'delivery',
    amount,
    orderName,
    cart: items,
    customer: { name: cust, phone, addr, req: memo },
    reserveDate: date || null,
    time: timeStr
  };

  // toss-success.htmlì—ì„œ ì½ì–´ì„œ /api/orders ì €ì¥í•˜ë„ë¡
  setPendingOrder(payload);

  try {
    await startPayment({ orderId, amount, orderName });
  } catch (err) {
    console.error('payment start error', err);
    alert('ê²°ì œë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
};
</script>


  
    </body></html>
