<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <title>배달/예약</title>
</head>
<body>
<div class="container">
  <div class="hstack" style="justify-content:space-between">
    <h1>배달/예약</h1>
    <div class="hstack" style="gap:8px">
      <a class="btn" href="/src/order/mypage.html">마이페이지</a>
      <a class="btn" href="/src/order/select.html">주문 유형</a>
    </div>
  </div>

  <div class="card hstack" style="gap:8px">
    <label><input type="radio" name="tab" id="tab-deliv" checked> 배달(결제)</label>
    <label><input type="radio" name="tab" id="tab-resv"> 예약(무결제)</label>
  </div>

   <div class="card vstack" id="form-box">
    <h3>배달/예약 정보 <span class="small">*</span></h3>

    <div class="vstack" style="gap:10px">
      <!-- 배송지 -->
   <div class="field-row">
  <div class="field-label addr-label">배송지</div>
  <div class="addr-wrap">
    <input id="addr" class="input" />
    <input id="addr-detail" class="input addr-detail" placeholder="상세주소" />
  </div>
</div>

      <!-- 주문자명 -->
      <div class="field-row">
        <div class="field-label">주문자명</div>
        <input id="cust" class="input" />
      </div>

      <!-- 연락처 -->
      <div class="field-row">
  <div class="field-label">연락처</div>
  <input
    id="phone"
    class="input"
    placeholder="숫자만 기입"
    inputmode="numeric"
  />
</div>


      <!-- 일자 + 예약시간 -->
      <div class="field-row">
  <div class="field-label">일자</div>
  <div class="date-time-row">
    <input id="date" type="date" class="input date-input">

    <span class="time-label">예약시간</span>

    <select id="time-ap" class="input input-sm time-ap"></select>
    <select id="time-hh" class="input input-sm"></select>
    <select id="time-mm" class="input input-sm"></select>
  </div>
</div>


      <!-- 요청사항 -->
      <div class="field-row">
        <div class="field-label">요청사항</div>
        <textarea id="memo" class="input" rows="4"></textarea>
      </div>

      <!-- 예약(무결제)일 때만 보이는 계좌 안내 -->
      <div id="bank-box" class="field-row small" style="display:none">
        <div class="field-label">입금계좌</div>
        <div class="hstack" style="gap:6px;flex-wrap:wrap">
          <span id="bank-text"></span>
          <button class="btn" id="bank-copy" type="button">복사</button>
        </div>
      </div>
    </div>
  </div>


  <div class="card vstack">
    <h3>메뉴</h3>
    <div id="menu-grid" class="hstack" style="gap:12px;flex-wrap:wrap"></div>
  </div>

  <div class="card vstack">
    <h3>장바구니</h3>
    <div id="cart-box" class="vstack"></div>
  </div>

  <div class="card hstack" style="justify-content:space-between">
    <div>합계: <b id="total">0</b>원</div>
    <button id="action-btn" class="btn primary">결제하기</button>
  </div>
</div>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script type="module">
import { requireCust } from '/src/order/assets/js/modules/cust-auth.js';
import { renderMenu, makeCart } from '/src/order/assets/js/modules/menu-cart.js';
import { get, patch } from '/src/order/assets/js/modules/cust-store.js';
import { fillTimeSelectors, getTimeValue } from '/src/order/assets/js/modules/time.js';
import { setPendingOrder, startPayment } from '/src/shared/toss-client.js';

await requireCust();

// 예약 시간 선택 셋업
fillTimeSelectors('time');

// 장바구니 / 메뉴
const cart = makeCart('cart-box', 'total');
cart.render();
renderMenu('menu-grid', cart);

// 탭 전환 UI
function updateTab() {
  const isResv = document.getElementById('tab-resv').checked;
  const bank = get(['admin','ownerBank']) || { bank:'', number:'', holder:'' };

  document.getElementById('bank-box').style.display = isResv ? 'block' : 'none';
  document.getElementById('action-btn').textContent = isResv ? '예약하기' : '결제하기';

  document.getElementById('bank-text').textContent =
    bank.bank && bank.number
      ? `${bank.bank} ${bank.number} (${bank.holder || ''})`
      : '(관리자에 계좌 정보가 없습니다)';
}
['tab-deliv','tab-resv'].forEach(id => {
  document.getElementById(id).addEventListener('change', updateTab);
});
updateTab();

// 계좌 복사
document.getElementById('bank-copy').onclick = () => {
  const txt = document.getElementById('bank-text').textContent;
  if (txt) navigator.clipboard.writeText(txt);
};

// 배송지 주소 찾기 (Daum 우편번호)
function openAddrSearch() {
  if (!window.daum || !window.daum.Postcode) {
    alert('주소 검색 서비스를 불러오지 못했습니다. 새로고침 후 다시 시도해주세요.');
    return;
  }
  new window.daum.Postcode({
    oncomplete: function (data) {
      const addrInput = document.getElementById('addr');
      if (!addrInput) return;
      const addr =
        data.roadAddress ||
        data.jibunAddress ||
        data.address ||
        '';
      addrInput.value = addr;
      addrInput.focus();
    },
  }).open();
}

// "배송지" 라벨 클릭 시 주소검색 열기
const addrLabel = document.querySelector('.addr-label');
if (addrLabel) {
  addrLabel.addEventListener('click', openAddrSearch);
  addrLabel.classList.add('clickable-label');
}

// 인풋 클릭으로도 열고 싶으면 (원하면 유지)
const addrInput = document.getElementById('addr');
if (addrInput) {
  addrInput.addEventListener('click', (e) => {
    if (!addrInput.value) openAddrSearch();
  });
}


// 연락처 숫자만 + 하이픈 자동 포맷
function formatPhone(raw) {
  const digits = String(raw || '').replace(/\D/g, '');
  if (digits.length === 10) {
    // 예: 0101234567 → 010-123-4567
    return digits.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
  }
  if (digits.length === 11) {
    // 예: 01012345678 → 010-1234-5678
    return digits.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
  }
  // 그 외 길이는 그냥 숫자만 리턴 (검증에서 걸러짐)
  return digits;
}

// 입력 중에는 숫자만 유지
const phoneInput = document.getElementById('phone');
if (phoneInput) {
  phoneInput.addEventListener('input', () => {
    const digits = phoneInput.value.replace(/\D/g, '');
    phoneInput.value = digits; // 타이핑 중에는 하이픈 없이 숫자만
  });

  // 포커스 빠질 때 자동 포맷
  phoneInput.addEventListener('blur', () => {
    const formatted = formatPhone(phoneInput.value);
    phoneInput.value = formatted || phoneInput.value;
  });
}


  
// 합계 계산
function totalAmount() {
  if (typeof cart.total === 'function') return cart.total();
  if (Array.isArray(cart.items)) {
    return cart.items.reduce((s,i)=>s + Number(i.price||0)*Number(i.qty||1),0);
  }
  return 0;
}

// 메인 버튼 동작
document.getElementById('action-btn').onclick = async (e) => {
  e.preventDefault();

 const addrBase    = document.getElementById('addr').value.trim();
const addrDetail  = (document.getElementById('addr-detail')?.value || '').trim();
const addr        = addrDetail ? `${addrBase} ${addrDetail}` : addrBase;
const cust        = document.getElementById('cust').value.trim();
const rawPhone    = document.getElementById('phone').value.trim();
const digitsPhone = rawPhone.replace(/\D/g, '');
const date        = document.getElementById('date').value;
const memo        = document.getElementById('memo').value.trim();


  const items = cart.items || [];
  if (!items.length) {
    alert('장바구니가 비어 있습니다.');
    return;
  }
  if (!addr || !cust ) {
    alert('주소 / 주문자명을 입력해주세요. ');
    return;
  }
  if (digitsPhone.length < 10) {
    alert('연락처를 확인해주세요. 숫자 10자리 이상 입력해주세요.');
    document.getElementById('phone').focus();
    return;
  }
  
   const phone = formatPhone(rawPhone);
  const { ap, hh, mm } = getTimeValue('time');
  const timeStr = `${ap} ${hh}:${mm}`;

  const isResv = document.getElementById('tab-resv').checked;

  if (isResv) {
    // ✅ 예약(무결제)
    if (!date) {
      alert('예약 날짜를 선택해주세요.');
      return;
    }

    const reserveAt = `${date} ${timeStr}`;
    const total = totalAmount();

    // 관리자 배달/예약 목록에 로컬 저장 (API 호출 없음)
    patch(['admin','ordersDelivery'], (list) => {
      const arr = Array.isArray(list) ? [...list] : [];
      arr.push({
        id: 'RESV-' + Date.now(),
        type: 'reserve',
        time: new Date().toISOString(),
        reserveAt,
        addr,
        customer: { name: cust, phone },
        items,
        total,
        status: '대기',
        memo
      });
      return arr;
    });

    alert('예약이 등록되었습니다. (관리자 페이지에서 확인 가능합니다)');
    return;
  }

  // ✅ 배달(결제)
  const amount = totalAmount();
  if (!amount) {
    alert('결제 금액이 올바르지 않습니다.');
    return;
  }

  const orderId = 'DELIV-' + Date.now();
  const orderName = '배달 주문';

  const payload = {
    type: 'delivery',
    amount,
    orderName,
    cart: items,
    customer: { name: cust, phone, addr, req: memo },
    reserveDate: date || null,
    time: timeStr
  };

  setPendingOrder(payload);

  try {
    await startPayment({ orderId, amount, orderName });
  } catch (err) {
    console.error('payment start error', err);
    alert('결제를 시작할 수 없습니다.');
  }
};
  
</script>
</body>
</html>
