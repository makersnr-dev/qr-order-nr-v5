<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <title>예약</title>
</head>

<body data-store-id="">
<script type="module">
  import { ensureStoreInitialized } from '/src/shared/store.js';

  const storeId = ensureStoreInitialized();
  window.qrnrStoreId = storeId;
  document.body.dataset.storeId = storeId;

  const url = new URL(location.href);
  if (!url.searchParams.get('store')) {
    url.searchParams.set('store', storeId);
    history.replaceState(null, "", url.toString());
  }
</script>

<div class="container">
  <div class="hstack" style="justify-content:space-between">
    <h1>예약</h1>
    <div class="hstack" style="gap:8px">
      <a id="btn-mypage" class="btn" href="#">마이페이지</a>
    </div>
  </div>

  <div class="card vstack" id="form-box">
    <h3>예약 정보 <span class="small">*</span></h3>

    <div class="vstack" style="gap:10px">
      <div class="field-row">
        <div class="field-label addr-label clickable-label">배송지</div>
        <div class="vstack" style="flex:1; gap:8px">
          <input id="addr" class="input" placeholder="기본 주소" readonly>
          <input id="addr-detail" class="input" placeholder="상세 주소 (호수 등)">
        </div>
      </div>

      <div class="field-row">
        <div class="field-label">연락처</div>
        <div class="vstack" style="flex:1; gap:8px">
          <input id="cust" class="input" placeholder="성함">
          <input id="phone" class="input" placeholder="연락처 (010-0000-0000)">
        </div>
      </div>

      <hr style="border:0; border-top:1px solid #30363d; margin:10px 0"/>

      <div class="field-row">
        <div class="field-label">예약 날짜</div>
        <input type="date" id="date" class="input" style="flex:1">
      </div>

      <div class="field-row">
        <div class="field-label">예약 시간</div>
        <div class="hstack" style="flex:1; gap:8px">
          <select id="time-ap" class="input" style="flex:1">
            <option>오전</option>
            <option>오후</option>
          </select>
          <select id="time-hh" class="input" style="flex:1"></select>
          <select id="time-mm" class="input" style="flex:1">
            <option>00</option>
            <option>15</option>
            <option>30</option>
            <option>45</option>
          </select>
        </div>
      </div>

      <div class="field-row">
        <div class="field-label">요청사항</div>
        <textarea id="memo" class="input" style="flex:1; min-height:60px" placeholder="사장님께 전하실 말씀"></textarea>
      </div>
    </div>
  </div>

  <div class="card vstack">
    <h3>장바구니</h3>
    <div id="menu-list" class="vstack" style="gap:16px"></div>
    <hr style="border:0; border-top:1px solid #30363d; margin:16px 0"/>
    <div class="hstack" style="justify-content:space-between">
      <span>총 예약 금액</span>
      <strong id="total-price" style="font-size:20px; color:#58a6ff">0원</strong>
    </div>
  </div>

  <div class="card vstack" style="background:#161b22">
    <div class="hstack" style="gap:8px; margin-bottom:12px">
      <div style="width:4px; height:18px; background:#58a6ff; border-radius:2px"></div>
      <h3 style="margin:0">입금 계좌 안내</h3>
    </div>
    <div id="bank-text" class="small" style="background:#0d1117; padding:16px; border-radius:8px; border:1px solid #30363d; line-height:1.6">
      불러오는 중...
    </div>
    <p class="small" style="color:#8b949e; margin-top:10px">
      · 예약 후 30분 내 미입금 시 자동 취소될 수 있습니다.<br/>
      · 입금 확인 후 예약 확정 안내 문자가 발송됩니다.
    </p>
  </div>

  <div style="height:100px"></div>

  <div class="bottom-bar">
    <button id="action-btn" class="btn primary w-full" style="height:52px; font-size:16px">예약하기</button>
  </div>
</div>

<div id="confirm-modal" class="modal-overlay">
  <div class="modal-content">
    <h3>예약 내용을 확인해주세요</h3>
    <div id="confirm-summary" class="vstack" style="gap:10px; margin:20px 0; text-align:left; font-size:14px"></div>
    <div class="hstack" style="gap:10px">
      <button id="confirm-cancel" class="btn" style="flex:1">취소</button>
      <button id="confirm-ok" class="btn primary" style="flex:1">확인</button>
    </div>
  </div>
</div>

<div id="reserve-done-modal" class="modal-overlay">
  <div class="modal-content">
    <div style="font-size:40px; margin-bottom:16px">✅</div>
    <h3>예약 신청 완료</h3>
    <p style="color:#8b949e; line-height:1.6; margin:16px 0">
      예약이 정상적으로 접수되었습니다.<br/>
      안내된 계좌로 입금해 주시면 확인 후<br/>
      확정 안내를 도와드리겠습니다.
    </p>
    <button id="reserve-done-ok" class="btn primary w-full">확인</button>
  </div>
</div>

<script type="module">
import cart from '/src/order/assets/js/modules/cart.js';
import { getMyInfo } from '/src/order/assets/js/modules/cust-auth.js';

const storeId = window.qrnrStoreId;

// 1. 초기 데이터 로드
async function init() {
  // 마이페이지 링크
  document.getElementById("btn-mypage").href = `/src/order/mypage.html?store=${storeId}`;

  // 시간(시) 옵션 생성
  const hh = document.getElementById("time-hh");
  for(let i=1; i<=12; i++) {
    hh.innerHTML += `<option value="${i}">${i}시</option>`;
  }

  // 사용자 정보 불러오기
  const me = await getMyInfo();
  if (me) {
    document.getElementById("cust").value = me.name || "";
    document.getElementById("phone").value = me.phone || "";
    document.getElementById("addr").value = me.addr || "";
    document.getElementById("addr-detail").value = me.addrDetail || "";
  }

  // 계좌 정보 불러오기 (통합 API)
  try {
    const r = await fetch(`/api/store-settings?storeId=${storeId}`);
    const j = await r.json();
    if (j.ok && j.settings.owner_bank) {
      const bank = JSON.parse(j.settings.owner_bank);
      document.getElementById("bank-text").textContent = 
        `${bank.bankName} ${bank.accountNumber} (예금주: ${bank.ownerName})`;
    }
  } catch(e) { console.error("계좌 로드 실패", e); }

  // 메뉴판 로드
  const mr = await fetch(`/api/menus?storeId=${storeId}`);
  const mj = await mr.json();
  if (mj.ok) {
    cart.init(mj.menus, "total-price", "menu-list");
  }
}

init();

// 2. 예약 제출 함수
async function submitReserve() {
  const payload = {
    storeId,
    type: 'reserve', // 통합 API 규격
    amount: cart.total(),
    table: 'MEMBER', // 회원 예약 식별
    customer: {
      name: document.getElementById("cust").value,
      phone: document.getElementById("phone").value,
      addr: document.getElementById("addr").value,
      addrDetail: document.getElementById("addr-detail").value
    },
    reserve: {
      date: document.getElementById("date").value,
      time: `${document.getElementById("time-ap").value} ${document.getElementById("time-hh").value}:${document.getElementById("time-mm").value}`,
      memo: document.getElementById("memo").value
    },
    cart: cart.items
  };

  const r = await fetch('/api/orders', {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify(payload)
  });

  const j = await r.json();
  if (j.ok) {
    document.getElementById("reserve-done-modal").style.display = "flex";
  } else {
    alert("예약 저장에 실패했습니다: " + j.error);
  }
}

// 3. 버튼 이벤트 (사장님 원본 UI 로직 그대로)
document.getElementById("action-btn").onclick = () => {
  if (!cart.items.length) return alert("장바구니가 비어있습니다.");
  if (!document.getElementById("date").value) return alert("날짜를 선택해주세요.");

  const summary = document.getElementById("confirm-summary");
  summary.innerHTML = `
    <div class="hstack" style="justify-content:space-between"><span>예약일</span> <strong>${document.getElementById("date").value}</strong></div>
    <div class="hstack" style="justify-content:space-between"><span>시간</span> <strong>${document.getElementById("time-ap").value} ${document.getElementById("time-hh").value}:${document.getElementById("time-mm").value}</strong></div>
    <div class="hstack" style="justify-content:space-between"><span>예약금액</span> <strong>${cart.total().toLocaleString()}원</strong></div>
  `;
  document.getElementById("confirm-modal").style.display = "flex";
};

document.getElementById("confirm-cancel").onclick = () => {
  document.getElementById("confirm-modal").style.display = "none";
};

const confirmOkBtn = document.getElementById("confirm-ok");
confirmOkBtn.onclick = async () => {
  confirmOkBtn.disabled = true;
  confirmOkBtn.textContent = "처리 중...";
  try {
    await submitReserve();
    document.getElementById("confirm-modal").style.display = "none";
  } finally {
    confirmOkBtn.disabled = false;
    confirmOkBtn.textContent = "확인";
  }
};

document.getElementById("reserve-done-ok").onclick = () => {
  location.reload();
};
</script>
</body>
</html>