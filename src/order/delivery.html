<!doctype html><html lang="ko"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
<title>배달/예약</title>
</head><body>
<div class="container">
  <div class="hstack" style="justify-content:space-between">
    <h1>배달/예약</h1>
    <div class="hstack" style="gap:8px">
      <a class="btn" href="/src/order/mypage.html">마이페이지</a>
      <a class="btn" href="/src/order/select.html">주문 유형</a>
    </div>
  </div>

  <div class="card hstack" style="gap:8px">
    <label><input type="radio" name="tab" id="tab-deliv" checked> 배달(결제)</label>
    <label><input type="radio" name="tab" id="tab-resv"> 예약(무결제)</label>
  </div>

  <div class="card vstack" id="form-box">
    <h3>배달/예약 정보 <span class="small">*</span></h3>
    <div class="vstack" style="gap:10px">
      <input id="addr" class="input" placeholder="배송지 주소 *">
      <input id="cust" class="input" placeholder="주문자 이름 *">
      <input id="phone" class="input" placeholder="연락처 (숫자만) *">
      <div class="hstack" style="gap:8px;flex-wrap:wrap">
        <input id="date" type="date" class="input" style="max-width:200px">
        <div class="hstack" style="gap:6px">
          <span class="small">예약시간</span>
          <select id="time-ap" class="input" style="width:120px"></select>
          <select id="time-hh" class="input" style="width:90px"></select>
          <select id="time-mm" class="input" style="width:90px"></select>
        </div>
      </div>
      <textarea id="memo" class="input" rows="5" placeholder="요청사항"></textarea>

      <div id="bank-box" class="small" style="display:none">
        <b>입금 계좌:</b> <span id="bank-text"></span>
        <button class="btn" id="bank-copy">복사</button>
      </div>
    </div>
  </div>

  <div class="card vstack">
    <h3>메뉴</h3>
    <div id="menu-grid" class="hstack" style="gap:12px;flex-wrap:wrap"></div>
  </div>

  <div class="card vstack">
    <h3>장바구니</h3>
    <div id="cart-box" class="vstack"></div>
  </div>

  <div class="card hstack" style="justify-content:space-between">
    <div>합계: <b id="total">0</b>원</div>
    <button id="action-btn" class="btn primary">결제하기</button>
  </div>
</div>

<script type="module">
import {requireCust} from '/src/order/assets/js/modules/cust-auth.js';
import {renderMenu, makeCart} from '/src/order/assets/js/modules/menu-cart.js';
import {get, patch, fmt} from '/src/order/assets/js/modules/cust-store.js';
import {fillTimeSelectors, getTimeValue} from '/src/order/assets/js/modules/time.js';

await requireCust();
fillTimeSelectors('time');

const cart=makeCart('cart-box','total'); cart.render(); renderMenu('menu-grid', cart);

function updateTab(){
  const isResv = document.getElementById('tab-resv').checked;
  const bank = get(['admin','ownerBank']) || {bank:'',number:'',holder:''};
  document.getElementById('bank-box').style.display = isResv ? 'block' : 'none';
  document.getElementById('action-btn').textContent = isResv ? '예약하기' : '결제하기';
  document.getElementById('bank-text').textContent = bank.bank && bank.number ? `${bank.bank} ${bank.number} (${bank.holder||''})` : '(관리자에 계좌 정보가 없습니다)';
}
['tab-deliv','tab-resv'].forEach(id=>document.getElementById(id).addEventListener('change',updateTab)); updateTab();
document.getElementById('bank-copy').onclick=()=>{ const txt=document.getElementById('bank-text').textContent; navigator.clipboard.writeText(txt); };


document.getElementById('action-btn').onclick=async()=>{
  const addr=document.getElementById('addr').value.trim();
  const cust=document.getElementById('cust').value.trim();
  const phone=document.getElementById('phone').value.trim();
  const date=document.getElementById('date').value;
  const memo=document.getElementById('memo').value.trim();
  const t = getTimeValue('time'); const reserve=`${t.ap} ${t.hh}:${t.mm}`;

 
};
</script>
<script type="module">
  import { setPendingOrder, startPayment } from '/src/shared/toss-client.js';

  function totalAmount(){
    const el = document.querySelector('[data-total]') || document.getElementById('total');
    const v = el ? (el.getAttribute('data-total') || el.textContent || '0') : '0';
    return Number(String(v).replace(/[^0-9.-]/g,'')) || 0;
  }

  function buildCart(){
    const items = [];
    document.querySelectorAll('[data-cart-item]').forEach(row=>{
      const name = row.getAttribute('data-name') || row.querySelector('.name')?.textContent || '메뉴';
      const qty = Number(row.getAttribute('data-qty') || row.querySelector('.qty')?.textContent || 1);
      const price = Number(row.getAttribute('data-price') || row.querySelector('.price')?.textContent || 0);
      items.push({ name, qty, price });
    });
    return items;
  }

  function customerInfo(){
    const info={};
    const fields={
      name:'#custName,#name',
      phone:'#custPhone,#phone',
      addr:'#custAddr,#address',
      req:'#custNote,#request'
    };
    Object.entries(fields).forEach(([k,sel])=>{
      const el=document.querySelector(sel);
      if(el) info[k]=el.value||el.textContent||'';
    });
    return info;
  }

  function currentTable(){
    const url = new URL(location.href);
    return url.searchParams.get('table');
  }

  function bindPay(){
    const btn =
      document.getElementById('pay-btn') ||
      document.querySelector('[data-action="pay"]') ||
      document.querySelector('.btn-pay, button.pay');

    if (!btn) return;

    btn.addEventListener('click', async (e) => {
      e.preventDefault();

      const cart = { items: buildCart() };
      if (!cart.items.length) {
        alert('장바구니가 비어 있습니다');
        return;
      }

      const customer = customerInfo();
      if (!customer.addr || !customer.name || !customer.phone) {
        alert('주소/이름/연락처를 입력하세요');
        return;
      }

      const orderId = 'ORD-' + Date.now();
      const amount = totalAmount();
      const orderName = document.title || '배달/예약 주문';

      const type = document.getElementById('tab-resv')?.checked ? 'reserve' : 'delivery';

      const payload = {
        type,
        amount,
        orderName,
        cart: cart.items,
        customer,
        table: currentTable()
      };

      setPendingOrder(payload);

      try {
        await startPayment({ orderId, amount, orderName });
      } catch (err) {
        console.error('payment start error', err);
        alert('결제를 시작할 수 없습니다.');
      }
    });
  }

  bindPay();
</script>


  
    </body></html>
