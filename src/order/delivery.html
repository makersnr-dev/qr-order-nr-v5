<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <title>ë°°ë‹¬/ì˜ˆì•½</title>
</head>
<body>
<div class="container">
  <div class="hstack" style="justify-content:space-between">
    <h1>ë°°ë‹¬/ì˜ˆì•½</h1>
    <div class="hstack" style="gap:8px">
      <a class="btn" href="/src/order/mypage.html">ë§ˆì´í˜ì´ì§€</a>
      <a class="btn" href="/src/order/select.html">ì£¼ë¬¸ ìœ í˜•</a>
    </div>
  </div>

  <div class="card hstack" style="gap:8px">
    <label><input type="radio" name="tab" id="tab-deliv" checked> ë°°ë‹¬(ê²°ì œ)</label>
    <label><input type="radio" name="tab" id="tab-resv"> ì˜ˆì•½(ë¬´ê²°ì œ)</label>
  </div>

   <div class="card vstack" id="form-box">
    <h3>ë°°ë‹¬/ì˜ˆì•½ ì •ë³´ <span class="small">*</span></h3>

    <div class="vstack" style="gap:10px">
      <!-- ë°°ì†¡ì§€ -->
   <div class="field-row">
  <div class="field-label addr-label">ë°°ì†¡ì§€</div>
  <div class="addr-wrap">
    <input id="addr" class="input" />
    <input id="addr-detail" class="input addr-detail" placeholder="ìƒì„¸ì£¼ì†Œ" />
  </div>
</div>

      <!-- ì£¼ë¬¸ìëª… -->
      <div class="field-row">
        <div class="field-label">ì£¼ë¬¸ìëª…</div>
        <input id="cust" class="input" />
      </div>

      <!-- ì—°ë½ì²˜ -->
      <div class="field-row">
  <div class="field-label">ì—°ë½ì²˜</div>
  <input
    id="phone"
    class="input"
    placeholder="ìˆ«ìë§Œ ê¸°ì…"
    inputmode="numeric"
  />
</div>


      <!-- ì¼ì + ì˜ˆì•½ì‹œê°„ -->
      <div class="field-row">
  <div class="field-label">ì¼ì</div>
  <div class="date-time-row">
    <input id="date" type="date" class="input date-input">

    <span class="time-label">ì˜ˆì•½ì‹œê°„</span>

    <select id="time-ap" class="input input-sm time-ap"></select>
    <select id="time-hh" class="input input-sm"></select>
    <select id="time-mm" class="input input-sm"></select>
  </div>
</div>


      <!-- ìš”ì²­ì‚¬í•­ -->
      <div class="field-row">
        <div class="field-label">ìš”ì²­ì‚¬í•­</div>
        <textarea id="memo" class="input" rows="4"></textarea>
      </div>

      <!-- ì˜ˆì•½(ë¬´ê²°ì œ)ì¼ ë•Œë§Œ ë³´ì´ëŠ” ê³„ì¢Œ ì•ˆë‚´ -->
      <div id="bank-box" class="field-row small" style="display:none">
        <div class="field-label">ì…ê¸ˆê³„ì¢Œ</div>
        <div class="hstack" style="gap:6px;flex-wrap:wrap">
          <span id="bank-text"></span>
          <button class="btn" id="bank-copy" type="button">ë³µì‚¬</button>
        </div>
        <!-- ğŸ”½ ì•ˆë‚´ ë¬¸êµ¬ ì¶”ê°€ -->
  <div class="small" style="margin-top:4px; color:#f97316;">
    â€» ì£¼ë¬¸ìëª…ìœ¼ë¡œ ì…ê¸ˆí•´ì£¼ì„¸ìš”!
  </div>
      </div>
    </div>
  </div>


  <div class="card vstack">
    <h3>ë©”ë‰´</h3>
    <div id="menu-grid" class="hstack" style="gap:12px;flex-wrap:wrap"></div>
  </div>

  <div class="card vstack">
    <h3>ì¥ë°”êµ¬ë‹ˆ</h3>
    <div id="cart-box" class="vstack"></div>
  </div>

  <div class="card hstack" style="justify-content:space-between">
    <div>í•©ê³„: <b id="total">0</b>ì›</div>
    <button id="action-btn" class="btn primary">ê²°ì œí•˜ê¸°</button>
  </div>
</div>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script type="module">
import { requireCust } from '/src/order/assets/js/modules/cust-auth.js';
import { renderMenu, makeCart } from '/src/order/assets/js/modules/menu-cart.js';
import { get, patch } from '/src/order/assets/js/modules/cust-store.js';
import { fillTimeSelectors, getTimeValue } from '/src/order/assets/js/modules/time.js';
import { setPendingOrder, startPayment } from '/src/shared/toss-client.js';

await requireCust();
const url = new URL(location.href);
const storeId = url.searchParams.get('store') || 'store1';

  
// ì˜ˆì•½ ì‹œê°„ ì„ íƒ ì…‹ì—…
fillTimeSelectors('time');

// ì¥ë°”êµ¬ë‹ˆ / ë©”ë‰´
const cart = makeCart('cart-box', 'total');
cart.render();
renderMenu('menu-grid', cart);

// íƒ­ ì „í™˜ UI
function updateTab() {
  const isResv = document.getElementById('tab-resv').checked;
  const bank = get(['admin','ownerBank']) || { bank:'', number:'', holder:'' };

  document.getElementById('bank-box').style.display = isResv ? 'block' : 'none';
  document.getElementById('action-btn').textContent = isResv ? 'ì˜ˆì•½í•˜ê¸°' : 'ê²°ì œí•˜ê¸°';

  document.getElementById('bank-text').textContent =
    bank.bank && bank.number
      ? `${bank.bank} ${bank.number} (${bank.holder || ''})`
      : '(ê´€ë¦¬ìì— ê³„ì¢Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤)';
}
['tab-deliv','tab-resv'].forEach(id => {
  document.getElementById(id).addEventListener('change', updateTab);
});
updateTab();

// ê³„ì¢Œ ë³µì‚¬
document.getElementById('bank-copy').onclick = () => {
  const txt = document.getElementById('bank-text').textContent;
  if (txt) navigator.clipboard.writeText(txt);
};

// ë°°ì†¡ì§€ ì£¼ì†Œ ì°¾ê¸° (Daum ìš°í¸ë²ˆí˜¸)
function openAddrSearch() {
  if (!window.daum || !window.daum.Postcode) {
    alert('ì£¼ì†Œ ê²€ìƒ‰ ì„œë¹„ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    return;
  }
  new window.daum.Postcode({
    oncomplete: function (data) {
      const addrInput = document.getElementById('addr');
      if (!addrInput) return;
      const addr =
        data.roadAddress ||
        data.jibunAddress ||
        data.address ||
        '';
      addrInput.value = addr;
      addrInput.focus();
    },
  }).open();
}

// "ë°°ì†¡ì§€" ë¼ë²¨ í´ë¦­ ì‹œ ì£¼ì†Œê²€ìƒ‰ ì—´ê¸°
const addrLabel = document.querySelector('.addr-label');
if (addrLabel) {
  addrLabel.addEventListener('click', openAddrSearch);
  addrLabel.classList.add('clickable-label');
}

// ì¸í’‹ í´ë¦­ìœ¼ë¡œë„ ì—´ê³  ì‹¶ìœ¼ë©´ (ì›í•˜ë©´ ìœ ì§€)
const addrInput = document.getElementById('addr');
if (addrInput) {
  addrInput.addEventListener('click', (e) => {
    if (!addrInput.value) openAddrSearch();
  });
}


// ì—°ë½ì²˜ ìˆ«ìë§Œ + í•˜ì´í”ˆ ìë™ í¬ë§·
function formatPhone(raw) {
  const digits = String(raw || '').replace(/\D/g, '');
  if (digits.length === 10) {
    // ì˜ˆ: 0101234567 â†’ 010-123-4567
    return digits.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
  }
  if (digits.length === 11) {
    // ì˜ˆ: 01012345678 â†’ 010-1234-5678
    return digits.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
  }
  // ê·¸ ì™¸ ê¸¸ì´ëŠ” ê·¸ëƒ¥ ìˆ«ìë§Œ ë¦¬í„´ (ê²€ì¦ì—ì„œ ê±¸ëŸ¬ì§)
  return digits;
}

// ì…ë ¥ ì¤‘ì—ëŠ” ìˆ«ìë§Œ ìœ ì§€
const phoneInput = document.getElementById('phone');
if (phoneInput) {
  phoneInput.addEventListener('input', () => {
    const digits = phoneInput.value.replace(/\D/g, '');
    phoneInput.value = digits; // íƒ€ì´í•‘ ì¤‘ì—ëŠ” í•˜ì´í”ˆ ì—†ì´ ìˆ«ìë§Œ
  });

  // í¬ì»¤ìŠ¤ ë¹ ì§ˆ ë•Œ ìë™ í¬ë§·
  phoneInput.addEventListener('blur', () => {
    const formatted = formatPhone(phoneInput.value);
    phoneInput.value = formatted || phoneInput.value;
  });
}


  
// í•©ê³„ ê³„ì‚°
function totalAmount() {
  if (typeof cart.total === 'function') return cart.total();
  if (Array.isArray(cart.items)) {
    return cart.items.reduce((s,i)=>s + Number(i.price||0)*Number(i.qty||1),0);
  }
  return 0;
}

// ë©”ì¸ ë²„íŠ¼ ë™ì‘
document.getElementById('action-btn').onclick = async (e) => {
  e.preventDefault();

  const addrBase    = document.getElementById('addr').value.trim();
  const addrDetail  = (document.getElementById('addr-detail')?.value || '').trim();
  const addr        = addrDetail ? `${addrBase} ${addrDetail}` : addrBase;

  const cust        = document.getElementById('cust').value.trim();
  const rawPhone    = document.getElementById('phone').value.trim();
  const digitsPhone = rawPhone.replace(/\D/g, '');

  const dateInput   = document.getElementById('date').value;
  const memo        = document.getElementById('memo').value.trim();
  const isResv      = document.getElementById('tab-resv').checked;

  const items = cart.items || [];

  // ê³µí†µ ì²´í¬
  if (!items.length) {
    alert('ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
    return;
  }
  if (!addr || !cust) {
    alert('ì£¼ì†Œ / ì£¼ë¬¸ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  if (digitsPhone.length < 10) {
    alert('ì—°ë½ì²˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”. ìˆ«ì 10ìë¦¬ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    document.getElementById('phone').focus();
    return;
  }

  const phone = formatPhone(rawPhone);

  // ì‹œê°„ ê°’ ê°€ì ¸ì˜¤ê¸°
  const { ap, hh, mm } = getTimeValue('time') || {};
  const hasTime =
    ap && hh && mm &&
    hh !== 'ì‹œ' && mm !== 'ë¶„' && // í˜¹ì‹œ placeholder ì“°ëŠ” ê²½ìš° ëŒ€ë¹„
    hh !== '' && mm !== '';

  let reserveDate = null;
  let reserveTime = null;

  // âœ… ì˜ˆì•½(ë¬´ê²°ì œ): ë‚ ì§œ + ì‹œê°„ í•„ìˆ˜
  if (isResv) {
    if (!dateInput) {
      alert('ì˜ˆì•½ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    if (!hasTime) {
      alert('ì˜ˆì•½ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    reserveDate = dateInput;
    reserveTime = `${ap} ${hh}:${mm}`;

    const payload = {
      type: 'reserve',
      amount: totalAmount(),
      orderName: 'ì˜ˆì•½ ì£¼ë¬¸',
      cart: items,
      customer: {
        name: cust,
        phone,
        addr,
        req: memo,
      },
      reserveDate,
      reserveTime,
      status: 'ëŒ€ê¸°',
      storeId,  
    };

    try {
      const res = await fetch('/api/orders', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await res.json();
      if (!data.ok) throw new Error('save failed');

      location.replace('/src/order/reserve-success.html');
    } catch (err) {
      console.error('reserve save err', err);
      alert('ì˜ˆì•½ ì •ë³´ë¥¼ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    }

    return; // ğŸ”´ ì˜ˆì•½ ë¶„ê¸° ë
  }

  // âœ… ë°°ë‹¬(ê²°ì œ): ë‚ ì§œ/ì‹œê°„ ì„ íƒí–ˆìœ¼ë©´ ê°™ì´ ì €ì¥, ì•„ë‹ˆì–´ë„ í†µê³¼
  if (dateInput && hasTime) {
    reserveDate = dateInput;
    reserveTime = `${ap} ${hh}:${mm}`;
  }

  const total = totalAmount();
  if (!total) {
    alert('ê²°ì œ ê¸ˆì•¡ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    return;
  }

  const orderId = 'DELIV-' + Date.now();
  const orderName = 'ë°°ë‹¬ ì£¼ë¬¸';

  const pendingPayload = {
    type: 'delivery',
    amount: total,
    orderName,
    cart: items,
    customer: {
      name: cust,
      phone,
      addr,
      req: memo,
    },
    reserveDate,
    reserveTime,
    storeId
  };

  setPendingOrder(pendingPayload);

  try {
    await startPayment({ orderId, amount: total, orderName });
  } catch (err) {
    console.error('payment start error', err);
    alert('ê²°ì œë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
};

  
</script>
</body>
</html>
