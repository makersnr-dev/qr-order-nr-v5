<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <title>ì˜ˆì•½</title>
</head>

<body data-store-id="">
<!-- ============================
   â­ storeId ìë™ ì´ˆê¸°í™”
============================ -->
<script type="module">
  import { ensureStoreInitialized } from '/src/shared/store.js';

  const storeId = ensureStoreInitialized();
  window.qrnrStoreId = storeId;
  document.body.dataset.storeId = storeId;

  const url = new URL(location.href);
  if (!url.searchParams.get('store')) {
    url.searchParams.set('store', storeId);
    history.replaceState(null, "", url.toString());
  }
</script>

<div class="container">
  <div class="hstack" style="justify-content:space-between">
    <h1>ì˜ˆì•½</h1>
    <div class="hstack" style="gap:8px">
      <a id="btn-mypage" class="btn" href="#">ë§ˆì´í˜ì´ì§€</a>
    </div>
  </div>

  <div class="card vstack" id="form-box">
    <h3>ì˜ˆì•½ ì •ë³´ <span class="small">*</span></h3>

    <div class="vstack" style="gap:10px">
      <!-- ë°°ì†¡ì§€ -->
      <div class="field-row">
        <div class="field-label addr-label clickable-label">ë°°ì†¡ì§€</div>
        <div class="addr-wrap">
          <input id="addr" class="input"/>
          <input id="addr-detail" class="input addr-detail" placeholder="ìƒì„¸ì£¼ì†Œ"/>
        </div>
      </div>

      <!-- ì£¼ë¬¸ìëª… -->
      <div class="field-row">
        <div class="field-label">ì£¼ë¬¸ìëª…</div>
        <input id="cust" class="input"/>
      </div>

      <!-- ì—°ë½ì²˜ -->
      <div class="field-row">
        <div class="field-label">ì—°ë½ì²˜</div>
        <input id="phone" class="input" placeholder="ìˆ«ìë§Œ ê¸°ì…" inputmode="numeric"/>
      </div>

      <!-- ì˜ˆì•½ ì¼ì -->
      <div class="field-row" id="date-row">
        <div class="field-label">ì¼ì</div>
        <div class="date-time-row">
          <input id="date" type="date" class="input date-input">
          <span class="time-label">ì˜ˆì•½ì‹œê°„</span>
          <select id="time-ap" class="input input-sm time-ap"></select>
          <select id="time-hh" class="input input-sm"></select>
          <select id="time-mm" class="input input-sm"></select>
        </div>
      </div>

      <!-- ìš”ì²­ì‚¬í•­ -->
      <div class="field-row">
        <div class="field-label">ìš”ì²­ì‚¬í•­</div>
        <textarea id="memo" class="input" rows="4"></textarea>
      </div>

      <!-- ì˜ˆì•½ìš© ê³„ì¢Œ -->
      <div id="bank-box" class="field-row small">
        <div class="field-label">ì…ê¸ˆê³„ì¢Œ</div>
        <div class="hstack" style="gap:6px;flex-wrap:wrap">
          <span id="bank-text"></span>
          <button class="btn" id="bank-copy" type="button">ë³µì‚¬</button>
        </div>
        <div class="small" style="margin-top:4px;color:#f97316;">
          â€» ì£¼ë¬¸ìëª…ìœ¼ë¡œ ì…ê¸ˆí•´ì£¼ì„¸ìš”!
        </div>
      </div>
    </div>
  </div>

  <!-- ë©”ë‰´ -->
  <div class="card vstack">
    <h3>ë©”ë‰´</h3>
    <div id="menu-grid" class="hstack" style="gap:12px;flex-wrap:wrap"></div>
  </div>

  <!-- ì¥ë°”êµ¬ë‹ˆ -->
  <div class="card vstack">
    <h3>ì¥ë°”êµ¬ë‹ˆ</h3>
    <div id="cart-box" class="vstack"></div>
  </div>

  <div class="card hstack" style="justify-content:space-between">
    <div>í•©ê³„: <b id="total">0</b>ì›</div>
    <button id="action-btn" class="btn primary">ì˜ˆì•½í•˜ê¸°</button>
  </div>
</div>

<!-- ì˜ˆì•½ ì™„ë£Œ ëª¨ë‹¬ -->
<div id="reserve-done-modal" style="
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.55); z-index:9999;
  align-items:center; justify-content:center;">
  <div style="
    background:#0d1117;
    padding:24px 22px;
    border-radius:16px;
    max-width:420px;
    width:calc(100% - 40px);
    text-align:center;">
    <h3 style="margin-bottom:8px;">ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h3>
    <p class="small" style="line-height:1.6;">
      ì•„ë˜ ê³„ì¢Œë¡œ <b>1ì‹œê°„ ì´ë‚´</b>ì—<br>
      <b id="reserve-amount"></b>ì›ì„ ì…ê¸ˆí•´ì£¼ì„¸ìš”.
    </p>
    <div class="small" style="margin:10px 0;color:#9ca3af;">
      <span id="reserve-bank"></span>
    </div>
    <button id="reserve-done-ok" class="btn primary" style="width:100%;">
      í™•ì¸
    </button>
  </div>
</div>


<!-- ë‹¤ìŒì£¼ì†Œ -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script type="module">
  import { requireCust } from '/src/order/assets/js/modules/cust-auth.js';
  import { renderMenu, makeCart } from '/src/order/assets/js/modules/menu-cart.js';
  import { get } from '/src/order/assets/js/modules/cust-store.js';
  import { fillTimeSelectors, getTimeValue } from '/src/order/assets/js/modules/time.js';
  //import { setPendingOrder, startPayment } from '/src/shared/toss-client.js';

  await requireCust();

  const storeId = window.qrnrStoreId;

  // ìƒë‹¨ ë²„íŠ¼ ìë™ storeId ì ìš©
  const mp = document.getElementById("btn-mypage");
  if (mp) mp.href = `/src/order/mypage.html?store=${storeId}`;

  /* -------------------- ì‹œê°„/ì¥ë°”êµ¬ë‹ˆ/ë©”ë‰´ -------------------- */
  fillTimeSelectors('time');
  const cart = makeCart('cart-box', 'total');
  cart.render();
  renderMenu('menu-grid', cart);
  /* -------- ì…ê¸ˆê³„ì¢Œ ì´ˆê¸° í‘œì‹œ (ê´€ë¦¬ì ì„¤ì •ê°’) -------- */
  const initBank =
    get(["admin", "ownerBank", storeId]) ||
    get(["admin", "ownerBank"]) ||
    {};
  
  document.getElementById("bank-text").textContent =
    initBank.bank && initBank.number
      ? `${initBank.bank} ${initBank.number} (${initBank.holder || ""})`
      : "ê´€ë¦¬ì ê³„ì¢Œ ì •ë³´ ì—†ìŒ";


  /* -------------------- ì „í™”ë²ˆí˜¸ ì²˜ë¦¬ -------------------- */
  const phoneInput = document.getElementById("phone");
  phoneInput.addEventListener("input", () => {
    phoneInput.value = phoneInput.value.replace(/\D/g, "");
  });
  phoneInput.addEventListener("blur", () => {
    const d = phoneInput.value.replace(/\D/g, "");
    if (d.length === 10) phoneInput.value = d.replace(/(\d{3})(\d{3})(\d{4})/, "$1-$2-$3");
    if (d.length === 11) phoneInput.value = d.replace(/(\d{3})(\d{4})(\d{4})/, "$1-$2-$3");
  });

  /* -------------------- ì£¼ì†Œ ê²€ìƒ‰ -------------------- */
  function openAddrSearch() {
    new window.daum.Postcode({
      oncomplete: data => {
        const addrInput = document.getElementById("addr");
        addrInput.value = data.roadAddress || data.jibunAddress || data.address;
      }
    }).open();
  }
  document.querySelector(".addr-label").onclick = openAddrSearch;
  document.getElementById("addr").onclick = () => {
    if (!document.getElementById("addr").value) openAddrSearch();
  };

  /* -------------------- ê³„ì¢Œ ë³µì‚¬ -------------------- */
  document.getElementById("bank-copy").onclick = async () => {
    const txt = document.getElementById("bank-text").textContent.trim();
    if (!txt || txt.startsWith("(")) return alert("ë³µì‚¬í•  ê³„ì¢Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
    await navigator.clipboard.writeText(txt);
    alert("ê³„ì¢Œë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
  };

  /* -------------------- ì˜ˆì•½/ê²°ì œ ì œì¶œ -------------------- */
  document.getElementById("action-btn").onclick = async () => {
    const addr1 = document.getElementById("addr").value.trim();
    const addr2 = document.getElementById("addr-detail").value.trim();
    const addr = addr2 ? `${addr1} ${addr2}` : addr1;

    const cust = document.getElementById("cust").value.trim();
    const phone = phoneInput.value.trim();
    const memo = document.getElementById("memo").value.trim();
    const items = cart.items || [];

    if (!items.length) return alert("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
    if (!cust || !addr) return alert("ì£¼ì†Œ/ì£¼ë¬¸ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    if (phone.replace(/\D/g, "").length < 10) return alert("ì—°ë½ì²˜ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");


    const total = cart.total();
   

    /* -------------------- ì˜ˆì•½ ì²˜ë¦¬ -------------------- */
      const date = document.getElementById("date").value;
      const { ap, hh, mm } = getTimeValue("time");

      if (!date) {
        alert("ì˜ˆì•½ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }
      
      if (
        !ap || !hh || !mm ||
        ap === "ì˜¤ì „/ì˜¤í›„" ||
        hh === "ì‹œ" ||
        mm === "ë¶„"
      ) {
        alert("ì˜ˆì•½ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }

      const payload = {
        type: "reserve",
        amount: total,
        orderName: "ì˜ˆì•½ ì£¼ë¬¸",
        cart: items,
        customer: { name: cust, phone, addr, req: memo },
        reserveDate: date,
        reserveTime: `${ap} ${hh}:${mm}`,
        status: "ëŒ€ê¸°",
        storeId
      };

    // ğŸ”’ ì¤‘ë³µ ì˜ˆì•½ ë°©ì§€
    document.getElementById("action-btn").disabled = true;
    
    let r, j;
    try {
      r = await fetch("/api/orders", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(payload)
      });
      j = await r.json();
    } catch (e) {
      document.getElementById("action-btn").disabled = false;
      return alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
    
    if (!j.ok) {
      document.getElementById("action-btn").disabled = false;
      return alert("ì˜ˆì•½ ì €ì¥ ì‹¤íŒ¨!");
    }


    // âœ… ì˜ˆì•½ ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ
      const bank =
        get(["admin", "ownerBank", storeId]) ||
        get(["admin", "ownerBank"]) ||
        {};
      document.getElementById("bank-text").textContent =
      bank.bank && bank.number
        ? `${bank.bank} ${bank.number} (${bank.holder || ""})`
        : "ê´€ë¦¬ì ê³„ì¢Œ ì •ë³´ ì—†ìŒ";
      document.getElementById("reserve-amount").textContent =
        cart.total().toLocaleString()+"ì›";
      
      document.getElementById("reserve-bank").textContent =
        bank.bank && bank.number
          ? `${bank.bank} ${bank.number} (${bank.holder || ""})`
          : "ê´€ë¦¬ì ê³„ì¢Œ ì •ë³´ ì—†ìŒ";
      
      document.getElementById("reserve-done-modal").style.display = "flex";

    


    /* -------------------- ë°°ë‹¬ ê²°ì œ -------------------- */
    /*const orderId = "DELIV-" + Date.now();
    const orderName = "ë°°ë‹¬ ì£¼ë¬¸";

    setPendingOrder({
      type: "delivery",
      amount: total,
      orderName,
      cart: items,
      customer: { name: cust, phone, addr, req: memo },
      storeId,
      returnTo: location.pathname + location.search
    });

    try {
      await startPayment({ orderId, amount: total, orderName });
    } catch {
      alert("ê²°ì œë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }*/
  };
  document.getElementById("reserve-done-ok").onclick = () => {
    document.getElementById("reserve-done-modal").style.display = "none";
  document.getElementById("action-btn").disabled = false;
    // ì…ë ¥ ì´ˆê¸°í™”
    document.getElementById("addr").value = "";
    document.getElementById("addr-detail").value = "";
    document.getElementById("cust").value = "";
    document.getElementById("phone").value = "";
    document.getElementById("memo").value = "";
    document.getElementById("date").value = "";
    document.getElementById("time-ap").selectedIndex = 0;
    document.getElementById("time-hh").selectedIndex = 0;
    document.getElementById("time-mm").selectedIndex = 0;

      
  
    cart.items.length = 0;  // ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸°
cart.render();          // í™”ë©´ ê°±ì‹ 

      window.scrollTo({ top: 0, behavior: "smooth" });

  };

</script>

</body>
</html>
