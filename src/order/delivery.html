<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <title>배달/예약</title>
</head>
<body>
<div class="container">
  <div class="hstack" style="justify-content:space-between">
    <h1>배달/예약</h1>
    <div class="hstack" style="gap:8px">
      <a class="btn" href="/src/order/mypage.html">마이페이지</a>
      <!-- 주문 유형 선택 페이지는 나중에 제거 예정이니 일단 주석 -->
      <!-- <a class="btn" href="/src/order/select.html">주문 유형</a> -->
    </div>
  </div>

  <div class="card hstack" style="gap:8px">
    <label><input type="radio" name="tab" id="tab-deliv" checked> 배달(결제)</label>
    <label><input type="radio" name="tab" id="tab-resv"> 예약(무결제)</label>
  </div>

  <div class="card vstack" id="form-box">
    <h3>배달/예약 정보 <span class="small">*</span></h3>

    <div class="vstack" style="gap:10px">
      <!-- 배송지 -->
      <div class="field-row">
        <div class="field-label addr-label">배송지</div>
        <div class="addr-wrap">
          <input id="addr" class="input" />
          <input id="addr-detail" class="input addr-detail" placeholder="상세주소" />
        </div>
      </div>

      <!-- 주문자명 -->
      <div class="field-row">
        <div class="field-label">주문자명</div>
        <input id="cust" class="input" />
      </div>

      <!-- 연락처 -->
      <div class="field-row">
        <div class="field-label">연락처</div>
        <input id="phone" class="input" placeholder="숫자만 기입" inputmode="numeric" />
      </div>

      <!-- 일자 + 예약시간 (예약에서만 사용) -->
      <div class="field-row" id="date-row">
        <div class="field-label">일자</div>
        <div class="date-time-row">
          <input id="date" type="date" class="input date-input">
          <span class="time-label">예약시간</span>
          <select id="time-ap" class="input input-sm time-ap"></select>
          <select id="time-hh" class="input input-sm"></select>
          <select id="time-mm" class="input input-sm"></select>
        </div>
      </div>

      <!-- 요청사항 -->
      <div class="field-row">
        <div class="field-label">요청사항</div>
        <textarea id="memo" class="input" rows="4"></textarea>
      </div>

      <!-- ✅ 개인정보 수집·이용 동의 (요청사항 아래로 이동) -->
      <div class="field-row">
        <div class="field-label">개인정보</div>
        <div class="vstack" style="gap:4px">
          <label class="hstack small" style="gap:6px;align-items:flex-start">
            <input type="checkbox" id="agree-privacy" style="margin-top:3px">
            <span>
              (필수) 배달/예약 주문을 위해 이름, 연락처, 주소를 수집·이용하는 것에 동의합니다.<br/>
              수집된 정보는 주문 처리 및 고객 응대 목적으로만 사용되며, 관련 법령에 따른 보관 기간 후 안전하게 파기됩니다.
            </span>
          </label>
          <button type="button" id="privacy-open" class="btn small" style="align-self:flex-start;">
            개인정보 처리방침 전문 보기
          </button>
        </div>
      </div>

      <!-- 예약(무결제)일 때만 보이는 계좌 안내 -->
      <div id="bank-box" class="field-row small" style="display:none">
        <div class="field-label">입금계좌</div>
        <div class="hstack" style="gap:6px;flex-wrap:wrap">
          <span id="bank-text"></span>
          <button class="btn" id="bank-copy" type="button">복사</button>
        </div>
        <div class="small" style="margin-top:4px; color:#f97316;">
          ※ 주문자명으로 입금해주세요!
        </div>
      </div>
    </div>
  </div>

  <div class="card vstack">
    <h3>메뉴</h3>
    <div id="menu-grid" class="hstack" style="gap:12px;flex-wrap:wrap"></div>
  </div>

  <div class="card vstack">
    <h3>장바구니</h3>
    <div id="cart-box" class="vstack"></div>
  </div>

  <div class="card hstack" style="justify-content:space-between">
    <div>합계: <b id="total">0</b>원</div>
    <button id="action-btn" class="btn primary">결제하기</button>
  </div>
</div>

<!-- ✅ 개인정보 처리방침 모달 -->
<div id="privacy-modal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  z-index:9998;
  align-items:center;
  justify-content:center;
">
  <div style="
    background:#020617;
    border-radius:12px;
    padding:16px 18px;
    max-width:520px;
    width:calc(100% - 40px);
    max-height:80vh;
    overflow:auto;
    box-shadow:0 10px 40px rgba(0,0,0,0.45);
    font-size:13px;
  ">
    <h3 style="margin:0 0 8px 0;">개인정보 처리방침</h3>
    <div id="privacy-modal-body" class="small" style="white-space:pre-wrap; line-height:1.5;">
[개인정보 수집·이용 안내]

1. 수집 항목
- 필수: 주문자 이름, 연락처, 배송지 주소, 주문 내역

2. 수집·이용 목적
- 배달/예약 주문 접수 및 처리
- 고객 문의 대응 및 주문 관련 안내

3. 보유 및 이용 기간
- 관련 법령(전자상거래 등에서의 소비자 보호에 관한 법률 등)에 따른 보존 기간 동안 보관 후 지체 없이 파기됩니다.
- 단, 분쟁 발생 시 해결을 위한 범위 내에서 추가 보관될 수 있습니다.

4. 동의 거부 권리 및 불이익
- 이용자는 개인정보 수집·이용에 대한 동의를 거부할 권리가 있습니다.
- 다만, 필수 항목에 대한 동의를 거부할 경우 배달/예약 서비스 이용이 제한될 수 있습니다.

5. 기타
- 개인정보 처리와 관련된 상세 문의는 매장 운영자에게 연락해주시기 바랍니다.
    </div>
    <div class="hstack" style="justify-content:flex-end;margin-top:12px;gap:8px">
      <button type="button" id="privacy-close" class="btn">닫기</button>
    </div>
  </div>
</div>

<!-- 다음 우편번호 -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script type="module">
  import { requireCust } from '/src/order/assets/js/modules/cust-auth.js';
  import { renderMenu, makeCart } from '/src/order/assets/js/modules/menu-cart.js';
  import { get } from '/src/order/assets/js/modules/cust-store.js';
  import { fillTimeSelectors, getTimeValue } from '/src/order/assets/js/modules/time.js';
  import { setPendingOrder, startPayment } from '/src/shared/toss-client.js';

  await requireCust();

  // URL 파라미터
  const url = new URL(location.href);
  const storeId = url.searchParams.get('store') || 'store1';

  // 시간 선택 셋업 (예약에서만 사용하지만 미리 채워두기)
  fillTimeSelectors('time');

  // 장바구니 / 메뉴
  const cart = makeCart('cart-box', 'total');
  cart.render();
  renderMenu('menu-grid', cart);

  // ✅ 토스트 UI: 복사되었습니다 표시용
  let copyToastTimer = null;
  function showCopyToast(message = '복사되었습니다.') {
    let box = document.getElementById('copy-toast');
    if (!box) {
      box = document.createElement('div');
      box.id = 'copy-toast';
      box.style.position = 'fixed';
      box.style.left = '50%';
      box.style.bottom = '24px';
      box.style.transform = 'translateX(-50%)';
      box.style.padding = '8px 16px';
      box.style.borderRadius = '999px';
      box.style.fontSize = '13px';
      box.style.background = 'rgba(0,0,0,0.75)';
      box.style.color = '#fff';
      box.style.zIndex = '9999';
      box.style.opacity = '0';
      box.style.transition = 'opacity 0.2s ease';
      document.body.appendChild(box);
    }
    box.textContent = message;

    // 이미 떠있는 상태면 타이머 리셋
    if (copyToastTimer) {
      clearTimeout(copyToastTimer);
      copyToastTimer = null;
    }

    // 살짝 보였다가 3초 후 사라짐
    requestAnimationFrame(() => {
      box.style.opacity = '1';
      copyToastTimer = setTimeout(() => {
        box.style.opacity = '0';
      }, 3000);
    });
  }

  // 탭 전환 UI
  function updateTab() {
    const isResv = document.getElementById('tab-resv').checked;

    // 매장별 계좌정보 (신규 구조) → 없으면 구 구조 fallback
    const bank =
      get(['admin', 'ownerBank', storeId]) ||
      get(['admin', 'ownerBank']) ||
      { bank:'', number:'', holder:'' };

    // 예약일 때만 계좌 안내 노출
    document.getElementById('bank-box').style.display = isResv ? 'block' : 'none';
    document.getElementById('action-btn').textContent = isResv ? '예약하기' : '결제하기';

    document.getElementById('bank-text').textContent =
      bank.bank && bank.number
        ? `${bank.bank} ${bank.number} (${bank.holder || ''})`
        : '(관리자에 계좌 정보가 없습니다)';

    // 🔹 예약일 때만 날짜/시간 입력 보이기
    const dateRow = document.getElementById('date-row');
    if (dateRow) {
      dateRow.style.display = isResv ? '' : 'none';
    }
  }

  ['tab-deliv','tab-resv'].forEach(id => {
    document.getElementById(id).addEventListener('change', updateTab);
  });
  updateTab();

  // ✅ 계좌 복사 + 토스트
  const bankCopyBtn = document.getElementById('bank-copy');
  if (bankCopyBtn) {
    bankCopyBtn.onclick = async () => {
      const txt = document.getElementById('bank-text').textContent.trim();
      if (!txt || txt.startsWith('(관리자에 계좌 정보가 없습니다')) {
        alert('복사할 계좌 정보가 없습니다.');
        return;
      }
      try {
        await navigator.clipboard.writeText(txt);
        showCopyToast('계좌번호가 복사되었습니다.');
      } catch (e) {
        console.error('clipboard error', e);
        // Clipboard API 미지원 브라우저용
        showCopyToast('복사를 지원하지 않는 브라우저입니다.');
      }
    };
  }

  // 주소 검색
  function openAddrSearch() {
    if (!window.daum || !window.daum.Postcode) {
      alert('주소 검색 서비스를 불러오지 못했습니다. 새로고침 후 다시 시도해주세요.');
      return;
    }
    new window.daum.Postcode({
      oncomplete: function (data) {
        const addrInput = document.getElementById('addr');
        if (!addrInput) return;
        const addr = data.roadAddress || data.jibunAddress || data.address || '';
        addrInput.value = addr;
        addrInput.focus();
      },
    }).open();
  }

  // "배송지" 라벨 클릭 시 주소검색
  const addrLabel = document.querySelector('.addr-label');
  if (addrLabel) {
    addrLabel.addEventListener('click', openAddrSearch);
    addrLabel.classList.add('clickable-label');
  }

  // 빈 칸일 때 인풋 클릭으로도 열기(선택)
  const addrInput = document.getElementById('addr');
  if (addrInput) {
    addrInput.addEventListener('click', () => {
      if (!addrInput.value) openAddrSearch();
    });
  }

  // 연락처 숫자만 + 하이픈 포맷
  function formatPhone(raw) {
    const digits = String(raw || '').replace(/\D/g, '');
    if (digits.length === 10) return digits.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
    if (digits.length === 11) return digits.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
    return digits;
  }

  const phoneInput = document.getElementById('phone');
  if (phoneInput) {
    phoneInput.addEventListener('input', () => {
      const digits = phoneInput.value.replace(/\D/g, '');
      phoneInput.value = digits;
    });
    phoneInput.addEventListener('blur', () => {
      const formatted = formatPhone(phoneInput.value);
      phoneInput.value = formatted || phoneInput.value;
    });
  }

  // ✅ 개인정보 처리방침 모달 열기/닫기
  const privacyModal = document.getElementById('privacy-modal');
  const privacyOpen  = document.getElementById('privacy-open');
  const privacyClose = document.getElementById('privacy-close');

  if (privacyOpen && privacyModal) {
    privacyOpen.addEventListener('click', () => {
      privacyModal.style.display = 'flex';
    });
  }
  if (privacyClose && privacyModal) {
    privacyClose.addEventListener('click', () => {
      privacyModal.style.display = 'none';
    });
  }
  if (privacyModal) {
    privacyModal.addEventListener('click', (e) => {
      // 배경 클릭 시 닫기
      if (e.target === privacyModal) {
        privacyModal.style.display = 'none';
      }
    });
  }

  // 합계 계산
  function totalAmount() {
    if (typeof cart.total === 'function') return cart.total();
    if (Array.isArray(cart.items)) {
      return cart.items.reduce((s,i)=>s + Number(i.price||0)*Number(i.qty||1),0);
    }
    return 0;
  }

  // 메인 버튼(결제/예약)
  document.getElementById('action-btn').onclick = async (e) => {
    e.preventDefault();

    const addrBase    = document.getElementById('addr').value.trim();
    const addrDetail  = (document.getElementById('addr-detail')?.value || '').trim();
    const addr        = addrDetail ? `${addrBase} ${addrDetail}` : addrBase;

    const cust        = document.getElementById('cust').value.trim();
    const rawPhone    = document.getElementById('phone').value.trim();
    const digitsPhone = rawPhone.replace(/\D/g, '');

    const dateInput   = document.getElementById('date').value;
    const memo        = document.getElementById('memo').value.trim();
    const isResv      = document.getElementById('tab-resv').checked;

    const agreePrivacy = document.getElementById('agree-privacy')?.checked ?? false;

    const items = cart.items || [];

    // 공통 체크
    if (!items.length) {
      alert('장바구니가 비어 있습니다.');
      return;
    }
    if (!addr || !cust) {
      alert('주소 / 주문자명을 입력해주세요.');
      return;
    }
    if (digitsPhone.length < 10) {
      alert('연락처를 확인해주세요. 숫자 10자리 이상 입력해주세요.');
      document.getElementById('phone').focus();
      return;
    }
    if (!agreePrivacy) {
      alert('개인정보 수집·이용에 동의해 주세요.');
      const agreeBox = document.getElementById('agree-privacy');
      if (agreeBox) agreeBox.focus();
      return;
    }

    const phone = formatPhone(rawPhone);

    // 시간값
    const { ap, hh, mm } = getTimeValue('time') || {};
    const hasTime =
      ap && hh && mm &&
      hh !== '시' && mm !== '분' &&
      hh !== '' && mm !== '';

    let reserveDate = null;
    let reserveTime = null;

    // 🔹 예약(무결제): 날짜+시간 필수
    if (isResv) {
      if (!dateInput) {
        alert('예약 날짜를 선택해주세요.');
        return;
      }
      if (!hasTime) {
        alert('예약 시간을 선택해주세요.');
        return;
      }

      reserveDate = dateInput;
      reserveTime = `${ap} ${hh}:${mm}`;

      const payload = {
        type: 'reserve',
        amount: totalAmount(),
        orderName: '예약 주문',
        cart: items,
        customer: { name: cust, phone, addr, req: memo },
        reserveDate,
        reserveTime,
        status: '대기',
        storeId,
        agreePrivacy: true,      // ✅ 동의 여부 저장
      };

      try {
        const res = await fetch('/api/orders', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (!data.ok) throw new Error('save failed');

        // 돌아갈 원래 페이지(스토어 유지)
        const back = location.pathname + location.search; // 예: /src/order/delivery.html?store=narae
        location.replace(`/src/order/reserve-success.html?returnTo=${encodeURIComponent(back)}`);
      } catch (err) {
        console.error('reserve save err', err);
        alert('예약 정보를 저장하지 못했습니다. 다시 시도해주세요.');
      }
      return;
    }

    // 🔹 배달(결제): 날짜/시간은 사용하지 않음 (reserveDate/Time 저장 X)
    const total = totalAmount();
    if (!total) {
      alert('결제 금액이 올바르지 않습니다.');
      return;
    }

    const orderId = 'DELIV-' + Date.now();
    const orderName = '배달 주문';

    const pendingPayload = {
      type: 'delivery',
      amount: total,
      orderName,
      cart: items,
      customer: { name: cust, phone, addr, req: memo },
      // reserveDate, reserveTime 은 배달에서는 사용하지 않음
      storeId,
      agreePrivacy: true,    // ✅ 동의 여부 저장
      // 결제 성공 후 돌아올 경로(스토어 유지)
      returnTo: location.pathname + location.search
    };

    setPendingOrder(pendingPayload);

    try {
      await startPayment({ orderId, amount: total, orderName /*, returnTo: pendingPayload.returnTo*/ });
    } catch (err) {
      console.error('payment start error', err);
      alert('결제를 시작할 수 없습니다.');
    }
  };
</script>
</body>
</html>
