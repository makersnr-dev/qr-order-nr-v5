<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <title>ë§¤ì¥ ê´€ë¦¬ì ë§¤í•‘ (SUPER)</title>
</head>
<body>
<div class="container">
  <h1>ë§¤ì¥ ê´€ë¦¬ì ë§¤í•‘ (SUPER ì „ìš©)</h1>

  <!-- ğŸ”¹ ë¡œê·¸ì¸ ìƒíƒœ ì˜ì—­ / ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
  <div id="super-status" class="hstack" style="justify-content:space-between;align-items:center;margin-bottom:12px">
    <div id="super-status-text" class="small">ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘...</div>
    <button id="super-logout" class="btn small" style="display:none">SUPER ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <!-- ğŸ”¹ SUPER ë¡œê·¸ì¸ í¼ -->
  <div id="super-login-card" class="card vstack" style="display:none;max-width:420px;margin-bottom:16px">
    <h3>SUPER ë¡œê·¸ì¸</h3>
    <p class="small">
      ì´ í˜ì´ì§€ëŠ” ë§¤ì¥ ê´€ë¦¬ì ê³„ì •ê³¼ ë§¤ì¥ ID(storeId)ë¥¼ ë§¤í•‘í•˜ëŠ”
      <b>ìµœìƒìœ„(SUPER) ê´€ë¦¬ í˜ì´ì§€</b>ì…ë‹ˆë‹¤.<br/>
      Vercel í™˜ê²½ë³€ìˆ˜ <code>SUPER_ADMINS_JSON</code>ì— ë“±ë¡ëœ ê³„ì •ë§Œ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </p>
    <div class="vstack" style="gap:8px;margin-top:8px">
      <input id="super-id" class="input" placeholder="SUPER ì•„ì´ë”” (ì˜ˆ: super)">
      <input id="super-pw" class="input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
      <button id="super-login-btn" class="btn primary">ë¡œê·¸ì¸</button>
      <div id="super-login-msg" class="small" style="color:#f97316;margin-top:4px"></div>
    </div>
  </div>

  <!-- ğŸ”¹ ë§¤í•‘ UI -->
  <div id="mapping-card" class="card vstack" style="display:none">
    <div class="small">
      ê´€ë¦¬ì ê³„ì •(ì•„ì´ë””/ì´ë©”ì¼)ê³¼ ë§¤ì¥ ID(storeId)ë¥¼ ì—°ê²°í•©ë‹ˆë‹¤.<br>
      ë‚˜ì¤‘ì— DBë¡œ ì´ì „í•  ë•Œë„ ë™ì¼í•˜ê²Œ <code>['system','storeAdmins']</code> êµ¬ì¡°ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
    </div>

    <div class="hstack" style="gap:8px;flex-wrap:wrap;margin-top:10px">
      <input id="map-admin" class="input" placeholder="ê´€ë¦¬ì ID (ì˜ˆ: owner@narae.com)" style="min-width:260px">
      <input id="map-store" class="input" placeholder="storeId (ì˜ˆ: narae)" style="min-width:160px">
      <input id="map-note" class="input" placeholder="ë¹„ê³  (ì„ íƒ)">
      <button id="map-add" class="btn primary">ë§¤í•‘ ì¶”ê°€/ìˆ˜ì •</button>
    </div>

    <table class="table" style="margin-top:14px">
      <thead>
      <tr>
        <th>ê´€ë¦¬ì ID</th>
        <th>storeId</th>
        <th>ë¹„ê³ </th>
        <th>ê´€ë¦¬ì ì½˜ì†”</th>
      </tr>
      </thead>
      <tbody id="map-body">
        <tr><td colspan="4" class="small">ë“±ë¡ëœ ë§¤í•‘ ì—†ìŒ</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script type="module">
/* ----------------------------------------------------------
   SUPER ê´€ë¦¬ì ë§¤í•‘ í˜ì´ì§€ ìµœì‹  ë²„ì „ ìŠ¤í¬ë¦½íŠ¸
   - JWT ê¸°ë°˜ SUPER ë¡œê·¸ì¸
   - storeAdmins ë§¤í•‘ (admin.js ì™€ 100% ë™ì¼ ê·œê²©)
----------------------------------------------------------- */

import { get, patch } from '/src/admin/assets/js/modules/store.js';

const $ = (s, r=document) => r.querySelector(s);

const SUPER_TOKEN_KEY = 'qrnr.super.jwt';
const MAP_PATH = ['system', 'storeAdmins'];

// ----------------------------------------------------------
// SUPER JWT UTIL
// ----------------------------------------------------------
function getSuperToken() {
  try { return localStorage.getItem(SUPER_TOKEN_KEY) || ''; }
  catch { return ''; }
}

function setSuperToken(token) {
  try {
    if (token) localStorage.setItem(SUPER_TOKEN_KEY, token);
    else localStorage.removeItem(SUPER_TOKEN_KEY);
  } catch (e) {}
}

function decodeToken(token) {
  if (!token) return null;
  const p = token.split('.');
  if (p.length < 2) return null;

  try { return JSON.parse(atob(p[1])); }
  catch { return null; }
}

// ----------------------------------------------------------
// ë§¤ì¥ ê´€ë¦¬ì ë§¤í•‘ ì €ì¥ì†Œ
// ----------------------------------------------------------
function loadMap() {
  const raw = get(MAP_PATH);
  return raw && typeof raw === 'object' ? { ...raw } : {};
}

function saveMap(map) {
  patch(MAP_PATH, () => map);
}

// ----------------------------------------------------------
// ë§¤í•‘ í…Œì´ë¸” ê·¸ë¦¬ê¸°
// ----------------------------------------------------------
function renderMapTable() {
  const tbody = $('#map-body');
  const map = loadMap();

  tbody.innerHTML = '';

  const entries = Object.entries(map);
  if (!entries.length) {
    tbody.innerHTML = `<tr><td colspan="4" class="small">ë“±ë¡ëœ ë§¤í•‘ ì—†ìŒ</td></tr>`;
    return;
  }

  entries.forEach(([adminId, info]) => {
    const storeId = info?.storeId || '';
    const note = info?.note || '';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${adminId}</td>
      <td>${storeId}</td>
      <td>${note}</td>
      <td class="right">
        <a class="btn small"
           href="/admin?store=${encodeURIComponent(storeId)}"
           target="_blank">ê´€ë¦¬ì ì½˜ì†”</a>
        <button class="btn small" data-del="${adminId}">ì‚­ì œ</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll('[data-del]').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.del;
      if (!confirm(`"${target}" ë§¤í•‘ì„ ì‚­ì œí• ê¹Œìš”?`)) return;
      const map = loadMap();
      delete map[target];
      saveMap(map);
      renderMapTable();
    });
  });
}

// ----------------------------------------------------------
// ë§¤í•‘ ì¶”ê°€ UI
// ----------------------------------------------------------
function bindMappingUI() {
  $('#map-add').onclick = () => {
    const adminId = $('#map-admin').value.trim();
    const storeId = $('#map-store').value.trim();
    const note = $('#map-note').value.trim();

    if (!adminId || !storeId) {
      alert('ê´€ë¦¬ì IDì™€ storeIdëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
      return;
    }

    const map = loadMap();
    map[adminId] = { storeId, note };
    saveMap(map);
    renderMapTable();

    $('#map-admin').value = '';
    $('#map-store').value = '';
    $('#map-note').value = '';
  };
}

// ----------------------------------------------------------
// API í˜¸ì¶œ: super-me / super-login / super-logout
// ----------------------------------------------------------
async function fetchSuperMe() {
  try {
    const r = await fetch('/api/super-me');
    return r.ok ? r.json() : { ok:false };
  } catch {
    return { ok:false };
  }
}

async function superLogin(uid, pwd) {
  const r = await fetch('/api/super-login', {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify({ uid, pwd }),
  });

  return r.json();
}

async function superLogout() {
  try {
    await fetch('/api/super-logout', { method: 'POST' });
  } catch {}
}

// ----------------------------------------------------------
// í˜ì´ì§€ ì´ˆê¸°í™”
// ----------------------------------------------------------
async function init() {
  const statusText = $('#super-status-text');
  const logoutBtn = $('#super-logout');
  const loginCard = $('#super-login-card');
  const mappingCard = $('#mapping-card');

  // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
  const me = await fetchSuperMe();

  if (me.ok && me.isSuper) {
    statusText.textContent = `SUPER ë¡œê·¸ì¸: ${me.superId}`;
    logoutBtn.style.display = 'inline-flex';
    loginCard.style.display = 'none';
    mappingCard.style.display = 'block';

    renderMapTable();
    bindMappingUI();
  } else {
    statusText.textContent =
      'SUPER ë¡œê·¸ì¸ í•„ìš”: SUPER_ADMINS_JSON í™˜ê²½ë³€ìˆ˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
    logoutBtn.style.display = 'none';
    loginCard.style.display = 'block';
    mappingCard.style.display = 'none';
  }

  // ë¡œê·¸ì¸ ë²„íŠ¼
  $('#super-login-btn').onclick = async () => {
    const uid = $('#super-id').value.trim();
    const pw = $('#super-pw').value.trim();
    const msg = $('#super-login-msg');

    if (!uid || !pw) {
      msg.textContent = 'ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
      return;
    }

    msg.textContent = 'ë¡œê·¸ì¸ ì¤‘...';

    const data = await superLogin(uid, pw);

    if (data.ok && data.token) {
      setSuperToken(data.token);
      location.reload();
    } else {
      msg.textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜';
    }
  };

  logoutBtn.onclick = async () => {
    await superLogout();
    setSuperToken('');
    location.reload();
  };
}

init();
</script>
</body>
</html>
