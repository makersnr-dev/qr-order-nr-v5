<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <title>매장 관리자 매핑</title>
</head>
<body>
<div class="container">
  <h1>매장 관리자 매핑</h1>

  <div class="card vstack">
    <div class="small">
      관리자 계정(아이디/이메일)과 매장 ID(storeId)를 연결합니다.<br>
      이 정보는 <b>관리자 콘솔(admin.js)의 storeId 자동 선택</b>에 사용되며,<br>
      현재는 로컬 저장소 기반으로 동작하고, 나중에 DB로 옮길 때도 같은 구조를 그대로 사용할 수 있습니다.
    </div>

    <div class="hstack" style="gap:8px;flex-wrap:wrap;margin-top:10px">
      <input id="map-admin" class="input" placeholder="관리자 ID (예: owner@narae.com)" style="min-width:260px">
      <input id="map-store" class="input" placeholder="storeId (예: store1)" style="min-width:160px">
      <button id="map-add" class="btn primary">매핑 추가/수정</button>
    </div>

    <table class="table" style="margin-top:14px">
      <thead>
        <tr>
          <th>관리자 ID</th>
          <th>storeId</th>
          <th class="right">관리</th>
        </tr>
      </thead>
      <tbody id="map-body">
        <tr><td colspan="3" class="small">등록된 매핑 없음</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script type="module">
  import { requireAuth } from '/src/admin/assets/js/modules/auth.js';
  import { get, patch } from '/src/admin/assets/js/modules/store.js';

  const $ = (s, r=document) => r.querySelector(s);

  // ✅ admin.js 에서 사용하는 키와 맞춤
  //   admin.js: get(['system', 'storeAdmins']) 를 참조하고 있음
  const PATH = ['system', 'storeAdmins'];

  async function ensureAuth() {
    await requireAuth('admin'); // 기존 admin과 동일한 방식으로 보호
  }

  function loadMap() {
    return get(PATH) || {};
  }
  function saveMap(next) {
    patch(PATH, () => next);
  }

  function render() {
    const body = $('#map-body');
    const map = loadMap();

    body.innerHTML = '';

    const entries = Object.entries(map);
    if (!entries.length) {
      body.innerHTML =
        '<tr><td colspan="3" class="small">등록된 매핑 없음</td></tr>';
      return;
    }

    entries.forEach(([adminId, storeId]) => {
      const tr = document.createElement('tr');

      // 관리자 콘솔 링크 (해당 매장 storeId로 진입)
      const consoleHref = `/src/admin/index.html?store=${encodeURIComponent(storeId)}`;

      tr.innerHTML = `
        <td>${adminId}</td>
        <td>${storeId}</td>
        <td class="right">
          <a class="btn small" href="${consoleHref}">관리자 콘솔</a>
          <button class="btn small" data-del="${adminId}">삭제</button>
        </td>
      `;
      body.appendChild(tr);
    });

    // 삭제 버튼 바인딩
    body.querySelectorAll('[data-del]').forEach(btn => {
      btn.onclick = () => {
        const id = btn.getAttribute('data-del');
        const map = loadMap();
        delete map[id];
        saveMap(map);
        render();
      };
    });
  }

  function bind() {
    $('#map-add').onclick = () => {
      const adminId = ($('#map-admin').value || '').trim();
      const storeId = ($('#map-store').value || '').trim();

      if (!adminId || !storeId) {
        alert('관리자 ID와 storeId를 모두 입력하세요.');
        return;
      }

      const map = loadMap();
      map[adminId] = storeId;
      saveMap(map);
      render();
    };

    // (선택) 현재 로그인 관리자 ID가 localStorage에 있으면 자동 채워주기
    try {
      const info = JSON.parse(localStorage.getItem('qrnr.adminInfo') || '{}');
      const id = info.id || info.email;
      if (id && $('#map-admin')) {
        $('#map-admin').value = id;
      }
    } catch (e) {
      // 무시해도 됨
    }
  }

  (async () => {
    await ensureAuth();
    render();
    bind();
  })();
</script>
</body>
</html>
