<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <title>๋งค์ฅ ๊ด๋ฆฌ์ ๋งคํ (SUPER)</title>
</head>
<body>
<div class="container">
  <h1>๋งค์ฅ ๊ด๋ฆฌ์ ๋งคํ (SUPER ์์ฉ)</h1>

  <!-- ๐น ๋ก๊ทธ์ธ ์ํ ์์ญ / ๋ก๊ทธ์์ ๋ฒํผ -->
  <div id="super-status" class="hstack" style="justify-content:space-between;align-items:center;margin-bottom:12px">
    <div class="small">๋ก๊ทธ์ธ ์ํ ํ์ธ ์ค...</div>
    <button id="super-logout" class="btn small" style="display:none">SUPER ๋ก๊ทธ์์</button>
  </div>

  <!-- ๐น SUPER ๋ก๊ทธ์ธ ํผ (์ฒ์์๋ ์จ๊ฒผ๋ค๊ฐ, not super๋ฉด ๋ณด์ด๊ฒ) -->
  <div id="super-login-card" class="card vstack" style="display:none;max-width:420px;margin-bottom:16px">
    <h3>SUPER ๋ก๊ทธ์ธ</h3>
    <p class="small">
      ์ด ํ์ด์ง๋ ๋งค์ฅ ๊ด๋ฆฌ์ ๊ณ์๊ณผ ๋งค์ฅ ID(storeId)๋ฅผ ๋งคํํ๋
      <b>์ต์์(SUPER) ๊ด๋ฆฌ ํ์ด์ง</b>์๋๋ค.<br/>
      Vercel ํ๊ฒฝ๋ณ์ <code>SUPER_ADMINS_JSON</code>์ ๋ฑ๋ก๋ ๊ณ์๋ง ๋ก๊ทธ์ธํ ์ ์์ต๋๋ค.
    </p>
    <div class="vstack" style="gap:8px;margin-top:8px">
      <input id="super-id" class="input" placeholder="SUPER ์์ด๋ (์: super)">
      <input id="super-pw" class="input" type="password" placeholder="๋น๋ฐ๋ฒํธ">
      <button id="super-login-btn" class="btn primary">๋ก๊ทธ์ธ</button>
      <div id="super-login-msg" class="small" style="color:#f97316;margin-top:4px"></div>
    </div>
  </div>

  <!-- ๐น ์ค์ ๋งคํ UI (SUPER ๋ก๊ทธ์ธ์ผ ๋๋ง ๋ณด์ด๊ฒ) -->
  <div id="mapping-card" class="card vstack" style="display:none">
    <div class="small">
      ๊ด๋ฆฌ์ ๊ณ์(์์ด๋/์ด๋ฉ์ผ)๊ณผ ๋งค์ฅ ID(storeId)๋ฅผ ์ฐ๊ฒฐํฉ๋๋ค.<br>
      ์ง๊ธ์ ๋ธ๋ผ์ฐ์ ์์ฅ ๊ธฐ์ค์ผ๋ก ๋์ํ๊ณ, ๋์ค์ DB๋ก ์ฎ๊ธธ ๋๋
      <code>['system','storeAdmins']</code> ๊ตฌ์กฐ๋ฅผ ๊ทธ๋๋ก ์ฐ๋ฉด ๋ฉ๋๋ค.
    </div>

    <div class="hstack" style="gap:8px;flex-wrap:wrap;margin-top:10px">
      <input id="map-admin" class="input" placeholder="๊ด๋ฆฌ์ ID (์: owner@narae.com)" style="min-width:260px">
      <input id="map-store" class="input" placeholder="storeId (์: narae)" style="min-width:160px">
      <button id="map-add" class="btn primary">๋งคํ ์ถ๊ฐ/์์</button>
    </div>

    <table class="table" style="margin-top:14px">
      <thead>
      <tr>
        <th>๊ด๋ฆฌ์ ID</th>
        <th>storeId</th>
        <th>๊ด๋ฆฌ์ ์ฝ์</th>
        <th></th>
      </tr>
      </thead>
      <tbody id="map-body">
      <tr><td colspan="4" class="small">๋ฑ๋ก๋ ๋งคํ ์์</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script type="module">
  import { get, patch } from '/src/admin/assets/js/modules/store.js';

  const $ = (s, r=document) => r.querySelector(s);

  // ๐น ๋งคํ์ system ์์ญ์ ์์ฅ (admin ์์ญ๊ณผ ๋ถ๋ฆฌ)
  const PATH = ['system', 'storeAdmins'];

  function loadMap() {
    return get(PATH) || {};
  }
  function saveMap(next) {
    patch(PATH, () => next);
  }

  function renderMapTable() {
    const body = $('#map-body');
    const map = loadMap();

    body.innerHTML = '';

    const entries = Object.entries(map);
    if (!entries.length) {
      body.innerHTML =
        '<tr><td colspan="4" class="small">๋ฑ๋ก๋ ๋งคํ ์์</td></tr>';
      return;
    }

    entries.forEach(([adminId, storeId]) => {
      const tr = document.createElement('tr');
      const adminSafe = adminId.replace(/"/g, '&quot;');
      const storeSafe = storeId.replace(/"/g, '&quot;');

      tr.innerHTML = `
        <td>${adminSafe}</td>
        <td>${storeSafe}</td>
        <td>
          <a class="btn small"
             href="/src/admin/index.html?store=${encodeURIComponent(storeId)}"
             target="_blank">
            ๊ด๋ฆฌ์ ์ฝ์ ์ด๊ธฐ
          </a>
        </td>
        <td class="right">
          <button class="btn small" data-del="${adminSafe}">์ญ์</button>
        </td>
      `;
      body.appendChild(tr);
    });

    body.querySelectorAll('[data-del]').forEach(btn => {
      btn.onclick = () => {
        const id = btn.getAttribute('data-del');
        const map = loadMap();
        delete map[id];
        saveMap(map);
        renderMapTable();
      };
    });
  }

  function bindMappingUI() {
    $('#map-add').onclick = () => {
      const adminId = ($('#map-admin').value || '').trim();
      const storeId = ($('#map-store').value || '').trim();

      if (!adminId || !storeId) {
        alert('๊ด๋ฆฌ์ ID์ storeId๋ฅผ ๋ชจ๋ ์๋ฅํ์ธ์.');
        return;
      }

      const map = loadMap();
      map[adminId] = storeId;
      saveMap(map);
      renderMapTable();
      $('#map-admin').value = '';
      $('#map-store').value = '';
    };
  }

  async function fetchSuperMe() {
    try {
      const r = await fetch('/api/super-me');
      if (!r.ok) return { ok:false, isSuper:false };
      return await r.json();
    } catch (e) {
      console.error('[store-admin] super-me error', e);
      return { ok:false, isSuper:false };
    }
  }

  async function superLogin(id, password) {
    const r = await fetch('/api/super-login', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ id, password }),
    });
    const data = await r.json().catch(() => ({}));
    if (!r.ok || !data.ok) {
      throw new Error(data.error || 'LOGIN_FAILED');
    }
    return data;
  }

  async function superLogout() {
    try {
      await fetch('/api/super-logout', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({}),
      });
    } catch (e) {
      console.error('[store-admin] super-logout error', e);
    }
  }

  async function initPage() {
    const statusBox = $('#super-status');
    const logoutBtn = $('#super-logout');
    const loginCard = $('#super-login-card');
    const mappingCard = $('#mapping-card');
    const loginMsg = $('#super-login-msg');

    // 1) ํ์ฌ SUPER ๋ก๊ทธ์ธ ์ํ ํ์ธ
    const me = await fetchSuperMe();

    if (me.ok && me.isSuper) {
      statusBox.firstElementChild.textContent =
        `SUPER ๋ก๊ทธ์ธ: ${me.superId || ''}`;
      logoutBtn.style.display = 'inline-flex';
      loginCard.style.display = 'none';
      mappingCard.style.display = 'block';

      renderMapTable();
      bindMappingUI();
    } else {
      statusBox.firstElementChild.textContent =
        'SUPER ๋ก๊ทธ์ธ ํ์: ํ๊ฒฝ๋ณ์ SUPER_ADMINS_JSON์ ๋ฑ๋ก๋ ๊ณ์๋ง ์ฌ์ฉ ๊ฐ๋ฅํฉ๋๋ค.';
      logoutBtn.style.display = 'none';
      loginCard.style.display = 'block';
      mappingCard.style.display = 'none';
    }

    // 2) ๋ก๊ทธ์ธ ๋ฒํผ
    $('#super-login-btn').onclick = async () => {
      const id = ($('#super-id').value || '').trim();
      const pw = ($('#super-pw').value || '').trim();

      if (!id || !pw) {
        loginMsg.textContent = '์์ด๋์ ๋น๋ฐ๋ฒํธ๋ฅผ ๋ชจ๋ ์๋ฅํ์ธ์.';
        return;
      }

      loginMsg.textContent = '';
      try {
        await superLogin(id, pw);
        // ๋ก๊ทธ์ธ ์ฑ๊ณต โ ์ํ ๋ค์ ๋ก๋
        const me2 = await fetchSuperMe();
        if (me2.ok && me2.isSuper) {
          statusBox.firstElementChild.textContent =
            `SUPER ๋ก๊ทธ์ธ: ${me2.superId || ''}`;
          logoutBtn.style.display = 'inline-flex';
          loginCard.style.display = 'none';
          mappingCard.style.display = 'block';
          renderMapTable();
          bindMappingUI();
        } else {
          loginMsg.textContent = '๋ก๊ทธ์ธ์ ์คํจํ์ต๋๋ค. (์ธ์ ํ์ธ ์คํจ)';
        }
      } catch (e) {
        console.error('[store-admin] login error', e);
        loginMsg.textContent = '์์ด๋ ๋๋ ๋น๋ฐ๋ฒํธ๊ฐ ์ฌ๋ฐ๋ฅด์ง ์์ต๋๋ค.';
      }
    };

    // 3) ๋ก๊ทธ์์ ๋ฒํผ
    logoutBtn.onclick = async () => {
      await superLogout();
      location.reload();
    };
  }

  initPage();
</script>
</body>
</html>
