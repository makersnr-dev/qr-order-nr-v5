<!doctype html><html lang="ko"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
<title>관리자 로그인</title>  <link rel="stylesheet" href="/src/admin/assets/css/override-white.css"/>
</head><body>
<div class="container">
  <h1>관리자 로그인</h1>
  <div class="card vstack" style="max-width:520px;margin:0 auto">
    <input id="uid" class="input" placeholder="아이디">
    <input id="pwd" class="input" type="password" placeholder="비밀번호">
    <button id="login" class="btn primary">로그인</button>
  </div>
  <div class="small" style="text-align:center;margin-top:10px">
    고객 로그인은 <a href="/order/login">/order/login</a>
  </div>
</div>

<script type="module">
  import { saveToken } from './assets/js/modules/auth.js';
  import { get } from './assets/js/modules/store.js';

  const form = document.getElementById('login-form');
  const msg  = document.getElementById('msg');

  form.onsubmit = async (e) => {
    e.preventDefault();
    msg.textContent = '';

    const formData = new FormData(form);
    const email = String(formData.get('email') || '').trim();
    const pass  = String(formData.get('password') || '').trim();

    if (!email || !pass) {
      msg.textContent = '아이디와 비밀번호를 입력해주세요.';
      return;
    }

    try {
      const res = await fetch('/api/login-admin', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ email, password: pass }),
      });

      const data = await res.json();
      console.log('login-admin result', data);

      if (!res.ok || !data.token) {
        msg.textContent = data?.error || '로그인에 실패했습니다.';
        return;
      }

      // ✅ 토큰 저장
      saveToken(data.token);

      // ✅ 매장 관리자 매핑에서 이 관리자(email)에 연결된 storeId 찾기
      //    (store-admin.js 와 동일하게 'system.storeAdmins' 사용)
      const map = get(['system', 'storeAdmins']) || {};
      const storeId = map[email] || 'store1';

      // ✅ admin 정보 / storeId 를 로컬에 저장
      try {
        localStorage.setItem('qrnr.storeId', storeId);
        localStorage.setItem(
          'qrnr.adminInfo',
          JSON.stringify({ id: email, storeId })
        );
      } catch (e) {
        console.warn('localStorage 저장 실패', e);
      }

      // ✅ 이제 URL의 ?store 파라미터는 쓰지 않고 /admin 으로만 이동
      location.href = '/admin';

    } catch (err) {
      console.error(err);
      msg.textContent = '로그인 중 오류가 발생했습니다.';
    }
  };
</script>

  
</body></html>
