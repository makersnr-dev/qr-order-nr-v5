<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <link rel="stylesheet" href="/src/admin/assets/css/override-white.css"/>
  <title>관리자 로그인</title>
</head>
<body>
<div class="container">
  <h1>관리자 로그인</h1>

  <div class="card vstack" style="max-width:520px;margin:0 auto">
    <input id="uid" class="input" placeholder="아이디">
    <input id="pwd" class="input" type="password" placeholder="비밀번호">
    <button id="login" class="btn primary">로그인</button>
  </div>

  <div class="small" style="text-align:center;margin-top:10px">
    고객 로그인은 <a href="/order/login">/order/login</a>
  </div>
</div>

<script type="module">
  const loginBtn = document.getElementById('login');

  loginBtn.onclick = async () => {
    const uid = document.getElementById('uid').value.trim();
    const pwd = document.getElementById('pwd').value.trim();

    if (!uid || !pwd) {
      alert('아이디와 비밀번호를 입력하세요.');
      return;
    }

    // 1️⃣ 관리자 로그인 (ENV → 쿠키 JWT)
    let res, data;
    try {
      res = await fetch('/api/login-admin', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ id: uid, pw: pwd })
      });

      data = await res.json();

      if (!res.ok || !data.ok) {
        alert('로그인 실패: 아이디 또는 비밀번호가 올바르지 않습니다.');
        return;
      }
    } catch (e) {
      console.error(e);
      alert('서버에 연결할 수 없습니다.');
      return;
    }

    // 2️⃣ 이 관리자가 접근 가능한 매장 조회 (DB 기준)
    try {
      const r = await fetch('/api/stores', {
        credentials: 'include'
      });
      const stores = await r.json();

      if (!r.ok || !Array.isArray(stores) || stores.length === 0) {
        alert(
          '이 관리자 계정은 매장에 매핑되어 있지 않습니다.\n' +
          '슈퍼 관리자에게 문의하세요.'
        );
        return;
      }

      // ✅ 지금은 1개만 있다고 가정
      const store = stores[0];
      location.href = `/admin?store=${encodeURIComponent(store.code)}`;
    } catch (e) {
      console.error(e);
      alert('매장 정보를 불러올 수 없습니다.');
    }
  };
</script>

</body>
</html>
