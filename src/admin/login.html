<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <link rel="stylesheet" href="/src/admin/assets/css/override-white.css"/>
  <title>관리자 로그인</title>
</head>
<body>
<div class="container">
  <h1>관리자 로그인</h1>

  <div class="card vstack" style="max-width:520px;margin:0 auto">
    <input id="uid" class="input" placeholder="아이디">
    <input id="pwd" class="input" type="password" placeholder="비밀번호">
    <button id="login" class="btn primary">로그인</button>
  </div>

  <div class="small" style="text-align:center;margin-top:10px">
    고객 로그인은 <a href="/order/login">/order/login</a>
  </div>
</div>

<script type="module">
  import { get } from '/src/admin/assets/js/modules/store.js';
  import { saveToken } from '/src/admin/assets/js/modules/auth.js';

  const loginBtn = document.getElementById('login');

  loginBtn.onclick = async () => {
    const uid = document.getElementById('uid').value.trim();
    const pwd = document.getElementById('pwd').value.trim();

    if (!uid || !pwd) {
      alert('아이디와 비밀번호를 입력하세요.');
      return;
    }

    // ─────────────────────────────
    // 1) API 로그인 요청
    // ─────────────────────────────
    let data = {};
    let res;
    try {
      res = await fetch('/api/login-admin', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ uid, pwd })
      });
      data = await res.json();
    } catch (e) {
      console.error('login error', e);
      alert('서버에 연결할 수 없습니다.');
      return;
    }

    if (!res.ok || !data.token) {
      alert('로그인 실패: 아이디 또는 비밀번호가 올바르지 않습니다.');
      return;
    }

    // ─────────────────────────────
    // 2) JWT 토큰 저장 (기존 구조 유지)
    // ─────────────────────────────
    saveToken(data.token);

   // ─────────────────────────────
  // 3) 매장 관리자 매핑 확인 (필수)
  // ─────────────────────────────
  const map = get(['admin', 'storeAdmins']) || {};
  const storeId = map[uid];
  
  // ─────────────────────────────
  // 4) 매장 매핑 강제
  // ─────────────────────────────
  if (!storeId) {
    alert(
      '이 관리자 계정은 매장에 매핑되어 있지 않습니다.\n' +
      '관리자 매핑 후 다시 로그인해주세요.'
    );
    return; // ❗ admin 페이지로 보내지 않음
  }
  
  // ✅ storeId가 있을 때만 admin 진입
  location.href = `/admin?store=${encodeURIComponent(storeId)}`;

  };
</script>

</body>
</html>
