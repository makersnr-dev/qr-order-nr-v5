<!doctype html>
<html lang="ko">
<head>
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
<link rel="icon" href="/favicon.ico" type="image/x-icon">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
  <link rel="stylesheet" href="/src/admin/assets/css/override-white.css"/>
  <title>관리자 콘솔</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
<div class="container">
  <div class="hstack" style="align-items: center; gap: 10px;">
    <h1>관리자 콘솔</h1>
    <div id="connection-status" class="hstack" style="gap: 6px; padding: 4px 10px; background: #0b1620; border-radius: 20px; border: 1px solid #263241;">
        <span id="status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #ccc;"></span>
        <span id="status-text" style="font-size: 11px; color: #9fb0c0;">연결 확인 중...</span>
    </div>
  
    <button id="logoutBtn" class="btn">로그아웃</button>
</div>

  <!-- ================= TAB BAR ================= -->
  <div class="tabbar">
    <button class="tab active" data-tab="store">매장</button>
    <button class="tab" data-tab="delivery">예약</button>
    <button class="tab" data-tab="qr-store">매장QR</button>
    <button class="tab" data-tab="qr-deliv">예약QR/지역설정</button>
    <button class="tab" data-tab="menu">메뉴 관리</button>
    <button class="tab" data-tab="code">결제 코드</button>
    <button class="tab" data-tab="mybank">내 계좌정보</button>
    <button class="tab" data-tab="notify-log">호출 알림</button>
    <button class="tab" data-tab="notify">알림 설정</button>
    <button class="tab" data-tab="privacy">개인정보 처리방침</button>
  </div>

 <!-- ================= 매장 주문 ================= -->
<div class="card" data-panel="store">

  <div class="hstack" style="justify-content:space-between;align-items:center;margin-bottom:6px">
    <h3>매장 주문</h3>
    <button id="store-refresh" class="btn small">새로고침</button>
  </div>

 

  <!-- 🖥 PC 전용 -->
  <div class="order-toolbar">

    <!-- 필터 -->
    <div class="hstack" style="gap:6px;flex-wrap:wrap;margin-bottom:10px">
      <input type="date" class="input" id="store-from" style="width:150px">
      <input type="date" class="input" id="store-to"   style="width:150px">
      <select class="input" id="store-status" style="width:140px">
        <option value="">상태 전체</option>
        <option>주문접수</option>
        <option>준비중</option>
        <option>주문완료</option>
        <option>주문취소</option>
        <option>결제취소</option>
      </select>
      <input class="input" id="store-search" placeholder="검색(테이블/메뉴 등)" style="width:200px">
      <button id="store-filter" class="btn">필터</button>
      <button id="store-reset" class="btn">초기화</button>
    </div>

    <button id="store-export" class="btn small" style="margin-bottom:8px">
      엑셀 다운로드
    </button>

    <table class="table">
      <thead>
        <tr>
          <th>일시</th>
          <th>테이블</th>
          <th>내역</th>
          <th>금액</th>
          <th>상태</th>
        </tr>
      </thead>
      <tbody id="tbody-store">
        <tr><td colspan="5" class="small">주문 없음</td></tr>
      </tbody>
    </table>

  </div>
</div>

  
  <!-- ================= 예약 주문 ================= -->
  <div class="card" data-panel="delivery" style="display:none">
    <div class="hstack" style="justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3>예약 주문</h3>
      <button id="deliv-refresh" class="btn small">새로고침</button>
    </div>

    <div class="hstack" style="gap:6px;flex-wrap:wrap;margin-bottom:10px">
      <input type="date" class="input" id="deliv-from" style="width:150px">
      <input type="date" class="input" id="deliv-to"   style="width:150px">
      <select class="input" id="deliv-status" style="width:140px">
        <option value="">상태 전체</option>
        <option>입금 미확인</option>
        <option>주문접수</option>
        <option>준비중</option>
        <option>주문완료</option>
        <option>주문취소</option>
      </select>

      <input class="input" id="deliv-search" placeholder="검색(이름/주소/메뉴 등)" style="width:200px">
      <button id="deliv-filter" class="btn">필터</button>
      <button id="deliv-reset" class="btn">초기화</button>
    </div>

    <button id="deliv-export" class="btn small" style="margin-bottom:8px">엑셀 다운로드</button>

    <table class="table">
      <thead>
        <tr>
          <th>일시</th>
          <th>주문자</th>
          <th>연락처</th>
          <th>주소</th>
          <th>예약일시</th>
          <th>요청사항</th>
          <th>구매내역</th>
          <th>합계금액 / 상태</th>
        </tr>
      </thead>
      <tbody id="tbody-deliv">
        <tr>
          <td colspan="9" class="small">주문 없음</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ================= 매장 QR ================= -->
  <div class="card" data-panel="qr-store" style="display:none">
    <h3>매장 QR</h3>
    <p class="small">
      테이블 번호별 <b>매장 주문용 QR</b>을 생성하고 저장/다운로드할 수 있습니다.<br/>
      QR을 스캔하면 해당 테이블 번호가 자동 입력된 매장 주문 페이지로 이동합니다.
    </p>

    <div class="hstack" style="gap:8px;flex-wrap:wrap;margin-bottom:10px">
      <input id="qr-table" class="input" placeholder="테이블 번호 (예: 1, 2, A1)" style="max-width:140px">
      <input id="qr-label" class="input" placeholder="라벨 (선택)" style="max-width:260px">
      <button id="qr-generate" class="btn primary">QR 생성 & 저장</button>
      <button id="qr-download-all" class="btn">전체 다운로드 (ZIP)</button>
      <button id="qr-clear" class="btn">전체 삭제</button>
    </div>

    <div id="qr-grid" class="grid" style="gap:12px"></div>
  </div>

  <!-- ================= 예약 QR ================= -->
  <div class="card" data-panel="qr-deliv" style="display:none">
  <div class="hstack" style="justify-content:space-between; align-items:center; margin-bottom:20px;">
    <h3 style="margin:0;">예약 QR/지역 설정</h3>
    </div>

  <div style="background:#0b1620; padding:15px; border-radius:12px; border:1px solid var(--border); margin-bottom:30px;">
    <h4 style="margin-top:0; margin-bottom:10px;">예약 주문 QR 생성</h4>
    <p class="small" style="color:var(--muted); margin-bottom:15px;">고객을 예약 주문 페이지로 연결하는 QR 코드를 관리합니다.</p>
    <div class="hstack" style="gap:8px; flex-wrap:wrap; margin-bottom:10px">
      <input id="qr-deliv-label" class="input" placeholder="라벨 (예: 예약 주문)" style="max-width:260px; height:40px;">
      <button id="qr-deliv-generate" class="btn-add-custom" style="height:40px; width:130px;">QR 생성 & 저장</button>
      <button id="qr-deliv-clear" class="btn-del-custom" style="height:40px; width:100px;">전체 삭제</button>
    </div>
    <div id="qr-deliv-grid" class="grid" style="gap:12px"></div>
  </div>

  <div style="border-top:1px solid var(--border); padding-top:25px;">
    <div class="hstack" style="justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h4 style="margin:0;">배달 및 픽업 정책 설정</h4>
      <button id="btn-save-deliv-config" class="btn primary" style="padding:8px 25px; font-weight:bold; font-size:14px;">
        설정 저장
      </button>
    </div>

    <div class="vstack" style="gap:15px; max-width:600px;">
      <div class="hstack" style="gap:20px;">
        <label class="hstack" style="gap:6px; cursor:pointer;"><input type="checkbox" id="deliv-enabled"> 배달 사용</label>
        <label class="hstack" style="gap:6px; cursor:pointer;"><input type="checkbox" id="pickup-enabled"> 매장픽업 사용</label>
      </div>

      <div class="vstack" style="gap:8px;">
        <label class="small" style="color:var(--muted)">매장 기준 주소 (거리 계산용)</label>
        <div class="hstack" style="gap:8px;">
          <input id="deliv-base-addr" class="input" placeholder="주소 검색을 눌러주세요" readonly style="flex:1; height:40px;">
          <button type="button" id="btn-search-base-addr" class="btn-add-custom" style="height:40px; width:100px;">주소 검색</button>
        </div>
      </div>

      <div class="hstack" style="gap:10px; align-items: center;">
        <span class="small">최대 배달 거리</span>
        <input id="deliv-max-dist" type="number" class="input" style="width:80px; height:40px;" placeholder="5">
        <span class="small">km</span>

        <span class="small" style="margin-left:20px;">기본 배달비</span>
        <input id="deliv-base-fee" type="number" class="input" style="width:100px; height:40px;">
        <span class="small">원</span>

        <span class="small" style="margin-left:20px;">km당 추가비</span>
        <input id="deliv-extra-fee" type="number" class="input" style="width:100px; height:40px;">
        <span class="small">원</span>
      </div>
    </div>
    <p class="small" style="color:var(--muted); margin-top:15px;">* 설정 저장 버튼을 눌러야 실제 배달 정책에 반영됩니다.</p>
  </div>
</div>

  <!-- ================= 메뉴 관리 ================= -->
  <div class="card" data-panel="menu" style="display:none">
    <h3>메뉴 관리</h3>

    <div class="hstack" style="gap:8px;flex-wrap:wrap;margin-bottom:10px">
      <input id="m-id" class="input" placeholder="id" style="width:120px">
      <input id="m-name" class="input" placeholder="이름" style="width:220px">
      <input id="m-price" type="number" class="input" placeholder="가격" style="width:160px">
      <input id="m-category" class="input" placeholder="카테고리(선택)" style="width:150px">
      <button id="m-add" class="btn">추가</button>
    </div>

    <div class="hstack" style="gap:8px;flex-wrap:wrap;margin-bottom:14px">
  <input type="file" id="menu-excel" accept=".xlsx" style="display:none">
  <button id="menu-excel-upload" class="btn small">📁 엑셀로 메뉴 불러오기</button>
      <button id="menu-excel-download" class="btn small">💾 현재 메뉴 다운로드</button>
</div>


   <table class="table">
  <thead>
    <tr>
      <th>ID</th>
      <th>이름</th>
      <th>가격</th>
      <th>카테고리</th>
      <th>상태</th>
      <th></th>
    </tr>
  </thead>
  <tbody id="m-body"></tbody>
</table>

  </div>

  <!-- ================= 결제 코드 ================= -->
  <div class="card" data-panel="code" style="display:none">
    <h3>오늘의 결제 코드
      <span id="code-date" class="badge"></span>
      <span id="code-left" class="small"></span>
    </h3>

    <div class="hstack" style="gap:8px">
      <input id="code-input" class="input" style="max-width:160px">
      <button id="code-copy" class="btn">복사</button>
      <button id="code-new" class="btn">새 코드 발급</button>
      <button id="code-reset" class="btn">기본 코드</button>
    </div>
  </div>

  <!-- ================= 내 계좌 정보 ================= -->
  <div class="card" data-panel="mybank" style="display:none">
    <h3>내 계좌정보</h3>

    <div class="hstack" style="gap:12px;flex-wrap:wrap">
      <input id="mb-bank"   class="input" placeholder="은행명" style="max-width:200px">
      <input id="mb-acct"   class="input" placeholder="계좌번호" style="max-width:320px">
      <input id="mb-holder" class="input" placeholder="예금주"   style="max-width:220px">
      <button id="mb-save" class="btn primary">저장</button>
      <button id="mb-copy" class="btn">현재값 복사</button>
    </div>

    <div class="small" style="margin-top:10px">
      현재 저장값: <span id="mb-current">(저장된 정보 없음)</span>
    </div>
  </div>

  <!-- ================= 호출 알림 로그 ================= -->
  <div class="card" data-panel="notify-log" style="display:none">
    <div class="hstack" style="justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3>호출 알림 로그</h3>
      <button id="notify-log-refresh" class="btn small">새로고침</button>
    </div>

    <table class="table">
      <thead>
        <tr>
          <th>일시</th>
          <th>테이블</th>
          <th>내용</th>
          <th>상태</th>
        </tr>
      </thead>
      <tbody id="tbody-notify-logs">
        <tr><td colspan="4" class="small">알림 없음</td></tr>
      </tbody>
    </table>
  </div>
  
<!-- ================= 알림 설정 ================= -->
 <div class="card" data-panel="notify" style="display:none">
    <div class="hstack" style="justify-content:space-between; align-items:center; margin-bottom:30px; padding-bottom:15px; border-bottom:1px solid #263241;">
        <h3 style="margin:0;">알림 설정</h3>
        <button id="n-save" class="btn primary"style="padding:8px 25px; font-weight:bold; font-size:14px;">
        설정 저장
        </button>
    </div>

    <div class="hstack" style="gap:12px; flex-wrap:wrap; background:#0b1620; padding:15px; border-radius:12px; border:1px solid var(--border);">
        <label class="hstack" style="gap:6px">
            <input id="n-beep" type="checkbox"> 새 주문 소리
        </label>
        <label class="hstack" style="gap:6px">
            볼륨
            <input id="n-vol" type="range" min="0" max="1" step="0.05" style="width:120px">
        </label>
        <label class="hstack" style="gap:6px">
            <input id="n-desktop" type="checkbox"> 데스크탑 알림
        </label>
        <input id="n-webhook" class="input" placeholder="Webhook URL (선택)" style="width:300px">
    </div>

    <h4 style="margin-top:40px;">영업 시간 설정</h4>
    <div class="vstack" style="gap:12px; background:#0b1620; padding:20px; border-radius:12px; border:1px solid var(--border);">
        <div class="hstack">
            <label style="font-size:14px;"><input type="checkbox" id="bh-enabled"> 영업시간 제한 사용</label>
        </div>
        <div class="hstack" style="gap:10px;">
            <input type="time" id="bh-start" class="input" style="width:150px;">
            <span style="color:var(--muted)">~</span>
            <input type="time" id="bh-end" class="input" style="width:150px;">
        </div>
        <div class="hstack" id="bh-days" style="gap:10px; flex-wrap:wrap; margin-top:5px;">
            <label class="small"><input type="checkbox" value="1"> 월요일</label>
            <label class="small"><input type="checkbox" value="2"> 화요일</label>
            <label class="small"><input type="checkbox" value="3"> 수요일</label>
            <label class="small"><input type="checkbox" value="4"> 목요일</label>
            <label class="small"><input type="checkbox" value="5"> 금요일</label>
            <label class="small" style="color:#74c0fc;"><input type="checkbox" value="6"> 토요일</label>
            <label class="small" style="color:#ff5c5c;"><input type="checkbox" value="0"> 일요일</label>
        </div>
    </div>

   <div style="margin-top:40px; border-top:1px solid var(--border); padding-top:25px;">
    <h4>수동 예약 차단 설정</h4>
    
    <div class="hstack" style="gap:10px; flex-wrap:wrap; align-items: stretch;">
        <input type="date" id="block-date" class="input" style="width:160px; height:40px;">
        
        <div class="hstack" style="gap:8px; background:#0b1620; padding:0 15px; border-radius:10px; border:1px solid var(--border); height:40px;">
            <input type="time" id="block-time-start" class="input" style="width:130px; border:none; height:100%;" placeholder="시작">
            <span style="color:var(--muted)">~</span>
            <input type="time" id="block-time-end" class="input" style="width:130px; border:none; height:100%;" placeholder="종료">
        </div>
        
        <button type="button" id="btn-add-block" class="btn-add-custom" style="height:40px; width:120px;">차단 추가</button>
    </div>
    
    <p class="small" style="color:var(--muted); margin-top:10px;">* 시간을 입력하지 않으면 해당 날짜 전체가 휴무일로 처리됩니다.</p>
    
    <div id="disabled-list" class="vstack" style="gap:10px; margin-top:15px;"></div>
</div>

    <div style="margin-top:40px; border-top:1px solid var(--border); padding-top:25px; margin-bottom:20px;">
        <h4>직원 호출 항목 관리</h4>
        <div id="call-options-box" style="max-width:500px;"></div>
    </div>
</div>

  <!-- ================= 개인정보 처리방침 ================= -->
  <div class="card" data-panel="privacy" style="display:none">
    <h3>개인정보 처리방침</h3>

    <p class="small" style="margin-bottom:8px">
      이 내용은 예약 주문 페이지의<br/>
      <b>「개인정보 처리방침 보기」 모달</b>에 그대로 표시됩니다.
    </p>

    <textarea id="privacy-text" class="input" style="width:100%;min-height:260px;white-space:pre-wrap"></textarea>

    <div class="hstack" style="gap:8px;margin-top:8px">
      <button id="privacy-save"  class="btn primary">저장</button>
      <button id="privacy-reset" class="btn small" type="button">기본 예시 불러오기</button>
    </div>
  </div>
</div>

<!-- 주문 상세 모달 -->
<div id="order-modal" class="modal">
  <div class="content">
    <h3>주문 상세</h3>
    <div id="modal-body" class="small" style="white-space:pre-wrap"></div>
    <button id="modal-close" class="btn" style="margin-top:10px">닫기</button>
  </div>
</div>

<!-- =========================
     결제 완료 확인 모달 (POS)
========================= -->
<div id="pay-confirm-modal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.45);
  align-items:center;
  justify-content:center;
  z-index:10000;
">
  <div style="
    background:#0d1117;
    color:#fff;
    padding:24px;
    border-radius:16px;
    min-width:280px;
  ">
    <h3>결제 완료</h3>

    <div style="margin:12px 0">
      결제 완료 처리 하시겠습니까?
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="pay-cancel" class="btn">취소</button>
      <button id="pay-confirm" class="btn primary">확인</button>
    </div>
  </div>
</div>


<!--     취소사유모달                -->  
<div id="cancel-reason-modal" class="modal" style="display:none">
  <div class="content cancel-reason-box">
    <h3>취소 사유</h3>

    <textarea
      id="cancel-reason-input"
      placeholder="취소 사유를 입력하세요"
      style="width:100%;height:80px"
    ></textarea>

    <div class="modal-actions">
      <button id="cancel-reason-close">취소</button>
      <button id="cancel-reason-confirm" class="danger">확인</button>
    </div>
  </div>
</div>

  
<!-- QR Code 라이브러리 -->
<script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<!-- Excel(xlsx) 라이브러리 -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<!-- 카카오 지도 API -->
<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=8f77cc9534f6b22c04d6754c0ba2dd25&libraries=services"></script>

<!-- ================= storeId 안정화 핵심 코드 ================= -->
<script type="module">
  import { ensureStoreInitialized } from '/src/shared/store.js';

  const storeId = ensureStoreInitialized();
  window.qrnrStoreId = storeId;
  document.body.dataset.storeId = storeId;

  const url = new URL(location.href);
  if (!url.searchParams.get('store')) {
    url.searchParams.set('store', storeId);
    history.replaceState(null, '', url.toString());
  }
</script>

<!-- 관리자 메인 스크립트 -->
<script type="module" src="/src/admin/assets/js/admin.js"></script>
<!-- 주문 상세 모달 -->
<div id="order-detail-modal" class="modal" style="display:none">
  <div class="content" style="max-width:420px">
    <h3>주문 상세</h3>
    <pre id="order-detail-body"
         class="small"
         style="white-space:pre-wrap;line-height:1.5"></pre>
    <button id="order-detail-close"
            class="btn"
            style="margin-top:12px">닫기</button>
  </div>
</div>

</body>
</html>
