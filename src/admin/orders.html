<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="stylesheet" href="/src/admin/assets/css/style.css"/>
<title>주문 목록(임시 저장 /tmp)</title>
<style>
  body{color:#fff;background:#0f0f10}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #333;padding:8px}
  .toolbar{display:flex;gap:8px;margin:10px 0}
  .btn{padding:6px 10px;border:1px solid #444;border-radius:8px;background:#1d1d1f;color:#fff;cursor:pointer}
  select,input{background:#111;color:#fff;border:1px solid #333;border-radius:6px;padding:6px 8px}
</style>
</head>
<body>

<div class="container">
  <h1>주문 목록(임시 저장 /tmp)</h1>

  <div class="small" id="store-label" style="margin-bottom:8px;color:#bbb"></div>

  <div class="toolbar">
    <select id="type">
      <option value="">전체</option>
      <option value="store">매장</option>
      <option value="delivery">배달</option>
      <option value="reserve">예약</option>
    </select>
    <input id="from" type="date">
    <input id="to" type="date">
    <button id="refresh" class="btn">새로고침</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>시간</th>
        <th>ID</th>
        <th>유형</th>
        <th>금액</th>
        <th>상태</th>
        <th>내역</th>
        <th>고객</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script type="module">
  import { ensureStoreInitialized } from '/src/shared/store.js';
  const storeId = ensureStoreInitialized();
  window.qrnrStoreId = storeId;

  document.getElementById('store-label').textContent =
    `현재 매장: ${storeId}`;

  // ----------------------------
  // 주문 fetch
  // ----------------------------
  async function fetchOrders() {
    const p = new URLSearchParams();

    // storeId 반드시 포함
    p.set('store', storeId);

    const type = document.getElementById('type').value;
    if (type) p.set('type', type);

    const f = document.getElementById('from').value;
    if (f) p.set('from', f);

    const t = document.getElementById('to').value;
    if (t) p.set('to', t);

    const r = await fetch('/api/orders?' + p.toString());
    const j = await r.json().catch(() => ({}));

    return j.orders || [];
  }

  // ----------------------------
  // Row Builder
  // ----------------------------
  function row(o) {
    const items = (o.cart || [])
      .map(i => `${i.name} x${i.qty}`)
      .join(', ');

    const cust = o.customer
      ? `${o.customer.name || ''} ${o.customer.phone || ''}`.trim()
      : '';

    const ts = o.ts
      ? new Date(o.ts).toLocaleString()
      : '-';

    return `
      <tr>
        <td>${ts}</td>
        <td>${o.orderId || o.id || '-'}</td>
        <td>${o.type || '-'}</td>
        <td>${(o.amount || 0).toLocaleString()}원</td>
        <td>${o.status || '-'}</td>
        <td>${items}</td>
        <td>${cust}</td>
      </tr>
    `;
  }

  // ----------------------------
  // Render
  // ----------------------------
  async function render() {
    const list = await fetchOrders();
    if (!list.length) {
      document.getElementById('tbody').innerHTML =
        `<tr><td colspan="7" style="text-align:center;color:#777">데이터 없음</td></tr>`;
      return;
    }
    document.getElementById('tbody').innerHTML = list.map(row).join('');
  }

  document.getElementById('refresh').onclick = render;
  render();
</script>

</body>
</html>
